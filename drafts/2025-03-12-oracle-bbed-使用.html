<h2 id="前言">前言</h2>

<p>BBED 是 Oracle 提供的一个用于修改数据块的工具，可以用于修改数据块的内容，比如修改数据块中的数据，修改数据块的头部信息等。BBED 是一个很强大的工具，但是使用 BBED 也是有风险的，因为 BBED 可以直接修改数据块的内容，如果不小心修改了数据块的内容，可能会导致数据库的损坏。因此，在使用 BBED 之前，一定要慎重考虑，最好在测试环境中使用 BBED。</p>

<p>记录一下使用 BBED 的一些常用命令</p>

<h2 id="查看帮助">查看帮助</h2>

<p>bbed 的 help 命令使用方法和 impdp 类似，可以通过 help=yes 参数查看所有的参数</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>┌─[✗]─[oracle@oracle11g]─[~]
└──╼ <span class="nv">$ </span>bbed <span class="nb">help</span><span class="o">=</span><span class="nb">yes
</span>PASSWORD - Required parameter
FILENAME - Database file name
BLOCKSIZE - Database block size
LISTFILE - List file name
MODE - <span class="o">[</span>browse/edit]
SPOOL - Spool to logfile <span class="o">[</span>no/yes]
CMDFILE - BBED <span class="nb">command </span>file name
LOGFILE - BBED log file name
PARFILE - Parameter file name
BIFILE - BBED before-image file name
REVERT - Rollback changes from BIFILE <span class="o">[</span>no/yes]
SILENT - Hide banner <span class="o">[</span>no/yes]
HELP - Show all valid parameters <span class="o">[</span>no/yes]

</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="设置-bbed-参数文件">设置 bbed 参数文件</h2>

<p><strong>可以通过设置 bbed 的参数文件，避免每次输入参数</strong></p>

<p><del>如果调试同一个 block 可以直接将 set 参数的选项写入参数文件中，通过测试并不能直接在参数文件中设置 set 参数</del></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre>vim ~/.bash_profile

<span class="nb">alias </span><span class="nv">bbed</span><span class="o">=</span><span class="s1">'rlwrap  /u01/app/oracle/product/11.2.0/db/rdbms/lib/bbed parfile=/home/oracle/bbed.par password=blockedit'</span>

┌─[oracle@oracle11g]─[~]
└──╼ <span class="nv">$ </span><span class="nb">cat </span>bbed.par
<span class="nv">blocksize</span><span class="o">=</span>8192
<span class="nv">listfile</span><span class="o">=</span>/home/oracle/filelist.bbed

<span class="c">## filelist 的内容</span>
WXJ@darkdb 2269,15367 SQL&gt; <span class="k">select </span>file#||chr<span class="o">(</span>9<span class="o">)||</span>name||chr<span class="o">(</span>9<span class="o">)||</span>bytes from v<span class="nv">$datafile</span><span class="p">;</span>

FILE#||CHR<span class="o">(</span>9<span class="o">)||</span>NAME||CHR<span class="o">(</span>9<span class="o">)||</span>BYTES
<span class="nt">----------------------------------------------------------------------------------------------------</span>
1       /oradata/darkdb/system01.dbf    817889280
2       /oradata/darkdb/sysaux01.dbf    576716800
3       /oradata/darkdb/undotbs01.dbf   519045120
4       /oradata/darkdb/users01.dbf     5242880
5       /oradata/darkdb/data01.dbf      1073741824


┌─[oracle@oracle11g]─[~]
└──╼ <span class="nv">$ </span><span class="nb">cat </span>filelist.bbed
1       /oradata/darkdb/system01.dbf    817889280
2       /oradata/darkdb/sysaux01.dbf    576716800
3       /oradata/darkdb/undotbs01.dbf   519045120
4       /oradata/darkdb/users01.dbf     5242880
5       /oradata/darkdb/data01.dbf      1073741824


</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="创建测试表">创建测试表</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>
<span class="k">create</span> <span class="n">tablespace</span> <span class="k">data</span> <span class="n">datafile</span> <span class="s1">'/oradata/darkdb/data01.dbf'</span> <span class="k">size</span> <span class="mi">1</span><span class="k">G</span> <span class="n">autoextend</span> <span class="k">off</span><span class="p">;</span>
<span class="k">alter</span> <span class="k">user</span> <span class="n">wxj</span> <span class="k">default</span> <span class="n">tablespace</span> <span class="k">data</span><span class="p">;</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">t1</span> <span class="p">(</span> <span class="n">c1</span> <span class="n">number</span><span class="p">,</span> <span class="n">c2</span> <span class="n">varchar2</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">t1</span> <span class="k">values</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'hello'</span> <span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">t1</span> <span class="k">values</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'world'</span> <span class="p">);</span>
<span class="k">commit</span><span class="p">;</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="n">C1</span> <span class="o">|</span> <span class="n">C2</span>
<span class="c1">----------</span>
<span class="mi">1</span>  <span class="o">|</span> <span class="n">hello</span>
<span class="mi">2</span>  <span class="o">|</span> <span class="n">world</span>

<span class="k">select</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_relative_fno</span><span class="p">(</span><span class="n">rowid</span><span class="p">),</span><span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_block_number</span><span class="p">(</span><span class="n">rowid</span><span class="p">),</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="n">DBMS_ROWID</span><span class="p">.</span><span class="n">ROWID_RELATIVE_FNO</span><span class="p">(</span><span class="n">ROWID</span><span class="p">)</span> <span class="o">|</span> <span class="n">DBMS_ROWID</span><span class="p">.</span><span class="n">ROWID_BLOCK_NUMBER</span><span class="p">(</span><span class="n">ROWID</span><span class="p">)</span> <span class="o">|</span> <span class="n">C1</span> <span class="o">|</span> <span class="n">C2</span>
<span class="c1">----------------------------------------------------------------------------------------</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">132</span>                                  <span class="o">|</span> <span class="mi">3</span>  <span class="o">|</span> <span class="n">hello</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">132</span>                                  <span class="o">|</span> <span class="mi">4</span>  <span class="o">|</span> <span class="n">world</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">135</span>                                  <span class="o">|</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">hello</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">135</span>                                  <span class="o">|</span> <span class="mi">2</span>  <span class="o">|</span> <span class="n">world</span>

<span class="c1">-- dump block</span>
<span class="k">alter</span> <span class="k">system</span> <span class="n">dump</span> <span class="n">datafile</span> <span class="mi">5</span> <span class="n">block</span> <span class="mi">135</span><span class="p">;</span>
<span class="c1">--</span>
<span class="c1">--</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">t1</span> <span class="k">values</span> <span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'hello'</span> <span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">t1</span> <span class="k">values</span> <span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">'world'</span> <span class="p">);</span>
<span class="k">commit</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="常用命令">常用命令</h2>

<h3 id="1-查看数据块的内容">1. 查看数据块的内容</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>BBED&gt; map
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="2-查看数据块的头部信息">2. 查看数据块的头部信息</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>BBED&gt; h
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="listfile">listfile</h2>

<p>bbed 必须要设置一个 listfile 文件，这个文件随便创建一个空文件即可，没有特别的实际含义，只是为了让 bbed 能够正常工作，如果不设置 listfile 文件，bbed 会报错，无法通过 set 设置环境变量。这个文件只要是 Oracle 用户有读写权限的文件即可，不需要特别的权限</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
BBED&gt; <span class="nb">set </span>FILE 5
BBED-00312: no LISTFILE specified
</pre></td></tr></tbody></table></code></pre></div></div>

<p>当然设置了 listfile 文件之后，bbed 也会报错，但是这个错误是正常的，不影响 bbed 的使用</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="rouge-code"><pre>┌─[oracle@oracle11g]─[~]
└──╼ <span class="nv">$ </span><span class="nb">touch </span>filelist.bbed
┌─[oracle@oracle11g]─[~]
└──╼ <span class="nv">$ </span><span class="nb">readlink</span> <span class="nt">-f</span> filelist.bbed
/home/oracle/filelist.bbed

BBED&gt; <span class="nb">set </span>listfile <span class="s1">'/home/oracle/filelist.bbed'</span>
BBED-00300: unable to translate filename <span class="c">## 这个报错可以忽略</span>

BBED&gt; <span class="nb">set </span>filename <span class="s1">'/oradata/darkdb/data01.dbf'</span>
        FILENAME        /oradata/darkdb/data01.dbf

BBED&gt; <span class="nb">set </span>file 5
        FILE#           5

BBED&gt; <span class="nb">set </span>block 135
        BLOCK#          135

BBED&gt; show all
        FILE#           5
        BLOCK#          135
        OFFSET          0
        DBA             0x01400087 <span class="o">(</span>20971655 5,135<span class="o">)</span> <span class="c">## DBA 是由 Oracle 分配的十六进制块地址，5 是文件号，135 是块号，20971655 是十进制块地址，如果熟悉的话可以直接设置 DBA ，这样的话就不需要设置 FILE 和 BLOCK</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192 <span class="c">## 数据块大小 根据数据库的块大小设置</span>
        MODE            Browse <span class="c">## 设置 bbed 的模式，Browse 是只读模式，Edit 是可编辑模式</span>
        EDIT            Unrecoverable <span class="c">## 设置编辑模式，Unrecoverable 是不可恢复的，Recoverable 是可恢复的</span>
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           512 <span class="c">## 一次显示的字节数</span>
        LOGFILE         log.bbd
        SPOOL           No

BBED&gt; dump <span class="c">## 需要注意的是 Oracle 数据是从下往上存储的，所以 dump 出来的数据是从下往上的 ，顶端是数据块的头部信息/元信息 ，底部是数据块的数据</span>
BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 135              Offsets:    0 to 8191           Dba:0x01400087
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 87004001 371f1f00 00000106 e5fa0000 01000000 6b760100 341f1f00
 00000000 02003200 80004001 08000900 9c0b0000 1eefc000 be003300 02200000
 371f1f00 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00010200 ffff1600 801f6a1f 6a1f0000 02008c1f 801f0000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
....
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 2c010202 c1030577 6f726c64 2c010202 c1020568 656c6c6f 0106371f

 &lt;32 bytes per line&gt;
<span class="nt">--</span>
<span class="nt">--</span> 查看 block 的内容
<span class="k">select  </span>dump<span class="o">(</span> c1, 16 <span class="o">)</span>,c1, dump<span class="o">(</span> c2, 16 <span class="o">)</span>, c2 from t1<span class="p">;</span>
DUMP<span class="o">(</span>C1,16<span class="o">)</span>       | C1 | DUMP<span class="o">(</span>C2,16<span class="o">)</span>                 | C2
<span class="nt">------------------------------------------------------------</span>
<span class="nv">Typ</span><span class="o">=</span>2 <span class="nv">Len</span><span class="o">=</span>2: c1,4 | 3  | <span class="nv">Typ</span><span class="o">=</span>1 <span class="nv">Len</span><span class="o">=</span>5: 68,65,6c,6c,6f | hello
<span class="nv">Typ</span><span class="o">=</span>2 <span class="nv">Len</span><span class="o">=</span>2: c1,5 | 4  | <span class="nv">Typ</span><span class="o">=</span>1 <span class="nv">Len</span><span class="o">=</span>5: 77,6f,72,6c,64 | world
<span class="nv">Typ</span><span class="o">=</span>2 <span class="nv">Len</span><span class="o">=</span>2: c1,2 | 1  | <span class="nv">Typ</span><span class="o">=</span>1 <span class="nv">Len</span><span class="o">=</span>5: 68,65,6c,6c,6f | hello
<span class="nv">Typ</span><span class="o">=</span>2 <span class="nv">Len</span><span class="o">=</span>2: c1,3 | 2  | <span class="nv">Typ</span><span class="o">=</span>1 <span class="nv">Len</span><span class="o">=</span>5: 77,6f,72,6c,64 | world

</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>BBED&gt; listfile
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="blok">blok</h2>

<p>相同的 session 插入的数据，会在同一个块中，如果是不同的 session 插入的数据，会在不同的块中</p>

<p>字符串没有大小端的问题，但是数字有大小端的问题，所以在 dump 数据的时候，需要注意数据的大小端问题</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre>
<span class="k">create</span> <span class="n">tablespace</span> <span class="k">data</span> <span class="n">datafile</span> <span class="s1">'/oradata/darkdb/data01.dbf'</span> <span class="k">size</span> <span class="mi">1</span><span class="k">G</span> <span class="n">autoextend</span> <span class="k">off</span><span class="p">;</span>
<span class="k">alter</span> <span class="k">user</span> <span class="n">wxj</span> <span class="k">default</span> <span class="n">tablespace</span> <span class="k">data</span><span class="p">;</span>

<span class="c1">-- session 1</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">t1</span> <span class="p">(</span> <span class="n">c1</span> <span class="n">number</span><span class="p">,</span> <span class="n">c2</span> <span class="n">varchar2</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">t1</span> <span class="k">values</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">'hello'</span> <span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">t1</span> <span class="k">values</span> <span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'world'</span> <span class="p">);</span>
<span class="k">commit</span><span class="p">;</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="n">C1</span> <span class="o">|</span> <span class="n">C2</span>
<span class="c1">----------</span>
<span class="mi">1</span>  <span class="o">|</span> <span class="n">hello</span>
<span class="mi">2</span>  <span class="o">|</span> <span class="n">world</span>

<span class="c1">-- session 2</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">t1</span> <span class="k">values</span> <span class="p">(</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'hello'</span> <span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">t1</span> <span class="k">values</span> <span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">'world'</span> <span class="p">);</span>
<span class="k">commit</span><span class="p">;</span>

<span class="c1">-- 查看数据块</span>

<span class="k">select</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_relative_fno</span><span class="p">(</span><span class="n">rowid</span><span class="p">),</span><span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_block_number</span><span class="p">(</span><span class="n">rowid</span><span class="p">),</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="n">DBMS_ROWID</span><span class="p">.</span><span class="n">ROWID_RELATIVE_FNO</span><span class="p">(</span><span class="n">ROWID</span><span class="p">)</span> <span class="o">|</span> <span class="n">DBMS_ROWID</span><span class="p">.</span><span class="n">ROWID_BLOCK_NUMBER</span><span class="p">(</span><span class="n">ROWID</span><span class="p">)</span> <span class="o">|</span> <span class="n">C1</span> <span class="o">|</span> <span class="n">C2</span>
<span class="c1">----------------------------------------------------------------------------------------</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">132</span>                                  <span class="o">|</span> <span class="mi">3</span>  <span class="o">|</span> <span class="n">hello</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">132</span>                                  <span class="o">|</span> <span class="mi">4</span>  <span class="o">|</span> <span class="n">world</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">135</span>                                  <span class="o">|</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">hello</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">135</span>                                  <span class="o">|</span> <span class="mi">2</span>  <span class="o">|</span> <span class="n">world</span>

<span class="c1">-- dump block</span>
<span class="k">alter</span> <span class="k">system</span> <span class="n">dump</span> <span class="n">datafile</span> <span class="mi">5</span> <span class="n">block</span> <span class="mi">135</span><span class="p">;</span>

<span class="c1">-- 查看 block 的内容</span>
<span class="k">select</span>  <span class="n">dump</span><span class="p">(</span> <span class="n">c1</span><span class="p">,</span> <span class="mi">16</span> <span class="p">),</span><span class="n">c1</span><span class="p">,</span> <span class="n">dump</span><span class="p">(</span> <span class="n">c2</span><span class="p">,</span> <span class="mi">16</span> <span class="p">),</span> <span class="n">c2</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="n">DUMP</span><span class="p">(</span><span class="n">C1</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>       <span class="o">|</span> <span class="n">C1</span> <span class="o">|</span> <span class="n">DUMP</span><span class="p">(</span><span class="n">C2</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>                 <span class="o">|</span> <span class="n">C2</span>
<span class="c1">------------------------------------------------------------</span>
<span class="n">Typ</span><span class="o">=</span><span class="mi">2</span> <span class="n">Len</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span><span class="mi">4</span> <span class="o">|</span> <span class="mi">3</span>  <span class="o">|</span> <span class="n">Typ</span><span class="o">=</span><span class="mi">1</span> <span class="n">Len</span><span class="o">=</span><span class="mi">5</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">6</span><span class="k">c</span><span class="p">,</span><span class="mi">6</span><span class="k">c</span><span class="p">,</span><span class="mi">6</span><span class="n">f</span> <span class="o">|</span> <span class="n">hello</span>
<span class="n">Typ</span><span class="o">=</span><span class="mi">2</span> <span class="n">Len</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span><span class="mi">5</span> <span class="o">|</span> <span class="mi">4</span>  <span class="o">|</span> <span class="n">Typ</span><span class="o">=</span><span class="mi">1</span> <span class="n">Len</span><span class="o">=</span><span class="mi">5</span><span class="p">:</span> <span class="mi">77</span><span class="p">,</span><span class="mi">6</span><span class="n">f</span><span class="p">,</span><span class="mi">72</span><span class="p">,</span><span class="mi">6</span><span class="k">c</span><span class="p">,</span><span class="mi">64</span> <span class="o">|</span> <span class="n">world</span>
<span class="n">Typ</span><span class="o">=</span><span class="mi">2</span> <span class="n">Len</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span><span class="mi">2</span> <span class="o">|</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">Typ</span><span class="o">=</span><span class="mi">1</span> <span class="n">Len</span><span class="o">=</span><span class="mi">5</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">6</span><span class="k">c</span><span class="p">,</span><span class="mi">6</span><span class="k">c</span><span class="p">,</span><span class="mi">6</span><span class="n">f</span> <span class="o">|</span> <span class="n">hello</span>
<span class="n">Typ</span><span class="o">=</span><span class="mi">2</span> <span class="n">Len</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span><span class="mi">3</span> <span class="o">|</span> <span class="mi">2</span>  <span class="o">|</span> <span class="n">Typ</span><span class="o">=</span><span class="mi">1</span> <span class="n">Len</span><span class="o">=</span><span class="mi">5</span><span class="p">:</span> <span class="mi">77</span><span class="p">,</span><span class="mi">6</span><span class="n">f</span><span class="p">,</span><span class="mi">72</span><span class="p">,</span><span class="mi">6</span><span class="k">c</span><span class="p">,</span><span class="mi">64</span> <span class="o">|</span> <span class="n">world</span>

<span class="c1">--</span>

<span class="o">&gt;</span> <span class="k">set</span> <span class="n">block</span> <span class="mi">135</span> <span class="o">##</span> <span class="err">设置</span> <span class="n">block</span> <span class="err">，每设置一次</span> <span class="n">block</span><span class="err">，就会重新读取数据块的内容</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="修改表的数据长度发生变化rowid-不变">修改表的数据（长度发生变化，rowid 不变）</h3>

<p>只有在 blok 写满的情况下 rowid 才会发生变化，或者行迁移的时候 rowid 也会发生变化</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>
<span class="k">select </span>rowid, c1, c2 from t1<span class="p">;</span>
ROWID              | C1 | C2
<span class="nt">-------------------------------</span>
AAAXZrAAFAAAACEAAA | 3  | hello
AAAXZrAAFAAAACEAAB | 4  | world
AAAXZrAAFAAAACHAAA | 1  | hello
AAAXZrAAFAAAACHAAB | 2  | world

<span class="nt">--</span> 修改数据
update t1 <span class="nb">set </span>c2 <span class="o">=</span> <span class="s1">'hello world'</span> where c1 <span class="o">=</span> 3<span class="p">;</span>
commit<span class="p">;</span>

<span class="k">select </span>rowid, c1, c2 from t1<span class="p">;</span>
ROWID              | C1 | C2
<span class="nt">-------------------------------------</span>
AAAXZrAAFAAAACEAAA | 3  | hello world <span class="nt">--</span> 长度发生变化，rowid 不变
AAAXZrAAFAAAACEAAB | 4  | world
AAAXZrAAFAAAACHAAA | 1  | hello
AAAXZrAAFAAAACHAAB | 2  | world
</pre></td></tr></tbody></table></code></pre></div></div>

<p>update 修改的数据长度发生变化，rowid 不变，这是因为 rowid 是由数据块的地址和数据行号组成的，数据行号是数据块中的偏移量，数据块中的数据发生变化，数据行号不变，rowid 也不会变化，但是数据块中的数据发生变化，数据行号发生变化，rowid 也会发生变化。</p>

<p><img src="https://darkstaronline.work/blog_images/piclist/piclist-clipboard-images/25/03/14/02-27-16-821d515a45b574c04f561a29fb7c13ad-20250314022716106.png" alt="rowid 组成" /></p>

<h3 id="rowid-的组成">rowid 的组成</h3>

<ul>
  <li>数据对象号 oid</li>
  <li>数据文件号 fno</li>
  <li>数据块号 block</li>
  <li>数据行号 rowid</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">select </span>dbms_rowid.rowid_object<span class="o">(</span>rowid<span class="o">)</span> oid, dbms_rowid.rowid_relative_fno<span class="o">(</span>rowid<span class="o">)</span> fno, dbms_rowid.rowid_block_number<span class="o">(</span>rowid<span class="o">)</span> blockid, dbms_rowid.rowid_row_number<span class="o">(</span>rowid<span class="o">)</span> rownumber, c1, c2 from t1<span class="p">;</span>
OID   | FNO | BLOCKID | ROWNUMBER | C1 | C2
<span class="nt">----------------------------------------------------</span>
95851 | 5   | 132     | 0         | 3  | hello world
95851 | 5   | 132     | 1         | 4  | world
95851 | 5   | 135     | 0         | 1  | hello
95851 | 5   | 135     | 1         | 2  | world

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="dump-block">dump block</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="rouge-code"><pre>BBED&gt; <span class="nb">set </span>listfile <span class="s1">'/home/oracle/filelist.bbed'</span>
BBED-00300: unable to translate filename


BBED&gt; <span class="nb">set </span>filename <span class="s1">'/oradata/darkdb/data01.dbf'</span>
        FILENAME        /oradata/darkdb/data01.dbf

BBED&gt; <span class="nb">set </span>file 5
        FILE#           5

BBED&gt; show all
        FILE#           5
        BLOCK#          1
        OFFSET          0
        DBA             0x01400001 <span class="o">(</span>20971521 5,1<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Browse
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           512
        LOGFILE         log.bbd
        SPOOL           No

BBED&gt; <span class="nb">set </span>count 8192
        COUNT           8192set block 135<span class="p">;</span>

BBED&gt; <span class="nb">set </span>block 135
        BLOCK#          135
BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 135              Offsets:    0 to 8191           Dba:0x01400087
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 87004001 371f1f00 00000106 e5fa0000 01000000 6b760100 341f1f00
 00000000 02003200 80004001 08000900 9c0b0000 1eefc000 be003300 02200000
 371f1f00 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00010200 ffff1600 801f6a1f 6a1f0000 02008c1f 801f0000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
.......
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 2c010202 c1030577 6f726c64 2c010202 c1020568 656c6c6f 0106371f <span class="nt">--</span> 最初的 dump 信息 00000000 2c010202 c1030577 6f726c64 2c010202 c1020568 656c6c6f 0106371f 可以看出信息没有发生变化

 &lt;32 bytes per line&gt;


<span class="nt">--</span> 重新读取数据块的内容
BBED&gt; <span class="nb">set </span>block 135
        BLOCK#          135
BBED&gt; dump

00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
00000000 2c010202 c1030577 6f726c64 2c010202 c1020568 656c6c6f 0106371f <span class="nt">--</span> 重新读取快的内容，也没有发生变化，这是因为 Oracle 变更的数据实在内存中的，没有写入到磁盘中，所以数据块的内容没有发生变化

 &lt;32 bytes per line&gt;
</pre></td></tr></tbody></table></code></pre></div></div>
<p>此时的旧的数据块就是脏块，需要等待一段时间，Oracle 通过 dbwr 会将脏块写入到磁盘中，这个时间一般是 3 秒， 或者手动刷新数据块</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>alter system flush buffer_cache<span class="p">;</span>

<span class="nt">--</span> 也可以执行 checkpoint
alter system checkpoint<span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>此时在 dump 数据块，就会发现数据块的内容发生了变化</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nb">set </span>block 135<span class="p">;</span>
dump

00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
00000000 2c010202 c1030577 6f726c64 2c010202 c1020568 656c6c6f 0106371f <span class="nt">--</span> 还是没有发生变化，是因为设置的 block 错误了😂 ，应该设置的是 132
&lt;32 bytes per line&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>dump 正确的 block</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nb">set </span>block 132<span class="p">;</span>
dump
</pre></td></tr></tbody></table></code></pre></div></div>

<p>还是直接修改 block 135 对应的内容吧</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_relative_fno</span><span class="p">(</span><span class="n">rowid</span><span class="p">),</span><span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_block_number</span><span class="p">(</span><span class="n">rowid</span><span class="p">),</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="n">DBMS_ROWID</span><span class="p">.</span><span class="n">ROWID_RELATIVE_FNO</span><span class="p">(</span><span class="n">ROWID</span><span class="p">)</span> <span class="o">|</span> <span class="n">DBMS_ROWID</span><span class="p">.</span><span class="n">ROWID_BLOCK_NUMBER</span><span class="p">(</span><span class="n">ROWID</span><span class="p">)</span> <span class="o">|</span> <span class="n">C1</span> <span class="o">|</span> <span class="n">C2</span>
<span class="c1">----------------------------------------------------------------------------------------------</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">132</span>                                  <span class="o">|</span> <span class="mi">3</span>  <span class="o">|</span> <span class="n">hello</span> <span class="n">world</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">132</span>                                  <span class="o">|</span> <span class="mi">4</span>  <span class="o">|</span> <span class="n">world</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">135</span>                                  <span class="o">|</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">hello</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">135</span>                                  <span class="o">|</span> <span class="mi">2</span>  <span class="o">|</span> <span class="n">world</span>


<span class="k">select</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_object</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">oid</span><span class="p">,</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_relative_fno</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">fno</span><span class="p">,</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_block_number</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">blockid</span><span class="p">,</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_row_number</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">rownumber</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="n">OID</span>   <span class="o">|</span> <span class="n">FNO</span> <span class="o">|</span> <span class="n">BLOCKID</span> <span class="o">|</span> <span class="n">ROWNUMBER</span> <span class="o">|</span> <span class="n">C1</span> <span class="o">|</span> <span class="n">C2</span>
<span class="c1">----------------------------------------------------</span>
<span class="mi">95851</span> <span class="o">|</span> <span class="mi">5</span>   <span class="o">|</span> <span class="mi">132</span>     <span class="o">|</span> <span class="mi">0</span>         <span class="o">|</span> <span class="mi">3</span>  <span class="o">|</span> <span class="n">hello</span> <span class="n">world</span>
<span class="mi">95851</span> <span class="o">|</span> <span class="mi">5</span>   <span class="o">|</span> <span class="mi">132</span>     <span class="o">|</span> <span class="mi">1</span>         <span class="o">|</span> <span class="mi">4</span>  <span class="o">|</span> <span class="n">world</span>
<span class="mi">95851</span> <span class="o">|</span> <span class="mi">5</span>   <span class="o">|</span> <span class="mi">135</span>     <span class="o">|</span> <span class="mi">0</span>         <span class="o">|</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">hello</span>
<span class="mi">95851</span> <span class="o">|</span> <span class="mi">5</span>   <span class="o">|</span> <span class="mi">135</span>     <span class="o">|</span> <span class="mi">1</span>         <span class="o">|</span> <span class="mi">2</span>  <span class="o">|</span> <span class="n">world</span>

<span class="k">update</span> <span class="n">t1</span> <span class="k">set</span> <span class="n">c2</span> <span class="o">=</span> <span class="s1">'hello world'</span> <span class="k">where</span> <span class="n">c1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">commit</span><span class="p">;</span>

<span class="k">select</span> <span class="n">rowid</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="n">ROWID</span>              <span class="o">|</span> <span class="n">C1</span> <span class="o">|</span> <span class="n">C2</span>
<span class="c1">-------------------------------------</span>
<span class="n">AAAXZrAAFAAAACEAAA</span> <span class="o">|</span> <span class="mi">3</span>  <span class="o">|</span> <span class="n">hello</span> <span class="n">world</span>
<span class="n">AAAXZrAAFAAAACEAAB</span> <span class="o">|</span> <span class="mi">4</span>  <span class="o">|</span> <span class="n">world</span>
<span class="n">AAAXZrAAFAAAACHAAA</span> <span class="o">|</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">hello</span> <span class="n">world</span> <span class="c1">-- 可以看出 rowid 没有发生变化</span>
<span class="n">AAAXZrAAFAAAACHAAB</span> <span class="o">|</span> <span class="mi">2</span>  <span class="o">|</span> <span class="n">world</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>刷新数据块，重新 dump 数据块</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="nb">set </span>block 135<span class="p">;</span>
dump

00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
00000000 2c010202 c1030577 6f726c64 2c010202 c1020568 656c6c6f 0106371f

&lt;32 bytes per line&gt;

<span class="nt">--</span> 刷脏之后再次 dump
<span class="nt">--alter</span> system flush buffer_cache<span class="p">;</span>
<span class="nt">--</span> 一般还是 checkpoint 比较好，flush buffer_cache 会将内存中的其他内容也写入到磁盘中，checkpoint 只会将脏块写入到磁盘中，影响较小
alter system checkpoint<span class="p">;</span>

<span class="nb">set </span>block 135<span class="p">;</span>
dump

00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
00000000 00000000 00000000 00000000 00000000 2c000202 c1020b68 656c6c6f
20776f72 6c642c00 0202c102 0568656c 6c6f2c02 0202c102 0b68656c 6c6f2077
6f726c64 <span class="o">[</span>2c000202] <span class="c">## 从这里开始已经发生变化 [c1030577 6f726c64 2c000202 c1020568 656c6c6f] 【0206594a 这个并不是数据】 ## 这部分没有发生变化，但是 Oracle 不会在使用这部分数据，因为已经没有指针指向这部分数据。这部分数据会被 Oracle 标记为 free block，等待下次使用。Oracle 不会主动清除磁盘上的数据，因为这也会消耗 CPU 和 IO 资源，Oracle 会等待下次使用这部分数据的时候再清除/覆盖这部分数据</span>

&lt;32 bytes per line&gt;

<span class="k">select </span>dump<span class="o">(</span> c2, 16 <span class="o">)</span> from t1 where c1 <span class="o">=</span> 1<span class="p">;</span>
DUMP<span class="o">(</span>C2,16<span class="o">)</span>
<span class="nt">----------------------------------------------</span>
<span class="nv">Typ</span><span class="o">=</span>1 <span class="nv">Len</span><span class="o">=</span>11: 68,65,6c,6c,6f,20,77,6f,72,6c,64

<span class="k">select </span>dump<span class="o">(</span> <span class="s1">'hello'</span>, 16 <span class="o">)</span> from dual<span class="p">;</span>
DUMP<span class="o">(</span><span class="s1">'HELLO'</span>,16<span class="o">)</span>
<span class="nt">----------------------------</span>
<span class="nv">Typ</span><span class="o">=</span>96 <span class="nv">Len</span><span class="o">=</span>5: 68,65,6c,6c,6f
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="闪回影响">闪回影响</h3>

<p>如果没有打开闪回的话，Oracle 写数据的方法是回绕的方式，一直从下网上写，直到元数据的下方（数据文件被写满），然后从尾部开始搜索空闲块。</p>

<p>如果打开了闪回，Oracle 会在数据块的头部写入闪回信息，这个信息是一个指针，指向上一个数据块，这样 Oracle 就可以通过这个指针找到上一个数据块，然后通过上一个数据块的闪回信息找到上上一个数据块，以此类推，直到找到一个没有闪回信息的数据块，这个数据块就是 Oracle 写入数据的起始数据块。这个时候会立马从上往下找寻可用的数据块，不会使用回绕的方式写入数据。</p>

<p>这个也是可以理解的，如果还是使用回绕的方式写入数据，那么在数据文件被写满的时候，Oracle 会从头开始搜索空闲块，这个时间会很长，会影响数据库的性能，所以 Oracle 会在数据块的头部写入闪回信息，这样 Oracle 就可以快速找到可用的数据块，提高数据库的性能。</p>

<h2 id="find-查找数据块">find 查找数据块</h2>

<p>可以通过 bbed 的 find 命令查找数据块，find 命令可以查找数据块中的指定内容，可以查找数据块中的数据，也可以查找数据块中的元数据，可以查找数据块中的任意内容</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>BBED&gt; <span class="nb">help </span>find
FIND[/x|d|u|o|c] numeric/character string <span class="o">[</span> TOP | CURR <span class="o">]</span>
<span class="c">## /x 是十六进制，/d 是十进制，/u 是 无符号十进制，/o 是八进制，/c 是字符</span>

BBED&gt; find /c hello <span class="c">## 可以直接查找字符 hello ，但是最好结合 offset，否则会查找整个数据块/文件，offset=0 是从数据块的头部开始查找</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>需要注意的是，使用 find 命令之后，offset 会自动设置到查找到的位置，所以在使用 find 命令之后，需要重新设置 offset</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre>BBED&gt;
BBED&gt; show all
        FILE#           5
        BLOCK#          135
        OFFSET          0
        DBA             0x01400087 <span class="o">(</span>20971655 5,135<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Browse
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           8192
        LOGFILE         log.bbd
        SPOOL           NoBBED&gt;
BBED&gt; find /c hello
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 135              Offsets: 8123 to 8191 <span class="c">## 在偏移量的 8123-8191 之间找到了 hello           Dba:0x01400087</span>
<span class="nt">------------------------------------------------------------------------</span>
 Block: 135              Offsets: 8123 to 8191           Dba:0x01400087
<span class="nt">------------------------------------------------------------------------</span>
 68656c6c 6f20776f 726c642c 000202c1 02056865 6c6c6f2c 020202c1 020b6865
 6c6c6f20 776f726c 642c0002 02c10305 776f726c 642c0002 02c10205 68656c6c
 6f020659 4a

 &lt;32 bytes per line&gt;

BBED&gt; show all
        FILE#           5
        BLOCK#          135
        OFFSET          8123 <span class="c">## offset 会自动设置到查找到的位置</span>
        DBA             0x01400087 <span class="o">(</span>20971655 5,135<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Browse
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           8192
        LOGFILE         log.bbd
        SPOOL           No

BBED&gt;
BBED&gt; <span class="nb">set </span>offset 0
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>还需要注意的是，<code class="language-plaintext highlighter-rouge">find /x</code> 命令在 32 位系统上只能查找 4 个字节（每个字节 8 位）的内容，64 位系统上只能查找 8 个字节的内容，否则会提示 BBED-00209 错误</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre>BBED&gt; <span class="nb">set </span>offset 0
        OFFSET          0

BBED&gt; find /x 68656c6c
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 135              Offsets: 8123 to 8191           Dba:0x01400087
<span class="nt">------------------------------------------------------------------------</span>
 68656c6c 6f20776f 726c642c 000202c1 02056865 6c6c6f2c 020202c1 020b6865
 6c6c6f20 776f726c 642c0002 02c10305 776f726c 642c0002 02c10205 68656c6c
 6f020659 4a

 &lt;32 bytes per line&gt;

BBED&gt; <span class="nb">set </span>offset 0
        OFFSET          0

BBED&gt; find /x 414141141414141414141414141
BBED-00209: invalid number <span class="o">(</span>414141141414141414141414141<span class="o">)</span>


BBED&gt; show all
        FILE#           5
        BLOCK#          135
        OFFSET          0
        DBA             0x01400087 <span class="o">(</span>20971655 5,135<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Browse
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           8192
        LOGFILE         log.bbd
        SPOOL           No

BBED&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="modify-修改数据块">modify 修改数据块</h2>

<p>可以通过 bbed 的 modify 命令修改数据块中的内容，可以修改数据块中的数据，也可以修改数据块中的元数据，可以修改数据块中的任意内容</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>BBED&gt; <span class="nb">help </span>modify
MODIFY[/x|d|u|o|c] numeric/character string
      <span class="o">[</span> DBA | FILE | FILENAME | BLOCK | OFFSET | symbol | <span class="k">*</span>symbol <span class="o">]</span> <span class="c">## 可以通过 DBA，FILE，FILENAME，BLOCK，OFFSET，symbol，*symbol 来设置需要修改的数据的位置，offset 默认是从当前位置开始修改</span>

<span class="c">## 通过字符串直接修改数据内容最简单，也可以结合 select dump( c2, 16 ) from t1 where c1 = 1; 来查看数据的十六进制内容，然后直接修改数据的十六进制内容</span>
<span class="c">## BBED&gt; modify /c hello world</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>为了方便测试观察，新插入一条数据</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre><span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">4150</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="n">col</span> <span class="n">c2</span> <span class="n">format</span> <span class="n">a15</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">4150</span> <span class="k">SQL</span><span class="o">&gt;</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">4150</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>

        <span class="n">C1</span> <span class="n">C2</span>
<span class="c1">---------- ---------------</span>
         <span class="mi">3</span> <span class="n">hello</span> <span class="n">world</span>
         <span class="mi">4</span> <span class="n">world</span>
         <span class="mi">1</span> <span class="n">hello</span> <span class="n">world</span>
         <span class="mi">2</span> <span class="n">world</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">4150</span> <span class="k">SQL</span><span class="o">&gt;</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">t1</span> <span class="k">values</span> <span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'test'</span> <span class="p">);</span>
<span class="k">commit</span><span class="p">;</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">4150</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">t1</span> <span class="k">values</span> <span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'test'</span> <span class="p">);</span>

<span class="mi">1</span> <span class="k">row</span> <span class="n">created</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">01</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">4150</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">commit</span><span class="p">;</span>

<span class="k">Commit</span> <span class="n">complete</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">01</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">4150</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>

        <span class="n">C1</span> <span class="n">C2</span>
<span class="c1">---------- ---------------</span>
         <span class="mi">3</span> <span class="n">hello</span> <span class="n">world</span>
         <span class="mi">4</span> <span class="n">world</span>
         <span class="mi">5</span> <span class="n">test</span>
         <span class="mi">1</span> <span class="n">hello</span> <span class="n">world</span>
         <span class="mi">2</span> <span class="n">world</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>

<span class="k">select</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_relative_fno</span><span class="p">(</span><span class="n">rowid</span><span class="p">),</span><span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_block_number</span><span class="p">(</span><span class="n">rowid</span><span class="p">),</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="n">DBMS_ROWID</span><span class="p">.</span><span class="n">ROWID_RELATIVE_FNO</span><span class="p">(</span><span class="n">ROWID</span><span class="p">)</span> <span class="o">|</span> <span class="n">DBMS_ROWID</span><span class="p">.</span><span class="n">ROWID_BLOCK_NUMBER</span><span class="p">(</span><span class="n">ROWID</span><span class="p">)</span> <span class="o">|</span> <span class="n">C1</span> <span class="o">|</span> <span class="n">C2</span>         
<span class="c1">----------------------------------------------------------------------------------------------</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">132</span>                                  <span class="o">|</span> <span class="mi">3</span>  <span class="o">|</span> <span class="n">hello</span> <span class="n">world</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">132</span>                                  <span class="o">|</span> <span class="mi">4</span>  <span class="o">|</span> <span class="n">world</span>      
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">133</span>                                  <span class="o">|</span> <span class="mi">5</span>  <span class="o">|</span> <span class="n">test</span>       
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">135</span>                                  <span class="o">|</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">hello</span> <span class="n">world</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">135</span>                                  <span class="o">|</span> <span class="mi">2</span>  <span class="o">|</span> <span class="n">world</span>      

<span class="k">select</span> <span class="n">dump</span><span class="p">(</span> <span class="n">c1</span><span class="p">,</span> <span class="mi">16</span> <span class="p">),</span><span class="n">dump</span><span class="p">(</span> <span class="n">c2</span><span class="p">,</span> <span class="mi">16</span> <span class="p">)</span> <span class="k">from</span> <span class="n">t1</span> <span class="k">where</span> <span class="n">c1</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">DUMP</span><span class="p">(</span><span class="n">C1</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>       <span class="o">|</span> <span class="n">DUMP</span><span class="p">(</span><span class="n">C2</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>             
<span class="c1">--------------------------------------------</span>
<span class="n">Typ</span><span class="o">=</span><span class="mi">2</span> <span class="n">Len</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span><span class="mi">6</span> <span class="o">|</span> <span class="n">Typ</span><span class="o">=</span><span class="mi">1</span> <span class="n">Len</span><span class="o">=</span><span class="mi">4</span><span class="p">:</span> <span class="mi">74</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mi">74</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>修改数据块中的数据</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
</pre></td><td class="rouge-code"><pre>BBED&gt; <span class="nb">set </span>block 133
        BLOCK#          133


BBED&gt; <span class="nb">set </span>block 133
        BLOCK#          133

BBED&gt; show all
        FILE#           5
        BLOCK#          133
        OFFSET          0
        DBA             0x01400085 <span class="o">(</span>20971653 5,133<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Browse
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           8192
        LOGFILE         log.bbd
        SPOOL           No

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 133              Offsets:    0 to 8191           Dba:0x01400085
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 85004001 341f1f00 00000204 05290000 01000000 6b760100 341f1f00
 00000000 02003200 80004001 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000

 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 0206341f

 &lt;32 bytes per line&gt;

<span class="c">## 可以看到这里还是没有变化，因为 Oracle 的数据是在内存中/或者现在还是脏块的，没有写入到磁盘中/刷脏，所以数据块的内容没有发生变化。所以需要刷新数据块</span>

WXJ@darkdb 2280,4150 SQL&gt; alter system checkpoint
  2  <span class="p">;</span>

System altered.

Elapsed: 00:00:00.07

<span class="c">## WXJ@darkdb 2280,4150 SQL&gt; alter system flush buffer_cache; -- 或者直接刷新 buffer_cache</span>

<span class="c">## 刷脏之后一定要再次 set block 133，重新 dump 数据块，否则数据块的内容不会发生变化</span>

BBED&gt; <span class="nb">set </span>block 133
        BLOCK#          133

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 133              Offsets:    0 to 8191           Dba:0x01400085
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 85004001 e85d2000 00000206 d94c0000 01000000 6b760100 341f1f00
 00000000 02003200 80004001 01001b00 af0b0000 1bf5c000 d1001500 01200000
 e85d2000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00010100 ffff1400 8d1f791f 791f0000 01008d1f 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
...
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 002c0102 02c10604 74657374 0206e85d

 &lt;32 bytes per line&gt;

BBED&gt; find /c <span class="nb">test
 </span>File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 133              Offsets: 8184 to 8191           Dba:0x01400085
<span class="nt">------------------------------------------------------------------------</span>
 74657374 0206e85d

 &lt;32 bytes per line&gt;

BBED&gt; show all
        FILE#           5
        BLOCK#          133
        OFFSET          8184 <span class="c">## offset 会自动设置到查找到的位置</span>
        DBA             0x01400085 <span class="o">(</span>20971653 5,133<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Browse
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           8192
        LOGFILE         log.bbd
        SPOOL           No

BBED&gt;
BBED&gt; modify /c testnew <span class="c">## 记得修改 MODE 为 EDIT，否则会报错 BBED-00215: editing not allowed in BROWSE mode</span>
BBED-00215: editing not allowed <span class="k">in </span>BROWSE mode

BBED&gt; <span class="nb">set </span>mode edit
        MODE            Edit

BBED&gt; show all
        FILE#           5
        BLOCK#          133
        OFFSET          8184
        DBA             0x01400085 <span class="o">(</span>20971653 5,133<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Edit
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           8192
        LOGFILE         log.bbd
        SPOOL           No

<span class="c">## 这里不需要指定 offset，因为 offset 已经设置到查找到的位置了</span>
BBED&gt; modify /c testnew
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 133              Offsets: 8184 to 8191           Dba:0x01400085
<span class="nt">------------------------------------------------------------------------</span>
 74657374 6e65775d

 &lt;32 bytes per line&gt;

</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>修改成功之后查看表的数据是否发生变化</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">4150</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>

        <span class="n">C1</span> <span class="n">C2</span>
<span class="c1">---------- ---------------</span>
         <span class="mi">3</span> <span class="n">hello</span> <span class="n">world</span>
         <span class="mi">4</span> <span class="n">world</span>
         <span class="mi">5</span> <span class="n">test</span>
         <span class="mi">1</span> <span class="n">hello</span> <span class="n">world</span>
         <span class="mi">2</span> <span class="n">world</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">4150</span> <span class="k">SQL</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>此时还没发生变化，因为Oracle会先将数据读取到内存中，此时查询 t1 的数据是从内存中读取的，所以数据还是没有发生变化，需要等待一段时间，Oracle 会将内存中的数据写入到磁盘中，这个时间一般是 3 秒，或者手动刷新数据块</strong></p>

<p>这里也可以看出 checkpoint 和 flush buffer_cache 的区别，checkpoint 只会将脏块写入到磁盘中，flush buffer_cache 会将内存中的所有数据写入到磁盘中，所以 checkpoint 的性能更好，checkpoint 也不会查看到数据文件已经发生了修改</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">4150</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">alter</span> <span class="k">system</span> <span class="k">checkpoint</span><span class="p">;</span>

<span class="k">System</span> <span class="n">altered</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">09</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">4150</span> <span class="k">SQL</span><span class="o">&gt;</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">4150</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>

        <span class="n">C1</span> <span class="n">C2</span>
<span class="c1">---------- ---------------</span>
         <span class="mi">3</span> <span class="n">hello</span> <span class="n">world</span>
         <span class="mi">4</span> <span class="n">world</span>
         <span class="mi">5</span> <span class="n">test</span>
         <span class="mi">1</span> <span class="n">hello</span> <span class="n">world</span>
         <span class="mi">2</span> <span class="n">world</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">4150</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">alter</span> <span class="k">system</span> <span class="n">flush</span> <span class="n">buffer_cache</span><span class="p">;</span>

<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">15367</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="n">ERROR</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01578</span><span class="p">:</span> <span class="n">ORACLE</span> <span class="k">data</span> <span class="n">block</span> <span class="n">corrupted</span> <span class="p">(</span><span class="n">file</span> <span class="o">#</span> <span class="mi">5</span><span class="p">,</span> <span class="n">block</span> <span class="o">#</span> <span class="mi">133</span><span class="p">)</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01110</span><span class="p">:</span> <span class="k">data</span> <span class="n">file</span> <span class="mi">5</span><span class="p">:</span> <span class="s1">'/oradata/darkdb/data01.dbf'</span>



<span class="k">no</span> <span class="k">rows</span> <span class="n">selected</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">03</span><span class="p">.</span><span class="mi">55</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>关闭校验和参数（db_block_checksum）默认true，尝试查看表数据</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="k">alter</span> <span class="k">system</span> <span class="k">set</span> <span class="n">db_block_checksum</span> <span class="o">=</span> <span class="k">false</span> <span class="k">scope</span> <span class="o">=</span> <span class="n">spfile</span><span class="p">;</span>


<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">15367</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">alter</span> <span class="k">system</span> <span class="k">set</span> <span class="n">db_block_checksum</span> <span class="o">=</span> <span class="k">false</span> <span class="k">scope</span> <span class="o">=</span> <span class="n">spfile</span><span class="p">;</span>

<span class="k">System</span> <span class="n">altered</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">02</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">15367</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="n">ERROR</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01578</span><span class="p">:</span> <span class="n">ORACLE</span> <span class="k">data</span> <span class="n">block</span> <span class="n">corrupted</span> <span class="p">(</span><span class="n">file</span> <span class="o">#</span> <span class="mi">5</span><span class="p">,</span> <span class="n">block</span> <span class="o">#</span> <span class="mi">133</span><span class="p">)</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01110</span><span class="p">:</span> <span class="k">data</span> <span class="n">file</span> <span class="mi">5</span><span class="p">:</span> <span class="s1">'/oradata/darkdb/data01.dbf'</span>



<span class="k">no</span> <span class="k">rows</span> <span class="n">selected</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">45</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">15367</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">alter</span> <span class="k">system</span> <span class="n">flush</span> <span class="n">buffer_cache</span><span class="p">;</span>

<span class="k">System</span> <span class="n">altered</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">03</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">15367</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="n">ERROR</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01578</span><span class="p">:</span> <span class="n">ORACLE</span> <span class="k">data</span> <span class="n">block</span> <span class="n">corrupted</span> <span class="p">(</span><span class="n">file</span> <span class="o">#</span> <span class="mi">5</span><span class="p">,</span> <span class="n">block</span> <span class="o">#</span> <span class="mi">133</span><span class="p">)</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01110</span><span class="p">:</span> <span class="k">data</span> <span class="n">file</span> <span class="mi">5</span><span class="p">:</span> <span class="s1">'/oradata/darkdb/data01.dbf'</span>



<span class="k">no</span> <span class="k">rows</span> <span class="n">selected</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="bbed-sum-查看修改校验和">bbed sum 查看/修改校验和</h3>

<p>因为实验没有做完的时候重启了实例，所以修改参数 db_block_checksum 之后也无法正常查看数据，可以通过 bbed 的 sum 选项重新计算校验和</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c1">-- 在此之前记得修改参数 db_block_checksum 为 true</span>
<span class="k">alter</span> <span class="k">system</span> <span class="k">set</span> <span class="n">db_block_checksum</span> <span class="o">=</span> <span class="k">true</span> <span class="k">scope</span> <span class="o">=</span> <span class="n">spfile</span><span class="p">;</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>查看校验和</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
</pre></td><td class="rouge-code"><pre><span class="c">## sum 默认是查看当前 block 的校验和，默认支持查看，需要搭配选项 apply 修改校验和</span>

BBED&gt; <span class="nb">help sum
</span>SUM <span class="o">[</span> DBA | FILE | FILENAME | BLOCK <span class="o">]</span> <span class="o">[</span> APPLY <span class="o">]</span>


BBED&gt; <span class="nb">set </span>filename <span class="s1">'/oradata/darkdb/data01.dbf'</span>
        FILENAME        /oradata/darkdb/data01.dbf

BBED&gt; <span class="nb">set </span>file 5
        FILE#           5

BBED&gt; <span class="nb">set </span>block 133
        BLOCK#          133

BBED&gt; show all
        FILE#           5
        BLOCK#          133
        OFFSET          0
        DBA             0x01400085 <span class="o">(</span>20971653 5,133<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Browse
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           512
        LOGFILE         log.bbd
        SPOOL           No
BBED&gt; <span class="nb">sum
</span>Check value <span class="k">for </span>File 5, Block 133:
current <span class="o">=</span> 0x4cd9, required <span class="o">=</span> 0x2f2a <span class="c">## 可以看到当前的校验和和需要的校验和不一致，当前的校验和是 0x4cd9，需要的校验和是 0x2f2a</span>

BBED&gt;

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 133              Offsets:    0 to  511           Dba:0x01400085
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 85004001 e85d2000 00000206 【d94c0000】这里的校验和是新的值 01000000 6b760100 341f1f00
 00000000 02003200 80004001 01001b00 af0b0000 1bf5c000 d1001500 01200000
 e85d2000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00010100 ffff1400 8d1f791f 791f0000 01008d1f 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000

 &lt;32 bytes per line&gt;

BBED&gt;

<span class="c">## 更新校验和</span>
BBED&gt; <span class="nb">sum </span>apply
BBED-00215: editing not allowed <span class="k">in </span>BROWSE mode


BBED&gt; <span class="nb">set </span>mode edit
        MODE            Edit

BBED&gt; <span class="nb">sum </span>apply
Warning: contents of previous BIFILE will be lost. Proceed? <span class="o">(</span>Y/N<span class="o">)</span> y
Check value <span class="k">for </span>File 5, Block 133:
current <span class="o">=</span> 0x2f2a, required <span class="o">=</span> 0x2f2a

BBED&gt;

<span class="c">## 发现还是不能查看数据，检查上文的修改步骤，发现字段长度也变化了😂之前是 test 修改为了 textnew ，所以这里无法直接查看数据，大意了 🤣</span>
WXJ@darkdb 2280,21677 SQL&gt; <span class="k">select</span> <span class="k">*</span> from t1<span class="p">;</span>
ERROR:
ORA-01578: ORACLE data block corrupted <span class="o">(</span>file <span class="c"># 5, block # 133)</span>
ORA-01110: data file 5: <span class="s1">'/oradata/darkdb/data01.dbf'</span>



no rows selected

Elapsed: 00:00:00.41
WXJ@darkdb 2280,21677 SQL&gt; alter system flush buffer_cache<span class="p">;</span>

System altered.

Elapsed: 00:00:00.06
WXJ@darkdb 2280,21677 SQL&gt; <span class="k">select</span> <span class="k">*</span> from t1<span class="p">;</span>
ERROR:
ORA-01578: ORACLE data block corrupted <span class="o">(</span>file <span class="c"># 5, block # 133)</span>
ORA-01110: data file 5: <span class="s1">'/oradata/darkdb/data01.dbf'</span>



no rows selected

Elapsed: 00:00:00.36
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>直接删除表重新测试</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">21677</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">drop</span> <span class="k">table</span> <span class="n">t1</span><span class="p">;</span>
<span class="k">Table</span> <span class="n">dropped</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">13</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>这里也可以发现，直接删除表并没有报错，对于坏块来说，只要没有访问到坏块，Oracle 是不会报错的，只有访问到坏块的时候才会报错，这也是 Oracle 的一个优点，对于坏块的容忍度很高，不会因为一个坏块就导致整个数据库无法使用</p>

<p>根据前文重新创建测试表，然后修改数据块中的数据</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">21677</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">table</span> <span class="n">t1</span> <span class="p">(</span> <span class="n">c1</span> <span class="n">number</span><span class="p">,</span> <span class="n">c2</span> <span class="n">varchar2</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="p">);</span>

<span class="k">Table</span> <span class="n">created</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">05</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">21677</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">t1</span> <span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">'test'</span><span class="p">);</span>

<span class="mi">1</span> <span class="k">row</span> <span class="n">created</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">01</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">21677</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">t1</span> <span class="k">values</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">'test2'</span><span class="p">);</span>

<span class="mi">1</span> <span class="k">row</span> <span class="n">created</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">21677</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">commit</span><span class="p">;</span>

<span class="k">Commit</span> <span class="n">complete</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">01</span>


</pre></td></tr></tbody></table></code></pre></div></div>

<p>查看数据所在的 block</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre> <span class="k">select</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_relative_fno</span><span class="p">(</span><span class="n">rowid</span><span class="p">),</span><span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_block_number</span><span class="p">(</span><span class="n">rowid</span><span class="p">),</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="n">DBMS_ROWID</span><span class="p">.</span><span class="n">ROWID_RELATIVE_FNO</span><span class="p">(</span><span class="n">ROWID</span><span class="p">)</span> <span class="o">|</span> <span class="n">DBMS_ROWID</span><span class="p">.</span><span class="n">ROWID_BLOCK_NUMBER</span><span class="p">(</span><span class="n">ROWID</span><span class="p">)</span> <span class="o">|</span> <span class="n">C1</span> <span class="o">|</span> <span class="n">C2</span>   
<span class="c1">----------------------------------------------------------------------------------------</span>
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">141</span>                                  <span class="o">|</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">test</span> 
<span class="mi">5</span>                                    <span class="o">|</span> <span class="mi">141</span>                                  <span class="o">|</span> <span class="mi">2</span>  <span class="o">|</span> <span class="n">test2</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>bbed 修改对应块中的数据，保持长度一致</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
</pre></td><td class="rouge-code"><pre>BBED&gt; show all
        FILE#           5
        BLOCK#          133
        OFFSET          8184
        DBA             0x01400085 <span class="o">(</span>20971653 5,133<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Edit
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           8192
        LOGFILE         log.bbd
        SPOOL           No


BBED&gt; <span class="nb">set </span>block 141
        BLOCK#          141

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 141              Offsets:    0 to 8191           Dba:0x0140008d
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 8d004001 3ad12000 00000106 4a160000 01000000 2f770100 36d12000
 00000000 02003200 88004001 08002100 8d0b0000 bb08c000 cd003d00 02200000
 3ad12000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00010200 ffff1600 811f6b1f 6b1f0000 02008d1f 811f0000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 002c0102 02c10305 74657374 322c0102 02c10204 74657374 01063ad1

 &lt;32 bytes per line&gt;

<span class="k">select </span>dump<span class="o">(</span> c1, 16 <span class="o">)</span>,dump<span class="o">(</span> c2, 16 <span class="o">)</span>, c1, c2 from t1 <span class="p">;</span>
DUMP<span class="o">(</span>C1,16<span class="o">)</span>       | DUMP<span class="o">(</span>C2,16<span class="o">)</span>                 | C1 | C2   
<span class="nt">------------------------------------------------------------</span>
<span class="nv">Typ</span><span class="o">=</span>2 <span class="nv">Len</span><span class="o">=</span>2: c1,2 | <span class="nv">Typ</span><span class="o">=</span>1 <span class="nv">Len</span><span class="o">=</span>4: 74,65,73,74    | 1  | <span class="nb">test 
</span><span class="nv">Typ</span><span class="o">=</span>2 <span class="nv">Len</span><span class="o">=</span>2: c1,3 | <span class="nv">Typ</span><span class="o">=</span>1 <span class="nv">Len</span><span class="o">=</span>5: 74,65,73,74,32 | 2  | test2

BBED&gt; find /c <span class="nb">test
 </span>File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 141              Offsets: 8172 to 8191           Dba:0x0140008d
<span class="nt">------------------------------------------------------------------------</span>
 74657374 322c0102 02c10204 74657374 01063ad1

 &lt;32 bytes per line&gt;

BBED&gt; show all
        FILE#           5
        BLOCK#          141
        OFFSET          8172
        DBA             0x0140008d <span class="o">(</span>20971661 5,141<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Edit
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           8192
        LOGFILE         log.bbd
        SPOOL           No

BBED&gt; modify /c demo
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 141              Offsets: 8172 to 8191           Dba:0x0140008d
<span class="nt">------------------------------------------------------------------------</span>
 64656d6f 322c0102 02c10204 74657374 01063ad1 <span class="c">## 通过这里也可以看出，如果存在两个一样的字符，修改的时候只会修改第一次匹配出现的字符</span>


 &lt;32 bytes per line&gt;

<span class="c">## 刷新 cache，查看数据</span>

alter system flush buffer_cache<span class="p">;</span>
alter system <span class="nb">set </span>db_block_checksum <span class="o">=</span> <span class="nb">false </span>scope <span class="o">=</span> spfile<span class="p">;</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>这里测试发现不管是在另一个 session 修改参数，还是刷新 cache 都无法正常查看数据，都会提示存在坏块，当前 session，新的session还是刷新cache之后重新再次连接的session都无法查看数据，但是看吕海波的ocm课程中可以在修改block check参数为false然后刷新cache之后可以正常查看数据，我测试环境为11g，可能版本不同导致</strong></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">21677</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span>
<span class="o">*</span>
<span class="n">ERROR</span> <span class="k">at</span> <span class="n">line</span> <span class="mi">1</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01578</span><span class="p">:</span> <span class="n">ORACLE</span> <span class="k">data</span> <span class="n">block</span> <span class="n">corrupted</span> <span class="p">(</span><span class="n">file</span> <span class="o">#</span> <span class="mi">5</span><span class="p">,</span> <span class="n">block</span> <span class="o">#</span> <span class="mi">141</span><span class="p">)</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01110</span><span class="p">:</span> <span class="k">data</span> <span class="n">file</span> <span class="mi">5</span><span class="p">:</span> <span class="s1">'/oradata/darkdb/data01.dbf'</span>


<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">03</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">21677</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span>
<span class="o">*</span>
<span class="n">ERROR</span> <span class="k">at</span> <span class="n">line</span> <span class="mi">1</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01578</span><span class="p">:</span> <span class="n">ORACLE</span> <span class="k">data</span> <span class="n">block</span> <span class="n">corrupted</span> <span class="p">(</span><span class="n">file</span> <span class="o">#</span> <span class="mi">5</span><span class="p">,</span> <span class="n">block</span> <span class="o">#</span> <span class="mi">141</span><span class="p">)</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01110</span><span class="p">:</span> <span class="k">data</span> <span class="n">file</span> <span class="mi">5</span><span class="p">:</span> <span class="s1">'/oradata/darkdb/data01.dbf'</span>


<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">03</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">21677</span> <span class="k">SQL</span><span class="o">&gt;</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">21677</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span>
<span class="o">*</span>
<span class="n">ERROR</span> <span class="k">at</span> <span class="n">line</span> <span class="mi">1</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01578</span><span class="p">:</span> <span class="n">ORACLE</span> <span class="k">data</span> <span class="n">block</span> <span class="n">corrupted</span> <span class="p">(</span><span class="n">file</span> <span class="o">#</span> <span class="mi">5</span><span class="p">,</span> <span class="n">block</span> <span class="o">#</span> <span class="mi">141</span><span class="p">)</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01110</span><span class="p">:</span> <span class="k">data</span> <span class="n">file</span> <span class="mi">5</span><span class="p">:</span> <span class="s1">'/oradata/darkdb/data01.dbf'</span>


<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">03</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2280</span><span class="p">,</span><span class="mi">21677</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">alter</span> <span class="k">system</span> <span class="n">flush</span> <span class="n">buffer_cache</span><span class="p">;</span>

<span class="k">System</span> <span class="n">altered</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">01</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>通过 bbed sum 修改校验和之后能够正常查看数据</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>
BBED&gt; <span class="nb">set </span>block 141
        BLOCK#          141

BBED&gt; <span class="nb">sum
</span>Check value <span class="k">for </span>File 5, Block 141:
current <span class="o">=</span> 0x164a, required <span class="o">=</span> 0x0d44

BBED&gt; <span class="nb">sum </span>apply
Check value <span class="k">for </span>File 5, Block 141:
current <span class="o">=</span> 0x0d44, required <span class="o">=</span> 0x0d44

WXJ@darkdb 2280,21677 SQL&gt; alter system <span class="nb">set </span>db_block_checksum <span class="o">=</span> <span class="nb">false </span>scope <span class="o">=</span> spfile<span class="p">;</span>

System altered.
WXJ@darkdb 2280,21677 SQL&gt; alter system flush buffer_cache<span class="p">;</span>

System altered.

Elapsed: 00:00:00.01
WXJ@darkdb 2280,21677 SQL&gt; <span class="k">select</span> <span class="k">*</span> from t1<span class="p">;</span>

        C1 C2
<span class="nt">----------</span> <span class="nt">--------------------</span>
         1 <span class="nb">test
         </span>2 demo2
</pre></td></tr></tbody></table></code></pre></div></div>

<p>从这里可以看出，只会修改最近一次匹配的字符，如果存在多个相同的字符，修改的时候只会修改最近一次匹配的字符，所以在修改数据的时候需要注意。存在多个相同字符的时候最好指定 offset</p>

<h2 id="dump-块">dump 块</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">alter</span> <span class="k">system</span> <span class="n">dump</span> <span class="n">datafile</span> <span class="mi">5</span> <span class="n">block</span> <span class="mi">141</span><span class="p">;</span>
<span class="k">select</span> <span class="n">tracefile</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">process</span> <span class="k">where</span> <span class="n">addr</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">paddr</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="k">session</span> <span class="k">where</span> <span class="n">sid</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">sid</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">mystat</span><span class="p">));</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在 吕海波的 oracle 10g ocm 的课程中，dump 通过 bbed 修改过的块，即便是修改了校验和，在日志中也会出现坏块的信息，但是在我的环境 Oracle 11g 中，两次（重启前后）日志都没有出现坏块的提示</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre>┌─[oracle@oracle11g]─[/u01/app/oracle/diag/rdbms/darkdb/darkdb/trace]
└──╼ <span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-i</span> block darkdb_ora_3982.trc darkdb_ora_2850.trc
darkdb_ora_3982.trc:Start dump data blocks tsn: 6 file#:5 minblk 135 maxblk 135
darkdb_ora_3982.trc:Block dump from cache:
darkdb_ora_3982.trc:Block dump from disk:
darkdb_ora_3982.trc:Hex dump of block: <span class="nv">st</span><span class="o">=</span>0, <span class="nv">typ_found</span><span class="o">=</span>1
darkdb_ora_3982.trc:Block header dump:  0x01400087
darkdb_ora_3982.trc: Object <span class="nb">id </span>on Block? Y
darkdb_ora_3982.trc:data_block_dump,data header at 0x7fb06805aa64
darkdb_ora_3982.trc:block_row_dump:
darkdb_ora_3982.trc:end_of_block_dump
darkdb_ora_3982.trc:End dump data blocks tsn: 6 file#: 5 minblk 135 maxblk 135
darkdb_ora_2850.trc:Start dump data blocks tsn: 6 file#:5 minblk 141 maxblk 141
darkdb_ora_2850.trc:Block dump from cache:
darkdb_ora_2850.trc:Block dump from disk:
darkdb_ora_2850.trc:Hex dump of block: <span class="nv">st</span><span class="o">=</span>0, <span class="nv">typ_found</span><span class="o">=</span>1
darkdb_ora_2850.trc:Block header dump:  0x0140008d
darkdb_ora_2850.trc: Object <span class="nb">id </span>on Block? Y
darkdb_ora_2850.trc:data_block_dump,data header at 0x7fb4fdcaea64
darkdb_ora_2850.trc:block_row_dump:
darkdb_ora_2850.trc:end_of_block_dump
darkdb_ora_2850.trc:End dump data blocks tsn: 6 file#: 5 minblk 141 maxblk 141
┌─[oracle@oracle11g]─[/u01/app/oracle/diag/rdbms/darkdb/darkdb/trace]
└──╼ <span class="err">$</span>
</pre></td></tr></tbody></table></code></pre></div></div>
