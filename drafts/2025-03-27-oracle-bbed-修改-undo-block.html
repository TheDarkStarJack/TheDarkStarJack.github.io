<h2 id="前言">前言</h2>

<p>记录下使用 bbed 修改 undo block 的过程，以及修改 undo block 的注意事项</p>

<p>在回滚块损坏的情况下，通过 bbed 修改 undo block 跳过损坏的 undo block，手动模拟事务提交，跳过事务回滚阶段</p>

<p><strong>环境</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="k">version</span><span class="p">;</span>
<span class="n">BANNER</span>
<span class="c1">----------------------------------------------------------------------------</span>
<span class="n">Oracle</span> <span class="k">Database</span> <span class="mi">11</span><span class="k">g</span> <span class="n">Enterprise</span> <span class="n">Edition</span> <span class="n">Release</span> <span class="mi">11</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="mi">64</span><span class="nb">bit</span> <span class="n">Production</span>
<span class="n">PL</span><span class="o">/</span><span class="k">SQL</span> <span class="n">Release</span> <span class="mi">11</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="n">Production</span>
<span class="n">CORE</span>	<span class="mi">11</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span>	<span class="n">Production</span>
<span class="n">TNS</span> <span class="k">for</span> <span class="n">Linux</span><span class="p">:</span> <span class="k">Version</span> <span class="mi">11</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="n">Production</span>
<span class="n">NLSRTL</span> <span class="k">Version</span> <span class="mi">11</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">4</span><span class="p">.</span><span class="mi">0</span> <span class="o">-</span> <span class="n">Production</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="创建测试表">创建测试表</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">create</span> <span class="k">table</span> <span class="n">test_undo</span> <span class="p">(</span><span class="n">id</span> <span class="n">number</span><span class="p">,</span> <span class="n">name</span> <span class="n">varchar2</span><span class="p">(</span><span class="mi">20</span><span class="p">));</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">test_undo</span> <span class="k">values</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'test1'</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">test_undo</span> <span class="k">values</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'test2'</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">test_undo</span> <span class="k">values</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'test3'</span><span class="p">);</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">test_undo</span> <span class="k">values</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">'test4'</span><span class="p">);</span>
<span class="k">commit</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="session1-修改数据不提交">session1 修改数据不提交</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">update</span> <span class="n">test_undo</span> <span class="k">set</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'test1-1'</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="session2-查看数据">session2 查看数据</h3>

<p><img src="https://darkstaronline.work/blog_images/piclist/piclist-clipboard-images/25/03/20/13-46-36-9b17a7a6e553903581ea4f000de6ab5b-20250320134635926.png" alt="未提交的数据无法查看" /></p>

<h2 id="直接通过-bbed-修改数据文件的-block-itl-状态">直接通过 bbed 修改数据文件的 block Itl 状态</h2>

<h3 id="dump-出-block-150-的内容">dump 出 block 150 的内容</h3>

<p>在不修改 undo block 的情况下，直接修改数据文件的 block 状态，使得事务提交，<strong>切记不要在 session1 中提交或者执行 ddl 操作</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_relative_fno</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">file_id</span><span class="p">,</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_block_number</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">block_id</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="n">FILE_ID</span> <span class="o">|</span> <span class="n">BLOCK_ID</span> <span class="o">|</span> <span class="n">ID</span> <span class="o">|</span> <span class="n">NAME</span>
<span class="c1">-------------------------------</span>
<span class="mi">5</span>       <span class="o">|</span> <span class="mi">150</span>      <span class="o">|</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">test1</span>
<span class="mi">5</span>       <span class="o">|</span> <span class="mi">150</span>      <span class="o">|</span> <span class="mi">2</span>  <span class="o">|</span> <span class="n">test2</span>
<span class="mi">5</span>       <span class="o">|</span> <span class="mi">150</span>      <span class="o">|</span> <span class="mi">3</span>  <span class="o">|</span> <span class="n">test3</span>
<span class="mi">5</span>       <span class="o">|</span> <span class="mi">150</span>      <span class="o">|</span> <span class="mi">4</span>  <span class="o">|</span> <span class="n">test4</span>

<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">9</span><span class="p">,</span><span class="mi">19922</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_relative_fno</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">file_id</span><span class="p">,</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_block_number</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">block_id</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>

   <span class="n">FILE_ID</span>   <span class="n">BLOCK_ID</span>         <span class="n">ID</span> <span class="n">NAME</span>
<span class="c1">---------- ---------- ---------- --------------------</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">1</span> <span class="n">test1</span><span class="o">-</span><span class="mi">1</span> <span class="c1">-- 未提交的数据，block id 没有变化</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">2</span> <span class="n">test2</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">3</span> <span class="n">test3</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">4</span> <span class="n">test4</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>

<span class="k">select</span> <span class="n">dump</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">16</span><span class="p">),</span> <span class="n">dump</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="mi">16</span><span class="p">),</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="n">test_undo</span> <span class="k">order</span> <span class="k">by</span> <span class="n">id</span><span class="p">;</span>
<span class="n">DUMP</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>       <span class="o">|</span> <span class="n">DUMP</span><span class="p">(</span><span class="n">NAME</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>               <span class="o">|</span> <span class="n">ID</span> <span class="o">|</span> <span class="n">NAME</span>
<span class="c1">------------------------------------------------------------</span>
<span class="n">Typ</span><span class="o">=</span><span class="mi">2</span> <span class="n">Len</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span><span class="mi">2</span> <span class="o">|</span> <span class="n">Typ</span><span class="o">=</span><span class="mi">1</span> <span class="n">Len</span><span class="o">=</span><span class="mi">5</span><span class="p">:</span> <span class="mi">74</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mi">74</span><span class="p">,</span><span class="mi">31</span> <span class="o">|</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">test1</span>
<span class="n">Typ</span><span class="o">=</span><span class="mi">2</span> <span class="n">Len</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span><span class="mi">3</span> <span class="o">|</span> <span class="n">Typ</span><span class="o">=</span><span class="mi">1</span> <span class="n">Len</span><span class="o">=</span><span class="mi">5</span><span class="p">:</span> <span class="mi">74</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mi">74</span><span class="p">,</span><span class="mi">32</span> <span class="o">|</span> <span class="mi">2</span>  <span class="o">|</span> <span class="n">test2</span>
<span class="n">Typ</span><span class="o">=</span><span class="mi">2</span> <span class="n">Len</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span><span class="mi">4</span> <span class="o">|</span> <span class="n">Typ</span><span class="o">=</span><span class="mi">1</span> <span class="n">Len</span><span class="o">=</span><span class="mi">5</span><span class="p">:</span> <span class="mi">74</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mi">74</span><span class="p">,</span><span class="mi">33</span> <span class="o">|</span> <span class="mi">3</span>  <span class="o">|</span> <span class="n">test3</span>
<span class="n">Typ</span><span class="o">=</span><span class="mi">2</span> <span class="n">Len</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span><span class="mi">5</span> <span class="o">|</span> <span class="n">Typ</span><span class="o">=</span><span class="mi">1</span> <span class="n">Len</span><span class="o">=</span><span class="mi">5</span><span class="p">:</span> <span class="mi">74</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mi">74</span><span class="p">,</span><span class="mi">34</span> <span class="o">|</span> <span class="mi">4</span>  <span class="o">|</span> <span class="n">test4</span>

<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">9</span><span class="p">,</span><span class="mi">19922</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">dump</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span> <span class="k">as</span> <span class="n">did</span><span class="p">,</span> <span class="n">dump</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span> <span class="k">as</span> <span class="n">dname</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="n">test_undo</span> <span class="k">order</span> <span class="k">by</span> <span class="n">id</span><span class="p">;</span>
<span class="n">DID</span>                  <span class="n">DNAME</span>                                            <span class="n">ID</span> <span class="n">NAME</span>
<span class="c1">-------------------- ---------------------------------------- ---------- ----------</span>
<span class="n">Typ</span><span class="o">=</span><span class="mi">2</span> <span class="n">Len</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span><span class="mi">2</span>    <span class="n">Typ</span><span class="o">=</span><span class="mi">1</span> <span class="n">Len</span><span class="o">=</span><span class="mi">7</span><span class="p">:</span> <span class="mi">74</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mi">74</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">2</span><span class="n">d</span><span class="p">,</span><span class="mi">31</span>                 <span class="mi">1</span> <span class="n">test1</span><span class="o">-</span><span class="mi">1</span>
<span class="n">Typ</span><span class="o">=</span><span class="mi">2</span> <span class="n">Len</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span><span class="mi">3</span>    <span class="n">Typ</span><span class="o">=</span><span class="mi">1</span> <span class="n">Len</span><span class="o">=</span><span class="mi">5</span><span class="p">:</span> <span class="mi">74</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mi">74</span><span class="p">,</span><span class="mi">32</span>                       <span class="mi">2</span> <span class="n">test2</span>
<span class="n">Typ</span><span class="o">=</span><span class="mi">2</span> <span class="n">Len</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span><span class="mi">4</span>    <span class="n">Typ</span><span class="o">=</span><span class="mi">1</span> <span class="n">Len</span><span class="o">=</span><span class="mi">5</span><span class="p">:</span> <span class="mi">74</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mi">74</span><span class="p">,</span><span class="mi">33</span>                       <span class="mi">3</span> <span class="n">test3</span>
<span class="n">Typ</span><span class="o">=</span><span class="mi">2</span> <span class="n">Len</span><span class="o">=</span><span class="mi">2</span><span class="p">:</span> <span class="n">c1</span><span class="p">,</span><span class="mi">5</span>    <span class="n">Typ</span><span class="o">=</span><span class="mi">1</span> <span class="n">Len</span><span class="o">=</span><span class="mi">5</span><span class="p">:</span> <span class="mi">74</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">73</span><span class="p">,</span><span class="mi">74</span><span class="p">,</span><span class="mi">34</span>                       <span class="mi">4</span> <span class="n">test4</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>不管是在 session1 还是其他 session 中，查看到的 block id 都是一样的，区别在于 session1 中可以查看到未提交的数据</p>

<p>dump 出 block 150 的内容，切记不要在 session1 中执行，dump 操作是 ddl 操作，会提交事务</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">alter</span> <span class="k">system</span> <span class="n">dump</span> <span class="n">datafile</span> <span class="mi">5</span> <span class="n">block</span> <span class="mi">150</span><span class="p">;</span>
<span class="k">select</span> <span class="n">tracefile</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">process</span> <span class="k">where</span> <span class="n">addr</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">paddr</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="k">session</span> <span class="k">where</span> <span class="n">sid</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">sid</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">mystat</span><span class="p">));</span>

<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">764</span><span class="p">,</span><span class="mi">20136</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">alter</span> <span class="k">system</span> <span class="n">dump</span> <span class="n">datafile</span> <span class="mi">5</span> <span class="n">block</span> <span class="mi">150</span><span class="p">;</span>

<span class="k">System</span> <span class="n">altered</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">764</span><span class="p">,</span><span class="mi">20136</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">tracefile</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">process</span> <span class="k">where</span> <span class="n">addr</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">paddr</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="k">session</span> <span class="k">where</span> <span class="n">sid</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">sid</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">mystat</span><span class="p">));</span>

<span class="n">TRACEFILE</span>
<span class="c1">----------------------------------------------------------------------------------------------------</span>
<span class="o">/</span><span class="n">u01</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">oracle</span><span class="o">/</span><span class="n">diag</span><span class="o">/</span><span class="n">rdbms</span><span class="o">/</span><span class="n">darkdb</span><span class="o">/</span><span class="n">darkdb</span><span class="o">/</span><span class="n">trace</span><span class="o">/</span><span class="n">darkdb_ora_20136</span><span class="p">.</span><span class="n">trc</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">02</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="查看-dump-文件内容">查看 dump 文件内容</h3>

<p>文件内容不多，直接 cat 显示</p>

<p><strong>大小端翻转的时候 Xid 和 Uba 以及 Scn 的翻转方式不同，根据 dump 文件的小数点分割来进行翻转，不要按照字节来翻转，这样会导致错误</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
</pre></td><td class="rouge-code"><pre>┌─[oracle@oracle11g]─[/u01/app/oracle/diag/rdbms/darkdb/darkdb/trace]
└──╼ <span class="nv">$ </span><span class="nb">cat</span> /u01/app/oracle/diag/rdbms/darkdb/darkdb/trace/darkdb_ora_20136.trc
Trace file /u01/app/oracle/diag/rdbms/darkdb/darkdb/trace/darkdb_ora_20136.trc
Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options
ORACLE_HOME <span class="o">=</span> /u01/app/oracle/product/11.2.0/db
System name:    Linux
Node name:      oracle11g
Release:        5.4.17-2102.201.3.el7uek.x86_64
Version:        <span class="c">#2 SMP Fri Apr 23 09:05:55 PDT 2021</span>
Machine:        x86_64
Instance name: darkdb
Redo thread mounted by this instance: 1
Oracle process number: 29
Unix process pid: 20136, image: oracle@oracle11g <span class="o">(</span>TNS V1-V3<span class="o">)</span>


<span class="k">***</span> 2025-03-20 14:05:33.113
<span class="k">***</span> SESSION ID:<span class="o">(</span>764.325<span class="o">)</span> 2025-03-20 14:05:33.113
<span class="k">***</span> CLIENT ID:<span class="o">()</span> 2025-03-20 14:05:33.113
<span class="k">***</span> SERVICE NAME:<span class="o">(</span>SYS<span class="nv">$USERS</span><span class="o">)</span> 2025-03-20 14:05:33.113
<span class="k">***</span> MODULE NAME:<span class="o">(</span>SQL<span class="k">*</span>Plus<span class="o">)</span> 2025-03-20 14:05:33.113
<span class="k">***</span> ACTION NAME:<span class="o">()</span> 2025-03-20 14:05:33.113

Start dump data blocks tsn: 6 file#:5 minblk 150 maxblk 150 <span class="c">## 这里显示的 file# 和 block# 正是我们 dump 的 block，确认没有问题在接着往下看，不然白忙活，minblk 和 maxblk 是 dump 的 block 范围</span>
Block dump from cache:
Dump of buffer cache at level 4 <span class="k">for </span><span class="nv">tsn</span><span class="o">=</span>6 <span class="nv">rdba</span><span class="o">=</span>20971670
BH <span class="o">(</span>0x15afc50c8<span class="o">)</span> file#: 5 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span> class: 1 ba: 0x15a9f6000
  <span class="nb">set</span>: 10 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 96,28
  dbwrid: 0 obj: 96050 objn: 96050 tsn: 6 afn: 5 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x15afca6d0,0x189ebd620] lru: <span class="o">[</span>0x15dff4a38,0x15afc4cd8]
  ckptq: <span class="o">[</span>NULL] fileq: <span class="o">[</span>NULL] objq: <span class="o">[</span>NULL] objaq: <span class="o">[</span>NULL]
  st: CR md: NULL tch: 1
  cr: <span class="o">[</span>scn: 0x0.211a85],[xid: 0x9.3.f07],[uba: 0xc003eb.101.1d],[cls: 0x0.211a85],[sfl: 0x0],[lc: 0x0.211a85]
  flags: only_sequential_access
BH <span class="o">(</span>0x15afca618<span class="o">)</span> file#: 5 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span> class: 1 ba: 0x15aa82000
  <span class="nb">set</span>: 10 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 96,28
  dbwrid: 0 obj: 96050 objn: 96050 tsn: 6 afn: 5 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x15afa2d10,0x15afc5180] lru: <span class="o">[</span>0x15afca360,0x15afca0f0]
  ckptq: <span class="o">[</span>NULL] fileq: <span class="o">[</span>NULL] objq: <span class="o">[</span>NULL] objaq: <span class="o">[</span>NULL]
  st: CR md: NULL tch: 1
  cr: <span class="o">[</span>scn: 0x0.211a07],[xid: 0x9.3.f07],[uba: 0xc003eb.101.1d],[cls: 0x0.211a07],[sfl: 0x0],[lc: 0x0.211a07]
  flags: only_sequential_access
BH <span class="o">(</span>0x15afa2c58<span class="o">)</span> file#: 5 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span> class: 1 ba: 0x15a672000
  <span class="nb">set</span>: 9 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 94,28
  dbwrid: 0 obj: 96050 objn: 96050 tsn: 6 afn: 5 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x15af80288,0x15afca6d0] lru: <span class="o">[</span>0x15afa2e80,0x15afa2c10]
  ckptq: <span class="o">[</span>NULL] fileq: <span class="o">[</span>NULL] objq: <span class="o">[</span>NULL] objaq: <span class="o">[</span>NULL]
  st: CR md: NULL tch: 1
  cr: <span class="o">[</span>scn: 0x0.211a06],[xid: 0x9.3.f07],[uba: 0xc003eb.101.1d],[cls: 0x0.211a06],[sfl: 0x0],[lc: 0x0.211a06]
  flags: only_sequential_access
BH <span class="o">(</span>0x15af801d0<span class="o">)</span> file#: 5 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span> class: 1 ba: 0x15a2e4000
  <span class="nb">set</span>: 12 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 93,28
  dbwrid: 0 obj: 96050 objn: 96050 tsn: 6 afn: 5 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x15aff05c0,0x15afa2d10] lru: <span class="o">[</span>0x15af803f8,0x15af80188]
  ckptq: <span class="o">[</span>NULL] fileq: <span class="o">[</span>NULL] objq: <span class="o">[</span>NULL] objaq: <span class="o">[</span>NULL]
  st: CR md: NULL tch: 1
  cr: <span class="o">[</span>scn: 0x0.2119fb],[xid: 0x9.3.f07],[uba: 0xc003eb.101.1d],[cls: 0x0.2119fb],[sfl: 0x0],[lc: 0x0.2119fb]
  flags: only_sequential_access
BH <span class="o">(</span>0x15aff0508<span class="o">)</span> file#: 5 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span> class: 1 ba: 0x15ae66000
  <span class="nb">set</span>: 11 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 103,28
  dbwrid: 0 obj: 96050 objn: 96050 tsn: 6 afn: 5 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x15afca598,0x15af80288] lru: <span class="o">[</span>0x15aff0730,0x15aff04c0]
  ckptq: <span class="o">[</span>NULL] fileq: <span class="o">[</span>NULL] objq: <span class="o">[</span>NULL] objaq: <span class="o">[</span>NULL]
  st: CR md: NULL tch: 1
  cr: <span class="o">[</span>scn: 0x0.2119fa],[xid: 0x9.3.f07],[uba: 0xc003eb.101.1d],[cls: 0x0.2119fa],[sfl: 0x0],[lc: 0x0.2119fa]
  flags: only_sequential_access
BH <span class="o">(</span>0x15afca4e0<span class="o">)</span> file#: 5 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span> class: 1 ba: 0x15aa80000
  <span class="nb">set</span>: 10 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 96,28
  dbwrid: 0 obj: 96050 objn: 96050 tsn: 6 afn: 5 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x189ebd620,0x15aff05c0] lru: <span class="o">[</span>0x15afca840,0x15dff0868]
  ckptq: <span class="o">[</span>NULL] fileq: <span class="o">[</span>NULL] objq: <span class="o">[</span>0x15afcb0f0,0x177f3c1e0] objaq: <span class="o">[</span>0x15afcb100,0x177f3c1d0]
  st: XCURRENT md: NULL fpin: <span class="s1">'ktspbwh2: ktspfmdb'</span> tch: 3
  flags: block_written_once redo_since_read
  LRBA: <span class="o">[</span>0x0.0.0] LSCN: <span class="o">[</span>0x0.0] HSCN: <span class="o">[</span>0xffff.ffffffff] HSUB: <span class="o">[</span>1]
Block dump from disk:
buffer tsn: 6 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span>
scn: 0x0000.00211a85 <span class="nb">seq</span>: 0x01 flg: 0x04 <span class="nb">tail</span>: 0x1a850601
frmt: 0x02 chkval: 0xbe10 <span class="nb">type</span>: <span class="nv">0x06</span><span class="o">=</span>trans data
Hex dump of block: <span class="nv">st</span><span class="o">=</span>0, <span class="nv">typ_found</span><span class="o">=</span>1
Dump of memory from 0x00007F3689BDBA00 to 0x00007F3689BDDA00
7F3689BDBA00 0000A206 01400096 00211A85 04010000  <span class="o">[</span>......@...!.....]
7F3689BDBA10 0000BE10 00000001 00017732 00211A85  <span class="o">[</span>........2w....!.]
7F3689BDBA20 00000000 00320002 01400090 001A0003  <span class="o">[</span>......2...@.....]
7F3689BDBA30 00000F54 00C009CD 001F00DF 00008000  <span class="o">[</span>T...............]
7F3689BDBA40 002118A0 00030009 00000F07 00C003EB  <span class="o">[</span>..!.............]
7F3689BDBA50 001D0101 00000001 00000000 00000000  <span class="o">[</span>................]
7F3689BDBA60 00000000 00040100 001AFFFF 1F4C1F5A  <span class="o">[</span>............Z.L.]
7F3689BDBA70 00001F4C 1F5A0004 1F741F80 00001F68  <span class="o">[</span>L.....Z...t.h...]
7F3689BDBA80 00000000 00000000 00000000 00000000  <span class="o">[</span>................]
        Repeat 498 <span class="nb">times
</span>7F3689BDD9B0 00000000 00000000 00000000 022C0000  <span class="o">[</span>..............,.]
7F3689BDD9C0 02C10202 73657407 312D3174 0202002C  <span class="o">[</span>.....test1-1,...] <span class="c">## 这里显示的是修改后的数据</span>
7F3689BDD9D0 740505C1 34747365 0202002C 740504C1  <span class="o">[</span>...test4,......t]
7F3689BDD9E0 33747365 0202002C 740503C1 32747365  <span class="o">[</span>est3,......test2]
7F3689BDD9F0 0202002C 740502C1 31747365 1A850601  <span class="o">[</span>,......test1....] <span class="c">## 这里显示的是修改前的数据，可以看到修改后的数据和修改前的数据都在 block 中，Oracle 不会主动清理磁盘上的数据，只是在逻辑上标记为删除，然后复用</span>
End dump data blocks tsn: 6 file#: 5 minblk 150 maxblk 150
Block header dump:  0x01400096
 Object <span class="nb">id </span>on Block? Y
 seg/obj: 0x17732  csc: 0x00.211a85  itc: 2  flg: E  typ: 1 - DATA
     brn: 0  bdba: 0x1400090 ver: 0x01 opc: 0
     inc: 0  exflg: 0

 Itl           Xid                  Uba         Flag  Lck        Scn/Fsc
0x01   0x0003.01a.00000f54  0x00c009cd.00df.1f  C---    0  scn 0x0000.002118a0
         |
         V                                       <span class="c">#这里的 C 表示 commit，表示事务已经提交，Lck 是锁的标志，0 表示没有锁，或者确切的说是 0 行被锁。这里的 scn 是 commit 的 scn</span>
       前两位 0003 回滚段 undo （v<span class="nv">$rollname</span>.name 对应的值就是 undo segment）编号（然后在关联 dba_segment name 获取信息），中间的 01a 是事务表槽号（也可以理解为行号，可以通过后文 dump undo 信息对应的 TRN TBL 信息查看） slot ，后面的 00000f54 事务表序列号，对应的是 wrap# 。序列号每次被覆盖就会加 1 ，用于判断事务是否发生变化（事务槽对应的还是否是同一个事务）

<span class="c">## select name from v$rollname where usn = 3;</span>
<span class="c">## select header_file, header_block, blocks  from dba_segments where segment_name = '_SYSSMU3_1723003836$';</span>
<span class="c">## select extent_id, file_id., block_id, blocks from dba_extents where segment_name = '_SYSSMU3_1723003836$';</span>
0x02   0x0009.003.00000f07  0x00c003eb.0101.1d  <span class="nt">----</span>    1  fsc 0x0000.00000000
                                                <span class="c">#这里的----表示没有 commit，我们需要做的就是将这个事务的 commit 标志改为 commit，然后将 scn 改为 commit 的 scn，这样就可以将这个事务置为提交，即便当前会话没有提交，但是其他会话可以看到修改后的数据</span>
<span class="c">## 只要 Itl 存在没有提交的事务，Oracle 每次读取到这个事务槽的时候都会发生回滚 undo，并不需要读取到下面的 block_row_dump 展现的 lb 0x2 没有提交的事务再发生回滚。</span>
<span class="c">## 例如 session2 读取的时候表 test_undo 的时候，session1 还没有提交事务，所以 session2 读取到的数据是 test1，而不是 test1-1，Oracle 就会发生回滚 undo，将 test1-1 回滚为 test1，对于 session2 来说，就是看不到 session1 的修改数据。Oracle 访问和事务无关的三行是，会先读取 CR 块，然后再 CR 块上做 undo，这样就可以保证事务的一致性。是否需要构造 CR 块，是以 Itl 事务槽为准，如果 Itl 事务槽有未提交的事务，就会构造 CR 块，如果没有未提交的事务，就不会构造 CR 块</span>
<span class="c"># 我们需要通过 bbed 的操作，就是将 0x02 对应的 Flag 修改为 C---，Lck 修改为 0 ，然后将 scn 修改为 0x0000.002118a0（比上一个 SCN 大一点就行，不能比当前实例的 SCN 还大），这样就可以将这个事务置为提交，即便当前会话没有提交，但是其他会话可以看到修改后的数据</span>
bdba: 0x01400096
data_block_dump,data header at 0x7f3689bdba64
<span class="o">===============</span>
tsiz: 0x1f98
hsiz: 0x1a
pbl: 0x7f3689bdba64
     76543210
<span class="nv">flag</span><span class="o">=</span><span class="nt">--------</span>
<span class="nv">ntab</span><span class="o">=</span>1
<span class="nv">nrow</span><span class="o">=</span>4
<span class="nv">frre</span><span class="o">=</span><span class="nt">-1</span>
<span class="nv">fsbo</span><span class="o">=</span>0x1a
<span class="nv">fseo</span><span class="o">=</span>0x1f5a
<span class="nv">avsp</span><span class="o">=</span>0x1f4c
<span class="nv">tosp</span><span class="o">=</span>0x1f4c
0xe:pti[0]      <span class="nv">nrow</span><span class="o">=</span>4  <span class="nv">offs</span><span class="o">=</span>0
0x12:pri[0]     <span class="nv">offs</span><span class="o">=</span>0x1f5a
0x14:pri[1]     <span class="nv">offs</span><span class="o">=</span>0x1f80
0x16:pri[2]     <span class="nv">offs</span><span class="o">=</span>0x1f74
0x18:pri[3]     <span class="nv">offs</span><span class="o">=</span>0x1f68
block_row_dump:
tab 0, row 0, @0x1f5a
tl: 14 fb: <span class="nt">--H-FL--</span> lb: 0x2  cc: 2 <span class="c">## lb 是锁的标志，和上文的 Itl 事务槽（0x02)关联，只要 lb 不为 0x0 就表示和其他事务有关联，而且这个事务是未提交的事务，可以把 lb 理解为行锁</span>
col  0: <span class="o">[</span> 2]  c1 02 <span class="c">## col 0 表示第一列，[ 2] 表示长度为 2，c1 02 表示第一列对应的十六进制的值，select dump(id,16)</span>
col  1: <span class="o">[</span> 7]  74 65 73 74 31 2d 31 <span class="c">## col 1 表示第二列，[ 7] 表示长度为 7，74 65 73 74 31 2d 31 表示第二列对应的十六进制的值，select dump(name,16)，这里的值是修改后的值 select dump(test1-1,16)</span>
<span class="o">[</span>
tab 0, row 1, @0x1f80
tl: 12 fb: <span class="nt">--H-FL--</span> lb: 0x0  cc: 2
col  0: <span class="o">[</span> 2]  c1 03
col  1: <span class="o">[</span> 5]  74 65 73 74 32
tab 0, row 2, @0x1f74
tl: 12 fb: <span class="nt">--H-FL--</span> lb: 0x0  cc: 2
col  0: <span class="o">[</span> 2]  c1 04
col  1: <span class="o">[</span> 5]  74 65 73 74 33
tab 0, row 3, @0x1f68
tl: 12 fb: <span class="nt">--H-FL--</span> lb: 0x0  cc: 2
col  0: <span class="o">[</span> 2]  c1 05
col  1: <span class="o">[</span> 5]  74 65 73 74 34
<span class="o">]</span> <span class="c">## 从这里也可以看出来，目前这个 block 中有 4 行数据，其中第一行的行锁是 0x2，表示和其他事务有关联，其他 3 行的行锁是 0x0，表示没有和其他事务有关联</span>
end_of_block_dump
End dump data blocks tsn: 6 file#: 5 minblk 150 maxblk 150
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="使用-bbed-修改-block-150-的-itl-事务槽">使用 bbed 修改 block 150 的 Itl 事务槽</h3>

<p>通过上面的理解，我们可以通过 bbed 修改 block 150 的 Itl 事务槽，将未提交的事务置为提交，这样其他 session 就可以看到修改后的数据</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre>BBED&gt; <span class="nb">set </span>FILENAME <span class="s1">'/oradata/darkdb/data01.dbf'</span>
        FILENAME        /oradata/darkdb/data01.dbf

BBED&gt; <span class="nb">set </span>file 5
        FILE#           5

BBED&gt; <span class="nb">set </span>block 150
        BLOCK#          150

BBED&gt; <span class="nb">set </span>count 8192
        COUNT           8192

BBED&gt; show all
        FILE#           5
        BLOCK#          150
        OFFSET          0
        DBA             0x01400096 <span class="o">(</span>20971670 5,150<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Browse
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           8192
        LOGFILE         log.bbd
        SPOOL           No

BBED&gt;


BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to 8191           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 3c1d2100 00000104 a9b90000 01000000 32770100 3c1d2100
 00000000 02003200 90004001 03001a00 540f0000 cd09c000 df001f00 00800000
 a0182100 09000300 070f0000 eb03c000 01011d00 01000000 00000000 00000000
 00000000 00010400 ffff1a00 5a1f4c1f 4c1f0000 04005a1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
<span class="c">## 省略中间的 00000</span>
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00002c02
 0202c102 07746573 74312d31 2c000202 c1050574 65737434 2c000202 c1040574
 65737433 2c000202 c1030574 65737432 2c000202 c1020574 65737431 01063c1d

 &lt;32 bytes per line&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>因为是修改 Itl 信息就行，所以不需要 dump 所有的 8192 字节，只需要 dump 出 Itl 信息就行</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre>
<span class="c">##  Itl           Xid                  Uba         Flag  Lck        Scn/Fsc</span>
<span class="c">## 0x01   0x0003.01a.00000f54[03001a00 540f0000]  0x00c009cd.00df.1f  C---    0  scn 0x0000.002118a0</span>
<span class="c">## 0x02   0x0009.003.00000f07[09000300 070f0000]  0x00c003eb.0101.1d  ----    1  fsc 0x0000.00000000</span>

BBED&gt; <span class="nb">set </span>count 512
        COUNT           512

BBED&gt;
BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to  511           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 3c1d2100 00000104 a9b90000 01000000 32770100 3c1d2100
 00000000 02003200 90004001 <span class="o">[</span>03001a00 540f0000] cd09c000 df001f00 00800000 <span class="c">## 注意大小端问题，这里的 540f0000 是 0x00000f54 的大小端，Itl 总是会从 Xid 的位置开始</span>
 a0182100 <span class="o">[</span>09000300 070f0000] eb03c000 01011d00 01000000 00000000 00000000 <span class="c">## 注意大小端问题，这里的 070f0000 是 0x00000f07 的大小端，两个 Itl 事务槽都找到了</span>
 00000000 00010400 ffff1a00 5a1f4c1f 4c1f0000 04005a1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000

 &lt;32 bytes per line&gt;

</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="修改-flag">修改 Flag</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
</pre></td><td class="rouge-code"><pre>BBED&gt;
<span class="c">## 方便观察，设置下 offset 重新 dump 一下对齐显示</span>
BBED&gt; <span class="nb">set </span>offset 0
        OFFSET          0

BBED&gt; <span class="nb">set </span>count 200
        COUNT           200

BBED&gt; show all
        FILE#           5
        BLOCK#          150
        OFFSET          0
        DBA             0x01400096 <span class="o">(</span>20971670 5,150<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Browse
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           200
        LOGFILE         log.bbd
        SPOOL           No

<span class="c">## 这里需要注意有可能存在重复的字符，注意甄别 offset 位置是否正确</span>
BBED&gt; find /x 03001a00
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   44 to  243           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 03001a00 540f0000 cd09c000 df001f00 <span class="o">[</span>00800000] <span class="o">[</span>a0182100] 09000300 070f0000 <span class="c">## 这里的 00800000 就是 Flag 的 C---，我们需要将 0x02 的 Flag 修改为 C---（00800000），表示事务已经提交。 a0182100 就是 Scn ，后面紧跟的是下一个 Itl 事务槽的 Xid</span>
 eb03c000 01011d00 01000000 00000000 00000000 00000000 00010400 ffff1a00
 5a1f4c1f 4c1f0000 04005a1f 801f741f 681f0000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

BBED&gt;

<span class="c">##  Itl           Xid                                    Uba         Flag  Lck        Scn/Fsc</span>
<span class="c">## 0x01   0x0003.01a.00000f54[03001a00 540f0000]  0x00c009cd.00df.1f  C---    0  scn 0x0000.002118a0</span>
<span class="c">## 0x02   0x0009.003.00000f07[09000300 070f0000]  0x00c003eb.0101.1d  ----    1  fsc 0x0000.00000000</span>
<span class="c">## 我们需要修改的是 Flag Lck Scn</span>
<span class="c">## 大小端翻转的时候 Xid 和 Uba 以及 Scn 的翻转方式不同，根据 dump 文件的小数点分割来进行翻转，不要按照字节来翻转，这样会导致错误</span>
<span class="c">## 先找到 0x02 对应的 Flag，通过查找 Uba 的位置，后面挨着的就是 Flag，直接将 C 转换为 16 进制是不行的</span>

BBED&gt; find /x 01011d00
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   80 to  279           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
<span class="o">[</span>01]011d00 <span class="o">[</span>01000000] 00000000 00000000 00000000 00010400 ffff1a00 5a1f4c1f
<span class="c">## 01 表示 offset 80 的位置，两位数字表示一个字节，我们需要修改的 Flag 位置起始点就是 80+4 也就是 [01000000]，修改为 [00800000]，表示事务已经提交</span>
 4c1f0000 04005a1f 801f741f 681f0000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

<span class="c">## 可以先设置 offset 为 84 ， 然后再 modify ，也可以直接 modify /x 0x000000 offset 84</span>
BBED&gt; <span class="nb">set </span>mode edit
        MODE            Edit

BBED&gt; modify /x 00800000 offset 84
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   84 to  283           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 00800000 00000000 00000000 00000000 00010400 ffff1a00 5a1f4c1f 4c1f0000
 04005a1f 801f741f 681f0000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

BBED&gt; <span class="nb">set </span>offset 80
        OFFSET          80

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   80 to  279           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 01011d00 00800000 00000000 00000000 00000000 00010400 ffff1a00 5a1f4c1f
 4c1f0000 04005a1f 801f741f 681f0000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

BBED&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="修改-scn">修改 Scn</h3>

<p>修改了 Flag 之后，我们需要修改 Scn，Flag 位置后面紧跟的就是 Scn，我们需要将 Scn 修改为比上一个事务的 Scn 大一点的值就行，不要超过当前实例的 Scn</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c">##  Itl           Xid                                    Uba         Flag  Lck        Scn/Fsc</span>
<span class="c">## 0x01   0x0003.01a.00000f54[03001a00 540f0000]  0x00c009cd.00df.1f  C---    0  scn 0x0000.002118a0</span>
<span class="c">## 0x02   0x0009.003.00000f07[09000300 070f0000]  0x00c003eb.0101.1d  ----    1  fsc 0x0000.00000000</span>
<span class="c">## 上一个 Itl 的 Scn 是 0x0000.002118a0，我们需要将 0x02 的 Scn 修改为比 0x0000.002118a0 大一点的值</span>
<span class="c">## a0182100</span>

BBED&gt; show offset
        OFFSET          80
<span class="c">## modify /x a0182200 offset 88</span>
BBED&gt; modify /x a0182200 offset 88
BBED-00209: invalid number <span class="o">(</span>a0182200<span class="o">)</span>
<span class="c">## 如果出现以上报错，是因为 Oracle 觉得数字太大了吧，可以拆分为两部分修改，先修改 offset 88 两个字节，然后再修改 offset 90 两个字节</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>中途有事，测试没有做完，连接断开了，导致之前的 session1 窗口断开，应该自动回滚了，正好接着测试 session2</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">9</span><span class="p">,</span><span class="mi">12627</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>

        <span class="n">ID</span> <span class="n">NAME</span>
<span class="c1">---------- --------------------</span>
         <span class="mi">1</span> <span class="n">test1</span> <span class="c1">-- 可以看到这里还是修改前的数据</span>
         <span class="mi">2</span> <span class="n">test2</span>
         <span class="mi">3</span> <span class="n">test3</span>
         <span class="mi">4</span> <span class="n">test4</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">9</span><span class="p">,</span><span class="mi">12627</span> <span class="k">SQL</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>接着查看 对应的 block 信息</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre><span class="nb">set </span>filename <span class="s1">'/oradata/darkdb/data01.dbf'</span>
<span class="nb">set </span>file 5
<span class="nb">set </span>block 150
show all
BBED&gt; show all
        FILE#           5
        BLOCK#          150
        OFFSET          0
        DBA             0x01400096 <span class="o">(</span>20971670 5,150<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Browse
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           512
        LOGFILE         log.bbd
        SPOOL           No
BBED&gt; <span class="nb">set </span>offset 80
        OFFSET          80

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   80 to  591           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 00000000 00000000 00000000 00000000 00000000 00010400 ffff1a00 4e1f4e1f
 4e1f0000 04004e1f 801f741f 681f0000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000

 &lt;32 bytes per line&gt;
</pre></td></tr></tbody></table></code></pre></div></div>
<p>可以看到之前 bbed 修改的内容已经被回滚了</p>

<p><img src="https://darkstaronline.work/blog_images/piclist/piclist-clipboard-images/25/03/21/12-04-36-c25ced0e026563f8c5da2f1b5293eb8c-20250321120435957.png" alt="数据发生回滚" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre>BBED&gt; <span class="nb">set </span>offset 0
        OFFSET          0

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to  511           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 52862100 00000104 e3d70000 01000000 32770100 b6482100
 00000000 02003200 90004001 03001a00 540f0000 cd09c000 df001f00 00800000
 a0182100 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000

<span class="c">## 查看尾部的数据</span>
<span class="nb">set </span>count 8192
dump

 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00002c00 <span class="o">[</span>0202c102 05746573 74312c02] <span class="c">## 多出来的部分内容，这里其实有点混淆了，测试用例不太好，应该选择不同的字符作为参考，相同的字符(test1 -&gt; test1-1)太多导致结果无法清晰的查看出来</span>
 0202c102 07746573 74312d31 2c000202 c1050574 65737434 2c000202 c1040574
 65737433 2c000202 c1030574 65737432 2c000202 c1020574 65737431 01065286

 &lt;32 bytes per line&gt;

BBED&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>右边窗口为断开前的 data 内容，左边为新的 dump 内容，可以看到也发生了改变</p>

<p><img src="https://darkstaronline.work/blog_images/piclist/piclist-clipboard-images/25/03/21/12-09-02-14b0af869d828266b40fb737b8403871-20250321120901951.png" alt="data 部分对比" />
接着修改 Itl 信息测试</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
</pre></td><td class="rouge-code"><pre>BBED&gt; <span class="nb">set </span>count 200
        COUNT           200

BBED&gt; <span class="nb">set </span>offset 0
        OFFSET          0

BBED&gt; show all
        FILE#           5
        BLOCK#          150
        OFFSET          0
        DBA             0x01400096 <span class="o">(</span>20971670 5,150<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Browse
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           200
        LOGFILE         log.bbd
        SPOOL           No

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to  199           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 52862100 00000104 e3d70000 01000000 32770100 b6482100
 00000000 02003200 90004001 03001a00 540f0000 cd09c000 df001f00 00800000
 a0182100 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

BBED&gt;

<span class="c">## 为了保险起见 重新 dump 以下 trace 信息</span>
WXJ@darkdb 9,12627 SQL&gt; <span class="k">select </span>tracefile from v<span class="nv">$process</span> where addr <span class="k">in</span> <span class="o">(</span><span class="k">select </span>paddr from v<span class="nv">$session</span> where sid <span class="k">in</span> <span class="o">(</span><span class="k">select </span>sid from v<span class="nv">$mystat</span><span class="o">))</span><span class="p">;</span>

TRACEFILE
<span class="nt">----------------------------------------------------------------------------------------------------</span>
/u01/app/oracle/diag/rdbms/darkdb/darkdb/trace/darkdb_ora_12627.trc

Elapsed: 00:00:00.03
WXJ@darkdb 9,12627 SQL&gt;
┌─[oracle@oracle11g]─[~]
└──╼ <span class="nv">$ </span>vim <span class="nt">-R</span> /u01/app/oracle/diag/rdbms/darkdb/darkdb/trace/darkdb_ora_12627.trc
┌─[oracle@oracle11g]─[~] <span class="c">## 可以看出 Itl 0x01 信息没有变化，但是 0x02 已经全部变为 0 了，test1-1 也还在 block 信息中</span>
 15 7FF96AE05A60 00000000 00040100 001AFFFF 1F4E1F4E  <span class="o">[</span>............N.N.]
 14 7FF96AE05A70 00001F4E 1F4E0004 1F741F80 00001F68  <span class="o">[</span>N.....N...t.h...]
 13 7FF96AE05A80 00000000 00000000 00000000 00000000  <span class="o">[</span>................]
 12         Repeat 498 <span class="nb">times
 </span>11 7FF96AE079B0 002C0000 02C10202 73657405 022C3174  <span class="o">[</span>..,......test1,.]
 10 7FF96AE079C0 02C10202 73657407 312D3174 0202002C  <span class="o">[</span>.....test1-1,...]
  9 7FF96AE079D0 740505C1 34747365 0202002C 740504C1  <span class="o">[</span>...test4,......t]
  8 7FF96AE079E0 33747365 0202002C 740503C1 32747365  <span class="o">[</span>est3,......test2]
  7 7FF96AE079F0 0202002C 740502C1 31747365 86520601  <span class="o">[</span>,......test1..R.]
  6 Block header dump:  0x01400096
  5  Object <span class="nb">id </span>on Block? Y
  4  seg/obj: 0x17732  csc: 0x00.2148b6  itc: 2  flg: E  typ: 1 - DATA
  3      brn: 0  bdba: 0x1400090 ver: 0x01 opc: 0
  2      inc: 0  exflg: 0
  1 <span class="nb">.</span>
101  Itl           Xid                  Uba         Flag  Lck        Scn/Fsc                                                                                                                              1 0x01   0x0003.01a.00000f54  0x00c009cd.00df.1f  C---    0  scn 0x0000.002118a0
  2 0x02   <span class="o">[</span>0x0000.000.00000000  0x00000000.0000.00  <span class="nt">----</span>    0  fsc 0x0000.00000000] <span class="c">## 已经不在持有锁</span>
  3 bdba: 0x01400096
  4 data_block_dump,data header at 0x7ff96ae05a64
  5 <span class="o">===============</span>
  6 tsiz: 0x1f98
  7 hsiz: 0x1a
  8 pbl: 0x7ff96ae05a64
  9      76543210
 10 <span class="nv">flag</span><span class="o">=</span><span class="nt">--------</span>
 11 <span class="nv">ntab</span><span class="o">=</span>1
 12 <span class="nv">nrow</span><span class="o">=</span>4
 13 <span class="nv">frre</span><span class="o">=</span><span class="nt">-1</span>
 14 <span class="nv">fsbo</span><span class="o">=</span>0x1a
 15 <span class="nv">fseo</span><span class="o">=</span>0x1f4e

<span class="c">## 修改 Flag</span>
BBED&gt; modify /x 00800000 offset 84
Warning: contents of previous BIFILE will be lost. Proceed? <span class="o">(</span>Y/N<span class="o">)</span> y
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   84 to  283           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 00800000 00000000 00000000 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000
 04004e1f 801f741f 681f0000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;


BBED&gt; <span class="nb">set </span>offset 80
        OFFSET          80

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   80 to  279           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 00000000 00800000 00000000 00000000 00000000 00010400 ffff1a00 4e1f4e1f
 4e1f0000 04004e1f 801f741f 681f0000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

<span class="c">## 修改 Scn ，拆分为两部分</span>

<span class="c"># modify /x a018 offset 88</span>
<span class="c"># modify /x 2200 offset 90</span>

BBED&gt; modify /x a018 offset 88
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   88 to  287           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 a0180000 00000000 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f
 801f741f 681f0000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

BBED&gt; modify /x 2200 offset 90
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   90 to  289           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 22000000 00000000 00000001 0400ffff 1a004e1f 4e1f4e1f 00000400 4e1f801f
 741f681f 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

BBED&gt; <span class="nb">set </span>offset 88
        OFFSET          88

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   88 to  287           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 a0182200 00000000 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f
 801f741f 681f0000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>修改完成记得修改校验和</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="nb">sum </span>apply
<span class="c">## 重新在读取一次 block</span>
<span class="nb">set </span>block 150
dump
BBED&gt; <span class="nb">sum </span>apply
Check value <span class="k">for </span>File 5, Block 150:
current <span class="o">=</span> 0x4f61, required <span class="o">=</span> 0x4f61

BBED&gt; <span class="nb">set </span>block 150
        BLOCK#          150

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to  199           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 52862100 00000104 614f0000 01000000 32770100 b6482100
 00000000 02003200 90004001 03001a00 540f0000 cd09c000 df001f00 00800000
 a0182100 00000000 00000000 00000000 00000000 <span class="o">[</span>00800000 a0182200] 00000000
 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="刷新-cache-和-checkpoint">刷新 cache 和 checkpoint</h2>

<p>在刷新 cache 和 checkpoint 之前，一定要记得 bbed 重新读取一次 block ，否则 bbed 修改的信息会被覆盖，因为 bbed 修改的是磁盘上的数据，而 cache 中的数据是内存中的数据，刷新 cache 会将内存中的数据写入磁盘，覆盖掉 bbed 修改的数据</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="k">SQL</span><span class="o">&gt;</span> <span class="k">alter</span> <span class="k">system</span> <span class="n">flush</span> <span class="n">buffer_cache</span><span class="p">;</span>
<span class="n">BBED</span><span class="o">&gt;</span> <span class="n">dump</span>
 <span class="n">File</span><span class="p">:</span> <span class="o">/</span><span class="n">oradata</span><span class="o">/</span><span class="n">darkdb</span><span class="o">/</span><span class="n">data01</span><span class="p">.</span><span class="n">dbf</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
 <span class="n">Block</span><span class="p">:</span> <span class="mi">150</span>              <span class="n">Offsets</span><span class="p">:</span>    <span class="mi">0</span> <span class="k">to</span>  <span class="mi">199</span>           <span class="n">Dba</span><span class="p">:</span><span class="mi">0</span><span class="n">x01400096</span>
<span class="c1">------------------------------------------------------------------------</span>
 <span class="mi">06</span><span class="n">a20000</span> <span class="mi">96004001</span> <span class="mi">52862100</span> <span class="mi">00000104</span> <span class="mi">614</span><span class="n">f0000</span> <span class="mi">01000000</span> <span class="mi">32770100</span> <span class="n">b6482100</span>
 <span class="mi">00000000</span> <span class="mi">02003200</span> <span class="mi">90004001</span> <span class="mi">03001</span><span class="n">a00</span> <span class="mi">540</span><span class="n">f0000</span> <span class="n">cd09c000</span> <span class="n">df001f00</span> <span class="mi">00800000</span>
 <span class="n">a0182100</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00800000</span> <span class="n">a0182200</span> <span class="mi">00000000</span>
 <span class="mi">00000000</span> <span class="mi">00010400</span> <span class="n">ffff1a00</span> <span class="mi">4</span><span class="n">e1f4e1f</span> <span class="mi">4</span><span class="n">e1f0000</span> <span class="mi">04004</span><span class="n">e1f</span> <span class="mi">801</span><span class="n">f741f</span> <span class="mi">681</span><span class="n">f0000</span>
 <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
 <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
 <span class="mi">00000000</span> <span class="mi">00000000</span>

 <span class="o">&lt;</span><span class="mi">32</span> <span class="n">bytes</span> <span class="n">per</span> <span class="n">line</span><span class="o">&gt;</span>

<span class="k">SQL</span><span class="o">&gt;</span> <span class="k">alter</span> <span class="k">system</span> <span class="k">checkpoint</span><span class="p">;</span>
<span class="n">BBED</span><span class="o">&gt;</span> <span class="n">dump</span>
 <span class="n">File</span><span class="p">:</span> <span class="o">/</span><span class="n">oradata</span><span class="o">/</span><span class="n">darkdb</span><span class="o">/</span><span class="n">data01</span><span class="p">.</span><span class="n">dbf</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
 <span class="n">Block</span><span class="p">:</span> <span class="mi">150</span>              <span class="n">Offsets</span><span class="p">:</span>    <span class="mi">0</span> <span class="k">to</span>  <span class="mi">199</span>           <span class="n">Dba</span><span class="p">:</span><span class="mi">0</span><span class="n">x01400096</span>
<span class="c1">------------------------------------------------------------------------</span>
 <span class="mi">06</span><span class="n">a20000</span> <span class="mi">96004001</span> <span class="mi">52862100</span> <span class="mi">00000104</span> <span class="mi">614</span><span class="n">f0000</span> <span class="mi">01000000</span> <span class="mi">32770100</span> <span class="n">b6482100</span>
 <span class="mi">00000000</span> <span class="mi">02003200</span> <span class="mi">90004001</span> <span class="mi">03001</span><span class="n">a00</span> <span class="mi">540</span><span class="n">f0000</span> <span class="n">cd09c000</span> <span class="n">df001f00</span> <span class="mi">00800000</span>
 <span class="n">a0182100</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00800000</span> <span class="n">a0182200</span> <span class="mi">00000000</span>
 <span class="mi">00000000</span> <span class="mi">00010400</span> <span class="n">ffff1a00</span> <span class="mi">4</span><span class="n">e1f4e1f</span> <span class="mi">4</span><span class="n">e1f0000</span> <span class="mi">04004</span><span class="n">e1f</span> <span class="mi">801</span><span class="n">f741f</span> <span class="mi">681</span><span class="n">f0000</span>
 <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
 <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
 <span class="mi">00000000</span> <span class="mi">00000000</span>

 <span class="o">&lt;</span><span class="mi">32</span> <span class="n">bytes</span> <span class="n">per</span> <span class="n">line</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>因为 Itl 0x02 已经释放掉了，所以即便通过 bbed 修改了数据，也无法读取到修改之后的数据了。接下来的测试就直接修改表的数据</p>

<h2 id="修改测试表数据">修改测试表数据</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="n">ID</span> <span class="o">|</span> <span class="n">NAME</span>
<span class="c1">----------</span>
<span class="mi">1</span>  <span class="o">|</span> <span class="n">test1</span>
<span class="mi">2</span>  <span class="o">|</span> <span class="n">test2</span>
<span class="mi">3</span>  <span class="o">|</span> <span class="n">test3</span>
<span class="mi">4</span>  <span class="o">|</span> <span class="n">test4</span>

<span class="o">##</span> <span class="n">session1</span> <span class="err">修改数据不提交</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">update</span> <span class="n">test_undo</span> <span class="k">set</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'AAAA'</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="mi">1</span> <span class="k">row</span> <span class="n">updated</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">01</span>
<span class="o">##</span> <span class="err">因为测试环境的表空间比较小，所以遇到了</span> <span class="n">ORA</span><span class="o">-</span><span class="mi">01555</span><span class="p">:</span> <span class="n">snapshot</span> <span class="n">too</span> <span class="k">old</span><span class="p">:</span> <span class="k">rollback</span> <span class="n">segment</span> <span class="n">number</span> <span class="mi">0</span> <span class="k">with</span> <span class="n">name</span> <span class="nv">"SYSTEM"</span> <span class="n">too</span> <span class="n">small</span> <span class="err">错误</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span>
<span class="o">*</span>
<span class="n">ERROR</span> <span class="k">at</span> <span class="n">line</span> <span class="mi">1</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01555</span><span class="p">:</span> <span class="n">snapshot</span> <span class="n">too</span> <span class="k">old</span><span class="p">:</span> <span class="k">rollback</span> <span class="n">segment</span> <span class="n">number</span> <span class="mi">0</span> <span class="k">with</span> <span class="n">name</span> <span class="nv">"SYSTEM"</span> <span class="n">too</span> <span class="n">small</span>


<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span>
<span class="o">*</span>
<span class="n">ERROR</span> <span class="k">at</span> <span class="n">line</span> <span class="mi">1</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01555</span><span class="p">:</span> <span class="n">snapshot</span> <span class="n">too</span> <span class="k">old</span><span class="p">:</span> <span class="k">rollback</span> <span class="n">segment</span> <span class="n">number</span> <span class="mi">0</span> <span class="k">with</span> <span class="n">name</span> <span class="nv">"SYSTEM"</span> <span class="n">too</span> <span class="n">small</span>

<span class="o">##</span> <span class="err">在</span> <span class="n">session2</span> <span class="err">中可以正常查看到表的数据，也不会报错，回滚段也和</span> <span class="k">System</span> <span class="err">有关</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="n">ID</span> <span class="o">|</span> <span class="n">NAME</span>
<span class="c1">----------</span>
<span class="mi">1</span>  <span class="o">|</span> <span class="n">test1</span>
<span class="mi">2</span>  <span class="o">|</span> <span class="n">test2</span>
<span class="mi">3</span>  <span class="o">|</span> <span class="n">test3</span>
<span class="mi">4</span>  <span class="o">|</span> <span class="n">test4</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="查看-undo--roll-信息">查看 undo  roll 信息</h2>

<p>可以看到回滚段也会使用 system 表空间</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>
ora undo
INST_ID TABLESPACE_NAME      OWNER                SEGMENT_NAME                   STATUS      SIZE_M    EXTENTS    SHRINKS      WRAPS    OPTSIZE
<span class="nt">-------</span> <span class="nt">--------------------</span> <span class="nt">--------------------</span> <span class="nt">------------------------------</span> <span class="nt">-------</span> <span class="nt">----------</span> <span class="nt">----------</span> <span class="nt">----------</span> <span class="nt">----------</span> <span class="nt">----------</span>
        SYSTEM               SYS                  SYSTEM                         ONLINE           0          6          0          0
        UNDOTBS1             PUBLIC               _SYSSMU10_1197734989<span class="nv">$ </span>         ONLINE           2          4          1          9
        UNDOTBS1             PUBLIC               _SYSSMU1_3724004606<span class="nv">$ </span>          ONLINE           2          4          2          6
        UNDOTBS1             PUBLIC               _SYSSMU2_2996391332<span class="nv">$ </span>          ONLINE           1          3          3          5
        UNDOTBS1             PUBLIC               _SYSSMU3_1723003836<span class="nv">$ </span>          ONLINE           2          4          1          7
        UNDOTBS1             PUBLIC               _SYSSMU4_1254879796<span class="nv">$ </span>          ONLINE           1          3          2         14
        UNDOTBS1             PUBLIC               _SYSSMU5_898567397<span class="nv">$ </span>           ONLINE           2          4          2          6
        UNDOTBS1             PUBLIC               _SYSSMU6_1263032392<span class="nv">$ </span>          ONLINE           1          3          2          6
        UNDOTBS1             PUBLIC               _SYSSMU7_2070203016<span class="nv">$ </span>          ONLINE           1          3          2          6
        UNDOTBS1             PUBLIC               _SYSSMU8_517538920<span class="nv">$ </span>           ONLINE           2          4          2          9
        UNDOTBS1             PUBLIC               _SYSSMU9_1650507775<span class="nv">$ </span>          ONLINE           2          4          1          2
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">rollname</span><span class="p">;</span>
<span class="n">USN</span> <span class="o">|</span> <span class="n">NAME</span>
<span class="c1">---------------------------</span>
<span class="mi">0</span>   <span class="o">|</span> <span class="k">SYSTEM</span>
<span class="mi">1</span>   <span class="o">|</span> <span class="n">_SYSSMU1_3724004606</span><span class="err">$</span>
<span class="mi">2</span>   <span class="o">|</span> <span class="n">_SYSSMU2_2996391332</span><span class="err">$</span>
<span class="mi">3</span>   <span class="o">|</span> <span class="n">_SYSSMU3_1723003836</span><span class="err">$</span>
<span class="mi">4</span>   <span class="o">|</span> <span class="n">_SYSSMU4_1254879796</span><span class="err">$</span>
<span class="mi">5</span>   <span class="o">|</span> <span class="n">_SYSSMU5_898567397</span><span class="err">$</span>
<span class="mi">6</span>   <span class="o">|</span> <span class="n">_SYSSMU6_1263032392</span><span class="err">$</span>
<span class="mi">7</span>   <span class="o">|</span> <span class="n">_SYSSMU7_2070203016</span><span class="err">$</span>
<span class="mi">8</span>   <span class="o">|</span> <span class="n">_SYSSMU8_517538920</span><span class="err">$</span>
<span class="mi">9</span>   <span class="o">|</span> <span class="n">_SYSSMU9_1650507775</span><span class="err">$</span>
<span class="mi">10</span>  <span class="o">|</span> <span class="n">_SYSSMU10_1197734989</span><span class="err">$</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">rollstat</span><span class="p">;</span>
<span class="n">USN</span> <span class="o">|</span> <span class="n">LATCH</span> <span class="o">|</span> <span class="n">EXTENTS</span> <span class="o">|</span> <span class="n">RSSIZE</span>  <span class="o">|</span> <span class="n">WRITES</span>  <span class="o">|</span> <span class="n">XACTS</span> <span class="o">|</span> <span class="n">GETS</span> <span class="o">|</span> <span class="n">WAITS</span> <span class="o">|</span> <span class="n">OPTSIZE</span> <span class="o">|</span> <span class="n">HWMSIZE</span> <span class="o">|</span> <span class="n">SHRINKS</span> <span class="o">|</span> <span class="n">WRAPS</span> <span class="o">|</span> <span class="n">EXTENDS</span> <span class="o">|</span> <span class="n">AVESHRINK</span> <span class="o">|</span> <span class="n">AVEACTIVE</span> <span class="o">|</span> <span class="n">STATUS</span> <span class="o">|</span> <span class="n">CUREXT</span> <span class="o">|</span> <span class="n">CURBLK</span>
<span class="c1">-------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="mi">0</span>   <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="mi">6</span>       <span class="o">|</span> <span class="mi">385024</span>  <span class="o">|</span> <span class="mi">5400</span>    <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="mi">419</span>  <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="k">None</span>    <span class="o">|</span> <span class="mi">385024</span>  <span class="o">|</span> <span class="mi">0</span>       <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="mi">0</span>       <span class="o">|</span> <span class="mi">0</span>         <span class="o">|</span> <span class="mi">0</span>         <span class="o">|</span> <span class="n">ONLINE</span> <span class="o">|</span> <span class="mi">5</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="mi">1</span>   <span class="o">|</span> <span class="mi">1</span>     <span class="o">|</span> <span class="mi">4</span>       <span class="o">|</span> <span class="mi">2220032</span> <span class="o">|</span> <span class="mi">1298838</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="mi">2468</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="k">None</span>    <span class="o">|</span> <span class="mi">2220032</span> <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span> <span class="mi">6</span>     <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span> <span class="mi">1048576</span>   <span class="o">|</span> <span class="mi">185372</span>    <span class="o">|</span> <span class="n">ONLINE</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="mi">2</span>   <span class="o">|</span> <span class="mi">2</span>     <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">1171456</span> <span class="o">|</span> <span class="mi">1872382</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="mi">2526</span> <span class="o">|</span> <span class="mi">1</span>     <span class="o">|</span> <span class="k">None</span>    <span class="o">|</span> <span class="mi">2220032</span> <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">5</span>     <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span> <span class="mi">1048576</span>   <span class="o">|</span> <span class="mi">109964</span>    <span class="o">|</span> <span class="n">ONLINE</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">30</span>
<span class="mi">3</span>   <span class="o">|</span> <span class="mi">3</span>     <span class="o">|</span> <span class="mi">4</span>       <span class="o">|</span> <span class="mi">2220032</span> <span class="o">|</span> <span class="mi">2420158</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="mi">2741</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="k">None</span>    <span class="o">|</span> <span class="mi">3268608</span> <span class="o">|</span> <span class="mi">1</span>       <span class="o">|</span> <span class="mi">7</span>     <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span> <span class="mi">2097152</span>   <span class="o">|</span> <span class="mi">244860</span>    <span class="o">|</span> <span class="n">ONLINE</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">9</span>
<span class="mi">4</span>   <span class="o">|</span> <span class="mi">4</span>     <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">1171456</span> <span class="o">|</span> <span class="mi">7979976</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="mi">4603</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="k">None</span>    <span class="o">|</span> <span class="mi">8511488</span> <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span> <span class="mi">14</span>    <span class="o">|</span> <span class="mi">8</span>       <span class="o">|</span> <span class="mi">4194304</span>   <span class="o">|</span> <span class="mi">1254466</span>   <span class="o">|</span> <span class="n">ONLINE</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">76</span>
<span class="mi">5</span>   <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="mi">4</span>       <span class="o">|</span> <span class="mi">2220032</span> <span class="o">|</span> <span class="mi">1826452</span> <span class="o">|</span> <span class="mi">1</span>     <span class="o">|</span> <span class="mi">2476</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="k">None</span>    <span class="o">|</span> <span class="mi">3268608</span> <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span> <span class="mi">6</span>     <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span> <span class="mi">1572864</span>   <span class="o">|</span> <span class="mi">185372</span>    <span class="o">|</span> <span class="n">ONLINE</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">9</span>
<span class="mi">6</span>   <span class="o">|</span> <span class="mi">1</span>     <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">1171456</span> <span class="o">|</span> <span class="mi">3177522</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="mi">2899</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="k">None</span>    <span class="o">|</span> <span class="mi">4317184</span> <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span> <span class="mi">6</span>     <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">2097152</span>   <span class="o">|</span> <span class="mi">255496</span>    <span class="o">|</span> <span class="n">ONLINE</span> <span class="o">|</span> <span class="mi">1</span>      <span class="o">|</span> <span class="mi">7</span>
<span class="mi">7</span>   <span class="o">|</span> <span class="mi">2</span>     <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">1171456</span> <span class="o">|</span> <span class="mi">2252418</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="mi">2565</span> <span class="o">|</span> <span class="mi">1</span>     <span class="o">|</span> <span class="k">None</span>    <span class="o">|</span> <span class="mi">3268608</span> <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span> <span class="mi">6</span>     <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span> <span class="mi">1572864</span>   <span class="o">|</span> <span class="mi">173658</span>    <span class="o">|</span> <span class="n">ONLINE</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">27</span>
<span class="mi">8</span>   <span class="o">|</span> <span class="mi">3</span>     <span class="o">|</span> <span class="mi">4</span>       <span class="o">|</span> <span class="mi">2220032</span> <span class="o">|</span> <span class="mi">2260364</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="mi">2747</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="k">None</span>    <span class="o">|</span> <span class="mi">2220032</span> <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span> <span class="mi">9</span>     <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">1048576</span>   <span class="o">|</span> <span class="mi">252795</span>    <span class="o">|</span> <span class="n">ONLINE</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">46</span>
<span class="mi">9</span>   <span class="o">|</span> <span class="mi">4</span>     <span class="o">|</span> <span class="mi">4</span>       <span class="o">|</span> <span class="mi">2220032</span> <span class="o">|</span> <span class="mi">660772</span>  <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="mi">1363</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="k">None</span>    <span class="o">|</span> <span class="mi">2220032</span> <span class="o">|</span> <span class="mi">1</span>       <span class="o">|</span> <span class="mi">2</span>     <span class="o">|</span> <span class="mi">1</span>       <span class="o">|</span> <span class="mi">1048576</span>   <span class="o">|</span> <span class="mi">18267</span>     <span class="o">|</span> <span class="n">ONLINE</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">63</span>
<span class="mi">10</span>  <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="mi">4</span>       <span class="o">|</span> <span class="mi">2220032</span> <span class="o">|</span> <span class="mi">2146190</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="mi">2676</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span> <span class="k">None</span>    <span class="o">|</span> <span class="mi">2220032</span> <span class="o">|</span> <span class="mi">1</span>       <span class="o">|</span> <span class="mi">9</span>     <span class="o">|</span> <span class="mi">2</span>       <span class="o">|</span> <span class="mi">1048576</span>   <span class="o">|</span> <span class="mi">223628</span>    <span class="o">|</span> <span class="n">ONLINE</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">25</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">dba_extents</span> <span class="k">where</span> <span class="n">file_id</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">order</span> <span class="k">by</span> <span class="n">segment_name</span><span class="p">,</span> <span class="n">extent_id</span><span class="p">;</span>
<span class="k">OWNER</span> <span class="o">|</span> <span class="n">SEGMENT_NAME</span>          <span class="o">|</span> <span class="n">PARTITION_NAME</span> <span class="o">|</span> <span class="n">SEGMENT_TYPE</span> <span class="o">|</span> <span class="n">TABLESPACE_NAME</span> <span class="o">|</span> <span class="n">EXTENT_ID</span> <span class="o">|</span> <span class="n">FILE_ID</span> <span class="o">|</span> <span class="n">BLOCK_ID</span> <span class="o">|</span> <span class="n">BYTES</span>   <span class="o">|</span> <span class="n">BLOCKS</span> <span class="o">|</span> <span class="n">RELATIVE_FNO</span>
<span class="c1">--------------------------------------------------------------------------------------------------------------------------------------------------</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU10_1197734989</span><span class="err">$</span> <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">0</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">272</span>      <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU10_1197734989</span><span class="err">$</span> <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">1</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">5896</span>     <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU10_1197734989</span><span class="err">$</span> <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">2</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">512</span>      <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU10_1197734989</span><span class="err">$</span> <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">3</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">2304</span>     <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU1_3724004606</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">0</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">128</span>      <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU1_3724004606</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">1</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">5904</span>     <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU1_3724004606</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">2</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">1024</span>     <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU1_3724004606</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">3</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">1280</span>     <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU2_2996391332</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">0</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">144</span>      <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU2_2996391332</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">1</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">6088</span>     <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU2_2996391332</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">2</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">640</span>      <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU3_1723003836</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">0</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">160</span>      <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU3_1723003836</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">1</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">6056</span>     <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU3_1723003836</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">2</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">768</span>      <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU3_1723003836</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">3</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">2176</span>     <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU4_1254879796</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">0</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">176</span>      <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU4_1254879796</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">1</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">6064</span>     <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU4_1254879796</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">2</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">3712</span>     <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU5_898567397</span><span class="err">$</span>   <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">0</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">192</span>      <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU5_898567397</span><span class="err">$</span>   <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">1</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">200</span>      <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU5_898567397</span><span class="err">$</span>   <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">2</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">1152</span>     <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU5_898567397</span><span class="err">$</span>   <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">3</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">1792</span>     <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU6_1263032392</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">0</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">208</span>      <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU6_1263032392</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">1</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">216</span>      <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU6_1263032392</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">2</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">3968</span>     <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU7_2070203016</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">0</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">224</span>      <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU7_2070203016</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">1</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">232</span>      <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU7_2070203016</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">2</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">3840</span>     <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU8_517538920</span><span class="err">$</span>   <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">0</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">240</span>      <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU8_517538920</span><span class="err">$</span>   <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">1</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">5888</span>     <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU8_517538920</span><span class="err">$</span>   <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">2</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">384</span>      <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU8_517538920</span><span class="err">$</span>   <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">3</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">2560</span>     <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU9_1650507775</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">0</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">256</span>      <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU9_1650507775</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">1</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">264</span>      <span class="o">|</span> <span class="mi">65536</span>   <span class="o">|</span> <span class="mi">8</span>      <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU9_1650507775</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">2</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">4096</span>     <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>
<span class="n">SYS</span>   <span class="o">|</span> <span class="n">_SYSSMU9_1650507775</span><span class="err">$</span>  <span class="o">|</span> <span class="k">None</span>           <span class="o">|</span> <span class="n">TYPE2</span> <span class="n">UNDO</span>   <span class="o">|</span> <span class="n">UNDOTBS1</span>        <span class="o">|</span> <span class="mi">3</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">896</span>      <span class="o">|</span> <span class="mi">1048576</span> <span class="o">|</span> <span class="mi">128</span>    <span class="o">|</span> <span class="mi">3</span>


</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="对-system-表空间扩容">对 system 表空间扩容</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">alter</span> <span class="k">database</span> <span class="n">datafile</span> <span class="s1">'/oradata/darkdb/system01.dbf'</span> <span class="n">resize</span> <span class="mi">1</span><span class="k">G</span><span class="p">;</span>


<span class="c1">-- 扩容之后还是无法查询未提交的数据</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span>
<span class="o">*</span>
<span class="n">ERROR</span> <span class="k">at</span> <span class="n">line</span> <span class="mi">1</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01555</span><span class="p">:</span> <span class="n">snapshot</span> <span class="n">too</span> <span class="k">old</span><span class="p">:</span> <span class="k">rollback</span> <span class="n">segment</span> <span class="n">number</span> <span class="mi">0</span> <span class="k">with</span> <span class="n">name</span> <span class="nv">"SYSTEM"</span> <span class="n">too</span> <span class="n">small</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre>┌─[oracle@oracle11g]─[~]
└──╼ <span class="nv">$ </span>ora undo
SP2-0640: Not connected
SP2-0640: Not connected
Enter value <span class="k">for </span>_session:

Elapsed: 00:00:00.00

SESSION_INFO
<span class="nt">------------</span>
1523,29106

Elapsed: 00:00:00.01

INST_ID TABLESPACE_NAME      OWNER                SEGMENT_NAME                   STATUS      SIZE_M    EXTENTS    SHRINKS      WRAPS    OPTSIZE
<span class="nt">-------</span> <span class="nt">--------------------</span> <span class="nt">--------------------</span> <span class="nt">------------------------------</span> <span class="nt">-------</span> <span class="nt">----------</span> <span class="nt">----------</span> <span class="nt">----------</span> <span class="nt">----------</span> <span class="nt">----------</span>
        SYSTEM               SYS                  SYSTEM                         ONLINE           0          6          0          0 <span class="c">## 这里可以看出 size 还是为 0</span>
        UNDOTBS1             PUBLIC               _SYSSMU10_1197734989<span class="nv">$ </span>         ONLINE           2          4          1          9
        UNDOTBS1             PUBLIC               _SYSSMU1_3724004606<span class="nv">$ </span>          ONLINE           2          4          2          6
        UNDOTBS1             PUBLIC               _SYSSMU2_2996391332<span class="nv">$ </span>          ONLINE           1          3          3          5
        UNDOTBS1             PUBLIC               _SYSSMU3_1723003836<span class="nv">$ </span>          ONLINE           2          4          1          7
        UNDOTBS1             PUBLIC               _SYSSMU4_1254879796<span class="nv">$ </span>          ONLINE           1          3          2         14
        UNDOTBS1             PUBLIC               _SYSSMU5_898567397<span class="nv">$ </span>           ONLINE           2          4          2          6
        UNDOTBS1             PUBLIC               _SYSSMU6_1263032392<span class="nv">$ </span>          ONLINE           1          3          2          6
        UNDOTBS1             PUBLIC               _SYSSMU7_2070203016<span class="nv">$ </span>          ONLINE           1          3          2          6
        UNDOTBS1             PUBLIC               _SYSSMU8_517538920<span class="nv">$ </span>           ONLINE           2          4          2          9
        UNDOTBS1             PUBLIC               _SYSSMU9_1650507775<span class="nv">$ </span>          ONLINE           2          4          1          2


Elapsed: 00:00:00.11
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>后续在做测试验证 undo 和 system 的关系，这次先直接 rollback ，接着测试</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre></td><td class="rouge-code"><pre><span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">9</span><span class="p">,</span><span class="mi">12627</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">alter</span> <span class="k">database</span> <span class="n">datafile</span> <span class="s1">'/oradata/darkdb/system01.dbf'</span> <span class="n">resize</span> <span class="mi">2</span><span class="k">G</span><span class="p">;</span>

<span class="k">Database</span> <span class="n">altered</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">07</span><span class="p">.</span><span class="mi">74</span>

<span class="c1">-- session1 rollback</span>
<span class="k">rollback</span><span class="p">;</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span>
<span class="o">*</span>
<span class="n">ERROR</span> <span class="k">at</span> <span class="n">line</span> <span class="mi">1</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01555</span><span class="p">:</span> <span class="n">snapshot</span> <span class="n">too</span> <span class="k">old</span><span class="p">:</span> <span class="k">rollback</span> <span class="n">segment</span> <span class="n">number</span> <span class="mi">0</span> <span class="k">with</span> <span class="n">name</span> <span class="nv">"SYSTEM"</span> <span class="n">too</span> <span class="n">small</span>


<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">01</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span>
<span class="o">*</span>
<span class="n">ERROR</span> <span class="k">at</span> <span class="n">line</span> <span class="mi">1</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01555</span><span class="p">:</span> <span class="n">snapshot</span> <span class="n">too</span> <span class="k">old</span><span class="p">:</span> <span class="k">rollback</span> <span class="n">segment</span> <span class="n">number</span> <span class="mi">0</span> <span class="k">with</span> <span class="n">name</span> <span class="nv">"SYSTEM"</span> <span class="n">too</span> <span class="n">small</span>


<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span>
<span class="o">*</span>
<span class="n">ERROR</span> <span class="k">at</span> <span class="n">line</span> <span class="mi">1</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01555</span><span class="p">:</span> <span class="n">snapshot</span> <span class="n">too</span> <span class="k">old</span><span class="p">:</span> <span class="k">rollback</span> <span class="n">segment</span> <span class="n">number</span> <span class="mi">0</span> <span class="k">with</span> <span class="n">name</span> <span class="nv">"SYSTEM"</span> <span class="n">too</span> <span class="n">small</span>


<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span>
<span class="o">*</span>
<span class="n">ERROR</span> <span class="k">at</span> <span class="n">line</span> <span class="mi">1</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01555</span><span class="p">:</span> <span class="n">snapshot</span> <span class="n">too</span> <span class="k">old</span><span class="p">:</span> <span class="k">rollback</span> <span class="n">segment</span> <span class="n">number</span> <span class="mi">0</span> <span class="k">with</span> <span class="n">name</span> <span class="nv">"SYSTEM"</span> <span class="n">too</span> <span class="n">small</span>


<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">rollback</span><span class="p">;</span>

<span class="k">Rollback</span> <span class="n">complete</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">01</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>

        <span class="n">ID</span> <span class="n">NAME</span>
<span class="c1">---------- --------------------</span>
         <span class="mi">1</span> <span class="n">test1</span>
         <span class="mi">2</span> <span class="n">test2</span>
         <span class="mi">3</span> <span class="n">test3</span>
         <span class="mi">4</span> <span class="n">test4</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">update</span> <span class="n">test_undo</span> <span class="k">set</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'AAAA'</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="mi">1</span> <span class="k">row</span> <span class="n">updated</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span>
<span class="o">*</span>
<span class="n">ERROR</span> <span class="k">at</span> <span class="n">line</span> <span class="mi">1</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01555</span><span class="p">:</span> <span class="n">snapshot</span> <span class="n">too</span> <span class="k">old</span><span class="p">:</span> <span class="k">rollback</span> <span class="n">segment</span> <span class="n">number</span> <span class="mi">0</span> <span class="k">with</span> <span class="n">name</span> <span class="nv">"SYSTEM"</span> <span class="n">too</span> <span class="n">small</span>


<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">01</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">rollback</span><span class="p">;</span>

<span class="k">Rollback</span> <span class="n">complete</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">01</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>

        <span class="n">ID</span> <span class="n">NAME</span>
<span class="c1">---------- --------------------</span>
         <span class="mi">1</span> <span class="n">test1</span>
         <span class="mi">2</span> <span class="n">test2</span>
         <span class="mi">3</span> <span class="n">test3</span>
         <span class="mi">4</span> <span class="n">test4</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">update</span> <span class="n">test_undo</span> <span class="k">set</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'AAAA'</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="mi">1</span> <span class="k">row</span> <span class="n">updated</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span>
<span class="o">*</span>
<span class="n">ERROR</span> <span class="k">at</span> <span class="n">line</span> <span class="mi">1</span><span class="p">:</span>
<span class="n">ORA</span><span class="o">-</span><span class="mi">01555</span><span class="p">:</span> <span class="n">snapshot</span> <span class="n">too</span> <span class="k">old</span><span class="p">:</span> <span class="k">rollback</span> <span class="n">segment</span> <span class="n">number</span> <span class="mi">0</span> <span class="k">with</span> <span class="n">name</span> <span class="nv">"SYSTEM"</span> <span class="n">too</span> <span class="n">small</span>


<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">12573</span> <span class="k">SQL</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="rollback-重新测试">rollback 重新测试</h3>

<p>尝试继续扩大 system 也不行，rollback 之后退出当前 session1 新开 session 测试</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
</pre></td><td class="rouge-code"><pre>┌─[oracle@oracle11g]─[~]
└──╼ <span class="nv">$ </span>swxj

SQL<span class="k">*</span>Plus: Release 11.2.0.4.0 Production on Fri Mar 21 14:58:25 2025

Copyright <span class="o">(</span>c<span class="o">)</span> 1982, 2013, Oracle.  All rights reserved.


Connected to:
Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options


Session altered.

Elapsed: 00:00:00.00

SESSION_INFO
<span class="nt">------------</span>
2269,29552

Elapsed: 00:00:00.01
WXJ@darkdb 2269,29552 SQL&gt; <span class="k">select</span> <span class="k">*</span> from test_undo<span class="p">;</span>

        ID NAME
<span class="nt">----------</span> <span class="nt">--------------------</span>
         1 test1
         2 test2
         3 test3
         4 test4

Elapsed: 00:00:00.00
WXJ@darkdb 2269,29552 SQL&gt; update test_undo <span class="nb">set </span>name <span class="o">=</span> <span class="s1">'AAAA'</span> where <span class="nb">id</span> <span class="o">=</span> 3<span class="p">;</span>

1 row updated.

Elapsed: 00:00:00.01
WXJ@darkdb 2269,29552 SQL&gt; <span class="k">select</span> <span class="k">*</span> from test_undo<span class="p">;</span>
<span class="k">select</span> <span class="k">*</span> from test_undo
<span class="k">*</span>
ERROR at line 1:
ORA-01555: snapshot too old: rollback segment number 0 with name <span class="s2">"SYSTEM"</span> too small


Elapsed: 00:00:00.01
WXJ@darkdb 2269,29552 SQL&gt; rollback<span class="p">;</span>

Rollback complete.

Elapsed: 00:00:00.01
WXJ@darkdb 2269,29552 SQL&gt; alter system flush buffer_cache<span class="p">;</span>

System altered.

Elapsed: 00:00:00.06
WXJ@darkdb 2269,29552 SQL&gt; update test_undo <span class="nb">set </span>name <span class="o">=</span> <span class="s1">'AAAA'</span> where <span class="nb">id</span> <span class="o">=</span> 3<span class="p">;</span>

1 row updated.

Elapsed: 00:00:00.01
WXJ@darkdb 2269,29552 SQL&gt; <span class="k">select</span> <span class="k">*</span> from test_undo<span class="p">;</span>
<span class="k">select</span> <span class="k">*</span> from test_undo
<span class="k">*</span>
ERROR at line 1:
ORA-01555: snapshot too old: rollback segment number 0 with name <span class="s2">"SYSTEM"</span> too small


Elapsed: 00:00:00.01
WXJ@darkdb 2269,29552 SQL&gt; commit<span class="p">;</span>

Commit complete.

Elapsed: 00:00:00.01
WXJ@darkdb 2269,29552 SQL&gt; <span class="k">select</span> <span class="k">*</span> from test_undo<span class="p">;</span>

        ID NAME
<span class="nt">----------</span> <span class="nt">--------------------</span>
         1 test1
         2 test2
         3 AAAA
         4 test4

Elapsed: 00:00:00.00
WXJ@darkdb 2269,29552 SQL&gt; update test_undo <span class="nb">set </span>name <span class="o">=</span> <span class="s1">'BBBBB'</span> where <span class="nb">id</span> <span class="o">=</span> 3<span class="p">;</span>
update test_undo <span class="nb">set </span>name <span class="o">=</span> <span class="s1">'BBBBB'</span> where <span class="nb">id</span> <span class="o">=</span> 3
       <span class="k">*</span>
ERROR at line 1:
ORA-00600: internal error code, arguments: <span class="o">[</span>ktbdchk1: bad dscn], <span class="o">[]</span>, <span class="o">[]</span>, <span class="o">[]</span>, <span class="o">[]</span>, <span class="o">[]</span>, <span class="o">[]</span>, <span class="o">[]</span>, <span class="o">[]</span>, <span class="o">[]</span>, <span class="o">[]</span>, <span class="o">[]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="处理-ora-00600-错误">处理 ORA-00600 错误</h3>

<p><strong>出现了 ORA-00600 错误，根据 bad dscn 提示，可以推断出刚才的 Itl Flag 和 Scn 修改有关，尝试回退修改，不过这里也能看出 ORA-01555 需要重新连接才行</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
</pre></td><td class="rouge-code"><pre>show all

modify /x 00000000 offset 84
modify /x 00000000 offset 88

BBED&gt; show all
        FILE#           5
        BLOCK#          150
        OFFSET          0
        DBA             0x01400096 <span class="o">(</span>20971670 5,150<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Edit
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           200
        LOGFILE         log.bbd
        SPOOL           No

BBED&gt; modify /x 00000000 offset 84
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   84 to  283           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 00000000 a0182200 00000000 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000
 04004e1f 801f741f 681f0000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

BBED&gt; modify /x 00000000 offset 88
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   88 to  287           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 00000000 00000000 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f
 801f741f 681f0000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

BBED&gt; <span class="nb">set </span>block 150
        BLOCK#          150

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to  199           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 52862100 00000104 614f0000 01000000 32770100 b6482100
 00000000 02003200 90004001 03001a00 540f0000 cd09c000 df001f00 00800000
 a0182100 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

BBED&gt;
Elapsed: 00:00:00.12
WXJ@darkdb 9,12627 SQL&gt; alter system flush buffer_cache<span class="p">;</span>

System altered.

Elapsed: 00:00:00.05
WXJ@darkdb 9,12627 SQL&gt; alter system checkpoint<span class="p">;</span>

System altered.

Elapsed: 00:00:00.03
WXJ@darkdb 9,12627 SQL&gt;  <span class="k">select</span> <span class="k">*</span> from test_undo<span class="p">;</span>
 <span class="k">select</span> <span class="k">*</span> from test_undo
               <span class="k">*</span>
ERROR at line 1:
ORA-01578: ORACLE data block corrupted <span class="o">(</span>file <span class="c"># 5, block # 150)</span>
ORA-01110: data file 5: <span class="s1">'/oradata/darkdb/data01.dbf'</span>

WXJ@darkdb 2269,29552 SQL&gt;
WXJ@darkdb 2269,29552 SQL&gt;
WXJ@darkdb 2269,29552 SQL&gt; <span class="k">select</span> <span class="k">*</span> from test_undo<span class="p">;</span>
<span class="k">select</span> <span class="k">*</span> from test_undo
<span class="k">*</span>
ERROR at line 1:
ORA-01578: ORACLE data block corrupted <span class="o">(</span>file <span class="c"># 5, block # 150)</span>
ORA-01110: data file 5: <span class="s1">'/oradata/darkdb/data01.dbf'</span>


Elapsed: 00:00:00.48
WXJ@darkdb 2269,29552 SQL&gt;

<span class="c">## 忘记修改校验和🤣</span>

<span class="nb">sum </span>apply
BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to  199           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 52862100 00000104 614f0000 01000000 32770100 b6482100
 00000000 02003200 90004001 03001a00 540f0000 cd09c000 df001f00 00800000
 a0182100 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;
BBED&gt; <span class="nb">sum </span>apply
Check value <span class="k">for </span>File 5, Block 150:
current <span class="o">=</span> 0xd7e3, required <span class="o">=</span> 0xd7e3

BBED&gt; <span class="nb">set </span>offset 80
        OFFSET          80

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   80 to  279           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 00000000 00000000 00000000 00000000 00000000 00010400 ffff1a00 4e1f4e1f
 4e1f0000 04004e1f 801f741f 681f0000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

BBED&gt; <span class="nb">set </span>offset 0
        OFFSET          0

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to  199           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 52862100 00000104 e3d70000 01000000 32770100 b6482100
 00000000 02003200 90004001 03001a00 540f0000 cd09c000 df001f00 00800000
 a0182100 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

WXJ@darkdb 9,12627 SQL&gt; alter system flush buffer_cache<span class="p">;</span>

System altered.

Elapsed: 00:00:00.03
WXJ@darkdb 9,12627 SQL&gt; alter system checkpoint<span class="p">;</span>

System altered.

Elapsed: 00:00:00.03
WXJ@darkdb 9,12627 SQL&gt;

<span class="c">## 修改之后可以接着做测试了。做个测试一波三折😂</span>
WXJ@darkdb 2269,29552 SQL&gt; <span class="k">select</span> <span class="k">*</span> from test_undo<span class="p">;</span>

        ID NAME
<span class="nt">----------</span> <span class="nt">--------------------</span>
         1 test1
         2 test2
         3 test3
         4 test4

Elapsed: 00:00:00.00
WXJ@darkdb 2269,29552 SQL&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="接着测试">接着测试</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">update</span> <span class="n">test_undo</span> <span class="k">set</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'BBBBB'</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">29552</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_relative_fno</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">file_id</span><span class="p">,</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_block_number</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">block_id</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>

   <span class="n">FILE_ID</span>   <span class="n">BLOCK_ID</span>         <span class="n">ID</span> <span class="n">NAME</span>
<span class="c1">---------- ---------- ---------- --------------------</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">1</span> <span class="n">test1</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">2</span> <span class="n">test2</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">3</span> <span class="n">BBBBB</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">4</span> <span class="n">test4</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>接着 block 150</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="rouge-code"><pre>BBED&gt; show all
        FILE#           5
        BLOCK#          150
        OFFSET          0
        DBA             0x01400096 <span class="o">(</span>20971670 5,150<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Edit
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           200
        LOGFILE         log.bbd
        SPOOL           No

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to  199           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 52862100 00000104 e3d70000 01000000 32770100 b6482100
 00000000 02003200 90004001 03001a00 540f0000 cd09c000 df001f00 00800000
 a0182100 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;


<span class="c">## 查看尾部数据</span>

<span class="k">select </span>dump<span class="o">(</span><span class="nb">id</span>,16<span class="o">)</span>, dump<span class="o">(</span>name,16<span class="o">)</span>, <span class="nb">id</span>, name from test_undo where <span class="nb">id</span> <span class="o">=</span> 3<span class="p">;</span>
DUMP<span class="o">(</span>ID,16<span class="o">)</span>       | DUMP<span class="o">(</span>NAME,16<span class="o">)</span>               | ID | NAME
<span class="nt">------------------------------------------------------------</span>
<span class="nv">Typ</span><span class="o">=</span>2 <span class="nv">Len</span><span class="o">=</span>2: c1,4 | <span class="nv">Typ</span><span class="o">=</span>1 <span class="nv">Len</span><span class="o">=</span>5: 74,65,73,74,33 | 3  | test3

<span class="k">select </span>dump<span class="o">(</span>3,16<span class="o">)</span>,dump<span class="o">(</span><span class="s1">'BBBBB'</span>,16<span class="o">)</span> from dual<span class="p">;</span>
DUMP<span class="o">(</span>3,16<span class="o">)</span>        | DUMP<span class="o">(</span><span class="s1">'BBBBB'</span>,16<span class="o">)</span>
<span class="nt">------------------------------------------------</span>
<span class="nv">Typ</span><span class="o">=</span>2 <span class="nv">Len</span><span class="o">=</span>2: c1,4 | <span class="nv">Typ</span><span class="o">=</span>96 <span class="nv">Len</span><span class="o">=</span>5: 42,42,42,42,42

BBED&gt; <span class="nb">set </span>offset 8000
        OFFSET          8000

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets: 8000 to 8191           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00002c00 0202c102 05746573 74312c02
 0202c102 07746573 74312d31 2c000202 c1050574 65737434 2c000202 c1040574
 65737433 2c000202 c1030574 65737432 2c000202 c1020574 65737431 01065286

 &lt;32 bytes per line&gt;

</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="dump-trace">dump trace</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">9</span><span class="p">,</span><span class="mi">31450</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">alter</span> <span class="k">system</span> <span class="n">dump</span> <span class="n">datafile</span> <span class="mi">5</span> <span class="n">block</span> <span class="mi">150</span><span class="p">;</span>

<span class="k">System</span> <span class="n">altered</span><span class="p">.</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">01</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">9</span><span class="p">,</span><span class="mi">31450</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">tracefile</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">process</span> <span class="k">where</span> <span class="n">addr</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">paddr</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="k">session</span> <span class="k">where</span> <span class="n">sid</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">sid</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">mystat</span><span class="p">));</span>

<span class="n">TRACEFILE</span>
<span class="c1">----------------------------------------------------------------------------------------------------</span>
<span class="o">/</span><span class="n">u01</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">oracle</span><span class="o">/</span><span class="n">diag</span><span class="o">/</span><span class="n">rdbms</span><span class="o">/</span><span class="n">darkdb</span><span class="o">/</span><span class="n">darkdb</span><span class="o">/</span><span class="n">trace</span><span class="o">/</span><span class="n">darkdb_ora_31450</span><span class="p">.</span><span class="n">trc</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">03</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">9</span><span class="p">,</span><span class="mi">31450</span> <span class="k">SQL</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre>
 buffer tsn: 6 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span>
 scn: 0x0000.0021c1b3 <span class="nb">seq</span>: 0x01 flg: 0x04 <span class="nb">tail</span>: 0xc1b30601
 frmt: 0x02 chkval: 0x2e1e <span class="nb">type</span>: <span class="nv">0x06</span><span class="o">=</span>trans data
 Hex dump of block: <span class="nv">st</span><span class="o">=</span>0, <span class="nv">typ_found</span><span class="o">=</span>1
 Dump of memory from 0x00007F6ACC81AA00 to 0x00007F6ACC81CA00 <span class="c">## 从这里的描述信息 dump of memory 可以看出这是内存中的数据，所以上面 bbed 查看磁盘上的 block 的信息没有修改后的数据</span>
 7F6ACC81AA00 0000A206 01400096 0021C1B3 04010000  <span class="o">[</span>......@...!.....]
 7F6ACC81AA10 00002E1E 00000001 00017732 0021C1B3  <span class="o">[</span>........2w....!.]
 7F6ACC81AA20 00000000 00320002 01400090 001A0003  <span class="o">[</span>......2...@.....]
 7F6ACC81AA30 00000F54 00C009CD 001F00DF 00008000  <span class="o">[</span>T...............]
 7F6ACC81AA40 002118A0 00140007 00000BDC 00C00F2F  <span class="o">[</span>..!........./...]
 7F6ACC81AA50 001300DB 00000001 00000000 00000000  <span class="o">[</span>................]
 7F6ACC81AA60 00000000 00040100 001AFFFF 1F4E1F4E  <span class="o">[</span>............N.N.]
 7F6ACC81AA70 00001F4E 1F4E0004 1F741F80 00001F68  <span class="o">[</span>N.....N...t.h...]
 7F6ACC81AA80 00000000 00000000 00000000 00000000  <span class="o">[</span>................]
         Repeat 498 <span class="nb">times
 </span>7F6ACC81C9B0 002C0000 02C10202 73657405 022C3174  <span class="o">[</span>..,......test1,.]
 7F6ACC81C9C0 02C10202 73657407 312D3174 0202002C  <span class="o">[</span>.....test1-1,...] <span class="c">## 上一次修改未提交被回滚的数据</span>
 7F6ACC81C9D0 740505C1 34747365 0202022C 420504C1  <span class="o">[</span>...test4,......B]
 7F6ACC81C9E0 42424242 0202002C 740503C1 32747365  <span class="o">[</span>BBBB,......test2] <span class="c">## 本次修改还未提交的数据</span>
 7F6ACC81C9F0 0202002C 740502C1 31747365 C1B30601  <span class="o">[</span>,......test1....]
 Block header dump:  0x01400096
  Object <span class="nb">id </span>on Block? Y
  seg/obj: 0x17732  csc: 0x00.21c1b3  itc: 2  flg: E  typ: 1 - DATA
      brn: 0  bdba: 0x1400090 ver: 0x01 opc: 0
      inc: 0  exflg: 0
 <span class="nb">.</span>
  Itl           Xid                  Uba         Flag  Lck        Scn/Fsc
 0x01   0x0003.01a.00000f54  0x00c009cd.00df.1f  C---    0  scn 0x0000.002118a0
 0x02   0x0007.014.00000bdc  0x00c00f2f.00db.13  <span class="nt">----</span>    1  fsc 0x0000.00000000 <span class="c">## 修改 Flag Scn</span>
 bdba: 0x01400096
 data_block_dump,data header at 0x7f6acc81aa64
 <span class="o">===============</span>
 tsiz: 0x1f98
 hsiz: 0x1a
 pbl: 0x7f6acc81aa64
      76543210
 <span class="nv">flag</span><span class="o">=</span><span class="nt">--------</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="bbed-修改-itl">bbed 修改 Itl</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="rouge-code"><pre><span class="nb">set </span>offset 0

2f0fc000db0013
BBED&gt; <span class="nb">set </span>offset 0
        OFFSET          0

BBED&gt; find /x 2f0fc000db0013
BBED-00209: invalid number <span class="o">(</span>2f0fc000db0013<span class="o">)</span>


BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to  199           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 52862100 00000104 e3d70000 01000000 32770100 b6482100
 00000000 02003200 90004001 <span class="o">[</span>03001a00 540f0000 cd09c000 df001f00 00800000 <span class="c"># 一个 Itl 占用 4*6+2 = 26 个字节</span>
 a0182100 0000][0000 00000000 00000000 00000000 00000000 00000000 00000000] <span class="c"># 这里不知道什么 Itl 0x02 没有找到，可能和我之前的一些操作有关，直接尝试构造整个 Itl 试试</span>
 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

BBED&gt; <span class="nb">set </span>count 300
        COUNT           300

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to  299           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 52862100 00000104 e3d70000 01000000 32770100 b6482100
 00000000 02003200 90004001 03001a00 540f0000 cd09c000 df001f00 00800000
 a0182100 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000

 &lt;32 bytes per line&gt;

BBED&gt;
BBED&gt; find /x db0013
BBED-00212: search string not found


BBED&gt; find /x db00
BBED-00212: search string not found


BBED&gt;

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="bbed-构造-itl">bbed 构造 Itl</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre>
 <span class="c">#  Itl           Xid                  Uba         Flag  Lck        Scn/Fsc</span>
 <span class="c"># 0x01   0x0003.01a.00000f54  0x00c009cd.00df.1f  C---    0  scn 0x0000.002118a0</span>
 <span class="c"># 0x02   0x0007.014.00000bdc  0x00c00f2f.00db.13  ----    1  fsc 0x0000.00000000 ## 修改 Flag Scn</span>

<span class="c"># 根据 Itl 0x01 定位 0x02</span>
BBED&gt;  find /x 03001a00
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   44 to  343           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
<span class="o">[</span>03001a00 540f0000 cd09c000 df001f00 00800000 a0182100 0000][0000 00000000
 00000000 00000000 00000000 00000000 00000000] 00000000 00010400 ffff1a00
 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000

 &lt;32 bytes per line&gt;

 <span class="k">select </span>dump<span class="o">(</span>3,16<span class="o">)</span>,dump<span class="o">(</span><span class="s1">'BBBBB'</span>,16<span class="o">)</span> from dual<span class="p">;</span>
DUMP<span class="o">(</span>3,16<span class="o">)</span>        | DUMP<span class="o">(</span><span class="s1">'BBBBB'</span>,16<span class="o">)</span>
<span class="nt">------------------------------------------------</span>
<span class="nv">Typ</span><span class="o">=</span>2 <span class="nv">Len</span><span class="o">=</span>2: c1,4 | <span class="nv">Typ</span><span class="o">=</span>96 <span class="nv">Len</span><span class="o">=</span>5: 42,42,42,42,42

<span class="nb">set </span>offset 0

BBED&gt; find /x 4242
BBED-00212: search string not found
</pre></td></tr></tbody></table></code></pre></div></div>

<p>发现 block 150 中没有 Itl 0x02 和 对应的数据，尝试 rollback 重启实例之后在进行测试</p>

<h2 id="重启实例测试">重启实例测试</h2>

<h3 id="dump-block-150">dump block 150</h3>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre><span class="c1">-- 原始数据</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="n">ID</span> <span class="o">|</span> <span class="n">NAME</span>
<span class="c1">----------</span>
<span class="mi">1</span>  <span class="o">|</span> <span class="n">test1</span>
<span class="mi">2</span>  <span class="o">|</span> <span class="n">test2</span>
<span class="mi">3</span>  <span class="o">|</span> <span class="n">BBBBB</span>
<span class="mi">4</span>  <span class="o">|</span> <span class="n">test4</span>

<span class="c1">-- session1 修改数据</span>
<span class="k">update</span> <span class="n">test_undo</span> <span class="k">set</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'CCCCC'</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">3403</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_relative_fno</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">file_id</span><span class="p">,</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_block_number</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">block_id</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>

   <span class="n">FILE_ID</span>   <span class="n">BLOCK_ID</span>         <span class="n">ID</span> <span class="n">NAME</span>
<span class="c1">---------- ---------- ---------- --------------------</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">1</span> <span class="n">test1</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">2</span> <span class="n">test2</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">3</span> <span class="n">BBBBB</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">4</span> <span class="n">CCCCC</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">02</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">3403</span> <span class="k">SQL</span><span class="o">&gt;</span>

<span class="c1">-- 其他 session dump block 150</span>
<span class="k">alter</span> <span class="k">system</span> <span class="n">dump</span> <span class="n">datafile</span> <span class="mi">5</span> <span class="n">block</span> <span class="mi">150</span><span class="p">;</span>
<span class="k">select</span> <span class="n">tracefile</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">process</span> <span class="k">where</span> <span class="n">addr</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">paddr</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="k">session</span> <span class="k">where</span> <span class="n">sid</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">sid</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">mystat</span><span class="p">));</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
</pre></td><td class="rouge-code"><pre>┌─[oracle@oracle11g]─[~]
└──╼ <span class="nv">$ </span>vim <span class="nt">-R</span> /u01/app/oracle/diag/rdbms/darkdb/darkdb/trace/darkdb_ora_3634.trc
┌─[oracle@oracle11g]─[~]
└──╼ <span class="err">$</span>
┌─[oracle@oracle11g]─[~]
└──╼ <span class="err">$</span>
┌─[oracle@oracle11g]─[~]
└──╼ <span class="nv">$ </span><span class="nb">cat</span> /u01/app/oracle/diag/rdbms/darkdb/darkdb/trace/darkdb_ora_3634.trc
Trace file /u01/app/oracle/diag/rdbms/darkdb/darkdb/trace/darkdb_ora_3634.trc
Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options
ORACLE_HOME <span class="o">=</span> /u01/app/oracle/product/11.2.0/db
System name:    Linux
Node name:      oracle11g
Release:        5.4.17-2102.201.3.el7uek.x86_64
Version:        <span class="c">#2 SMP Fri Apr 23 09:05:55 PDT 2021</span>
Machine:        x86_64
Instance name: darkdb
Redo thread mounted by this instance: 1
Oracle process number: 25
Unix process pid: 3634, image: oracle@oracle11g <span class="o">(</span>TNS V1-V3<span class="o">)</span>


<span class="k">***</span> 2025-03-23 09:00:50.301
<span class="k">***</span> SESSION ID:<span class="o">(</span>764.11<span class="o">)</span> 2025-03-23 09:00:50.301
<span class="k">***</span> CLIENT ID:<span class="o">()</span> 2025-03-23 09:00:50.301
<span class="k">***</span> SERVICE NAME:<span class="o">(</span>SYS<span class="nv">$USERS</span><span class="o">)</span> 2025-03-23 09:00:50.301
<span class="k">***</span> MODULE NAME:<span class="o">(</span>SQL<span class="k">*</span>Plus<span class="o">)</span> 2025-03-23 09:00:50.301
<span class="k">***</span> ACTION NAME:<span class="o">()</span> 2025-03-23 09:00:50.301

Start dump data blocks tsn: 6 file#:5 minblk 150 maxblk 150
Block dump from cache:
Dump of buffer cache at level 4 <span class="k">for </span><span class="nv">tsn</span><span class="o">=</span>6 <span class="nv">rdba</span><span class="o">=</span>20971670
BH <span class="o">(</span>0x15efac5e8<span class="o">)</span> file#: 5 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span> class: 1 ba: 0x15e76e000
  <span class="nb">set</span>: 9 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 117,28
  dbwrid: 0 obj: 96050 objn: 96050 tsn: 6 afn: 5 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x160ff8f78,0x189ebd620] lru: <span class="o">[</span>0x15efac810,0x15efac5a0]
  obj-flags: object_ckpt_list
  ckptq: <span class="o">[</span>0x131ff7798,0x1873443e0] fileq: <span class="o">[</span>0x187344480,0x187344480] objq: <span class="o">[</span>0x177f27a78,0x177f27a78] objaq: <span class="o">[</span>0x160ff9120,0x177f27a58]
  st: XCURRENT md: NULL fpin: <span class="s1">'kdswh01: kdstgr'</span> tch: 3
  flags: buffer_dirty redo_since_read
  LRBA: <span class="o">[</span>0x6.77fd4.0] LSCN: <span class="o">[</span>0x0.21f81c] HSCN: <span class="o">[</span>0x0.21f81c] HSUB: <span class="o">[</span>1]
BH <span class="o">(</span>0x160ff8ec0<span class="o">)</span> file#: 5 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span> class: 1 ba: 0x160f48000
  <span class="nb">set</span>: 9 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 117,28
  dbwrid: 0 obj: 96050 objn: 96050 tsn: 6 afn: 5 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x189ebd620,0x15efac6a0] lru: <span class="o">[</span>0x130f89770,0x131ff1e58]
  lru-flags: moved_to_tail
  ckptq: <span class="o">[</span>NULL] fileq: <span class="o">[</span>NULL] objq: <span class="o">[</span>NULL] objaq: <span class="o">[</span>NULL]
  st: CR md: NULL fpin: <span class="s1">'kdswh01: kdstgr'</span> tch: 2
  cr: <span class="o">[</span>scn: 0x0.21f7e7],[xid: 0xfffe.ffff.0],[uba: 0x0.0.0],[cls: 0x0.21f7e7],[sfl: 0x1],[lc: 0x0.21f1c8]
  flags: only_sequential_access
Block dump from disk:
buffer tsn: 6 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span>
scn: 0x0000.0021f1c8 <span class="nb">seq</span>: 0x01 flg: 0x06 <span class="nb">tail</span>: 0xf1c80601
frmt: 0x02 chkval: 0xd47f <span class="nb">type</span>: <span class="nv">0x06</span><span class="o">=</span>trans data
Hex dump of block: <span class="nv">st</span><span class="o">=</span>0, <span class="nv">typ_found</span><span class="o">=</span>1
Dump of memory from 0x00007F8EEBF41A00 to 0x00007F8EEBF43A00
7F8EEBF41A00 0000A206 01400096 0021F1C8 06010000  <span class="o">[</span>......@...!.....]
7F8EEBF41A10 0000D47F 00000001 00017732 0021E83B  <span class="o">[</span>........2w..<span class="p">;</span>.!.]
7F8EEBF41A20 00000000 00320002 01400090 001A0003  <span class="o">[</span>......2...@.....]
7F8EEBF41A30 00000F54 00C009CD 001F00DF 00008000  <span class="o">[</span>T...............]
7F8EEBF41A40 002118A0 00140007 00000BDC 00C00F2F  <span class="o">[</span>..!........./...]
7F8EEBF41A50 001300DB 00002001 0021F1C8 00000000  <span class="o">[</span>..... ....!.....]
7F8EEBF41A60 00000000 00040100 001AFFFF 1F4E1F4E  <span class="o">[</span>............N.N.]
7F8EEBF41A70 00001F4E 1F4E0004 1F741F80 00001F68  <span class="o">[</span>N.....N...t.h...]
7F8EEBF41A80 00000000 00000000 00000000 00000000  <span class="o">[</span>................]
        Repeat 498 <span class="nb">times
</span>7F8EEBF439B0 002C0000 02C10202 73657405 022C3174  <span class="o">[</span>..,......test1,.]
7F8EEBF439C0 02C10202 73657407 312D3174 0202002C  <span class="o">[</span>.....test1-1,...]
7F8EEBF439D0 740505C1 34747365 0202022C 420504C1  <span class="o">[</span>...test4,......B]
7F8EEBF439E0 42424242 0202002C 740503C1 32747365  <span class="o">[</span>BBBB,......test2]
7F8EEBF439F0 0202002C 740502C1 31747365 F1C80601  <span class="o">[</span>,......test1....] <span class="c">## 这里还看不到第四行修改的 CCCCC</span>
Block header dump:  0x01400096
 Object <span class="nb">id </span>on Block? Y
 seg/obj: 0x17732  csc: 0x00.21e83b  itc: 2  flg: E  typ: 1 - DATA
     brn: 0  bdba: 0x1400090 ver: 0x01 opc: 0
     inc: 0  exflg: 0

 Itl           Xid                  Uba         Flag  Lck        Scn/Fsc
0x01   0x0003.01a.00000f54  0x00c009cd.00df.1f  C---    0  scn 0x0000.002118a0
0x02   0x0007.014.00000bdc  0x00c00f2f.00db.13  <span class="nt">--U-</span>    1  fsc 0x0000.0021f1c8 <span class="c">## 这次 Flag 的标志不是 ----</span>
bdba: 0x01400096
data_block_dump,data header at 0x7f8eebf41a64
<span class="o">===============</span>
<span class="c">## E:/BaiduSyncdisk/MyselfBase/blog_file/oracle%E6%95%B0%E6%8D%AE%E5%9D%97%E4%B8%AD%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%EF%BC%88%E6%91%98%E5%BD%95%EF%BC%89_ITPUB%E5%8D%9A%E5%AE%A2.html</span>
tsiz: 0x1f98 <span class="c">## 十进制 8088 ## Total data area size： 8k 的 block: 8192-20(block head)-24(Transaction Header)-24*2（一个事务条）-4(block tail)=8096(0x1fa0) --事物列表可能大于 2</span>
hsiz: 0x1a <span class="c">##   --data head size</span>
pbl: 0x7f8eebf41a64 <span class="c">## Pointer to buffer holding the block</span>
     76543210
<span class="nv">flag</span><span class="o">=</span><span class="nt">--------</span>
<span class="nv">ntab</span><span class="o">=</span>1 <span class="c">## 表示存放一张表的数据，当存放 cluster 时，可能出现 ntab &gt; 1</span>
<span class="nv">nrow</span><span class="o">=</span>4 <span class="c">## 表示现在该 block 内有 4 行数据</span>
<span class="nv">frre</span><span class="o">=</span><span class="nt">-1</span>
<span class="nv">fsbo</span><span class="o">=</span>0x1a <span class="c">## 表示可以放数据的空间的起始位置（发现该值和 hsiz 保持一至），只是表示从这个位置之后的空间都可以存放业务数据</span>
<span class="nv">fseo</span><span class="o">=</span>0x1f4e <span class="c">## 表示可以存放数据的 end 位置：8014 ， Oracle 是从尾部开始存储数据的，所以 fseo 位置其实是业务数据的开始位置</span>
<span class="nv">avsp</span><span class="o">=</span>0x1f4e
<span class="nv">tosp</span><span class="o">=</span>0x1f4e
0xe:pti[0]      <span class="nv">nrow</span><span class="o">=</span>4  <span class="nv">offs</span><span class="o">=</span>0
0x12:pri[0]     <span class="nv">offs</span><span class="o">=</span>0x1f4e <span class="c">## 0x1f4e = 8014  != 0x1f80 + tl : 12 = 8064 + 12 = 8076 = 0x1f8c ##  这里第一行的数据在尾部 fseo 的位置，是因为之前第一行的数据发生了修改，提交之后数据保存在了 block 的尾部</span>
0x14:pri[1]     <span class="nv">offs</span><span class="o">=</span>0x1f80 <span class="c">## 0x1f74 + tl : 12 = 8052 + 12 = 8064 = 0x1f80</span>
0x16:pri[2]     <span class="nv">offs</span><span class="o">=</span>0x1f74 <span class="c">## 0x1f68 + tl : 12 = 8040 + 12 = 8052 = 0x1f74</span>
0x18:pri[3]     <span class="nv">offs</span><span class="o">=</span>0x1f68 <span class="c">## fseo: 0x1f4e + tl: 12  = 8026 = 8014 + 12 = 0x1f5a != 0x1f68 这里数据对不上，有可能是因为本次测试修改的数据就是第四行数据，本来是在 block 尾部的，但是因为修改所以位置变了，而且此时还未提交数据，等试验结束提交之后再次检查</span>
block_row_dump:
tab 0, row 0, @0x1f4e
tl: 12 fb: <span class="nt">--H-FL--</span> lb: 0x0  cc: 2
col  0: <span class="o">[</span> 2]  c1 02
col  1: <span class="o">[</span> 5]  74 65 73 74 31
tab 0, row 1, @0x1f80
tl: 12 fb: <span class="nt">--H-FL--</span> lb: 0x0  cc: 2
col  0: <span class="o">[</span> 2]  c1 03
col  1: <span class="o">[</span> 5]  74 65 73 74 32
tab 0, row 2, @0x1f74
tl: 12 fb: <span class="nt">--H-FL--</span> lb: 0x2  cc: 2
col  0: <span class="o">[</span> 2]  c1 04
col  1: <span class="o">[</span> 5]  42 42 42 42 42
tab 0, row 3, @0x1f68
tl: 12 fb: <span class="nt">--H-FL--</span> lb: 0x0  cc: 2
col  0: <span class="o">[</span> 2]  c1 05
col  1: <span class="o">[</span> 5]  74 65 73 74 34
end_of_block_dump
End dump data blocks tsn: 6 file#: 5 minblk 150 maxblk 150
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">1519</span><span class="p">,</span><span class="mi">3395</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">dump</span><span class="p">(</span><span class="s1">'CCCCC'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span> <span class="k">from</span> <span class="n">dual</span><span class="p">;</span>

<span class="n">DUMP</span><span class="p">(</span><span class="s1">'CCCCC'</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
<span class="c1">----------------------------</span>
<span class="n">Typ</span><span class="o">=</span><span class="mi">96</span> <span class="n">Len</span><span class="o">=</span><span class="mi">5</span><span class="p">:</span> <span class="mi">43</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">43</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre>BBED&gt; show all
        FILE#           5
        BLOCK#          150
        OFFSET          0
        DBA             0x01400096 <span class="o">(</span>20971670 5,150<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Browse
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           8192
        LOGFILE         log.bbd
        SPOOL           No

BBED&gt; dump
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00002c00 0202c102 05746573 74312c02
 0202c102 07746573 74312d31 2c010202 c10505[43 43434343] 2c020202 c1040542 <span class="c">## 这里也已经可以看见修改之后的数据了/脏块</span>
 42424242 2c000202 c1030574 65737432 2c000202 c1020574 65737431 01061cf8

 &lt;32 bytes per line&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="bbed-修改-itl-1">bbed 修改 Itl</h3>

<p>再次通过 bbed 修改 Itl</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
</pre></td><td class="rouge-code"><pre>
BBED&gt; <span class="nb">set </span>filename <span class="s1">'/oradata/darkdb/data01.dbf'</span>
        FILENAME        /oradata/darkdb/data01.dbf

BBED&gt; <span class="nb">set </span>file 5
        FILE#           5

BBED&gt; <span class="nb">set </span>block 150
        BLOCK#          150
BBED&gt; <span class="nb">set </span>count 300
        COUNT           300

BBED&gt; show all
        FILE#           5
        BLOCK#          150
        OFFSET          0
        DBA             0x01400096 <span class="o">(</span>20971670 5,150<span class="o">)</span>
        FILENAME        /oradata/darkdb/data01.dbf
        BIFILE          bifile.bbd
        LISTFILE        /home/oracle/filelist.bbed
        BLOCKSIZE       8192
        MODE            Browse
        EDIT            Unrecoverable
        IBASE           Dec
        OBASE           Dec
        WIDTH           80
        COUNT           300
        LOGFILE         log.bbd
        SPOOL           No

BBED&gt;

<span class="c">#  Itl           Xid                  Uba         Flag  Lck        Scn/Fsc</span>
<span class="c"># 0x01   0x0003.01a.00000f54  0x00c009cd.00df.1f  C---    0  scn 0x0000.002118a0</span>
<span class="c"># 0x02   0x0007.014.00000bdc  0x00c00f2f.00db.13  --U-    1  fsc 0x0000.0021f1c8 ## 这次 Flag 的标志不是 ----</span>

find /x db0013
BBED&gt; find /x db0013
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   80 to  379           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
<span class="o">[</span>db001300] 0120[0000 c8f12100] 00000000 00000000 00010400 ffff1a00 4e1f4e1f <span class="c">## Uba 和 Scn 的位置，中间部分就是 Flag，这次 Scn 已经比之前的大，所以不需要修改</span>
 4e1f0000 04004e1f 801f741f 681f0000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000

<span class="c">## 查询当前实例的 scn</span>
<span class="k">select </span>dbms_flashback.get_system_change_number from dual<span class="p">;</span>
GET_SYSTEM_CHANGE_NUMBER
<span class="nt">------------------------</span>
2229042

<span class="k">select </span>dump<span class="o">(</span>2229042,16<span class="o">)</span> from dual<span class="p">;</span>
DUMP<span class="o">(</span>2229042,16<span class="o">)</span>
<span class="nt">--------------------------</span>
<span class="nv">Typ</span><span class="o">=</span>2 <span class="nv">Len</span><span class="o">=</span>5: c4,3,17,5b,2b <span class="c">## Itl Scn 信息已经比当前实例的 Scn 小</span>

<span class="c">## 修改 Itl 信息</span>

<span class="nb">set </span>mode edit
modify /x 0800 offset 84
BBED&gt; <span class="nb">set </span>mode edit
        MODE            Edit

BBED&gt; modify /x 0800 offset 84
Warning: contents of previous BIFILE will be lost. Proceed? <span class="o">(</span>Y/N<span class="o">)</span> y
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   84 to  383           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 08000000 c8f12100 00000000 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000
 04004e1f 801f741f 681f0000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000

 &lt;32 bytes per line&gt;

BBED&gt; <span class="nb">set </span>offset 0
        OFFSET          0

BBED&gt; <span class="nb">set </span>block 150
        BLOCK#          150

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to  299           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 1cf82100 00000104 38320000 01000000 32770100 3be82100
 00000000 02003200 90004001 04001300 880c0000 2406c000 00012d00 01000000
 00000000 07001400 dc0b0000 2f0fc000 db001300 <span class="o">[</span>08000000] c8f12100 00000000 <span class="c">## 修改成功</span>
 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000

 &lt;32 bytes per line&gt;

<span class="c">## 校验和</span>

BBED&gt; <span class="nb">sum
</span>Check value <span class="k">for </span>File 5, Block 150:
current <span class="o">=</span> 0x3238, required <span class="o">=</span> 0x1231

BBED&gt; <span class="nb">sum </span>apply
Check value <span class="k">for </span>File 5, Block 150:
current <span class="o">=</span> 0x1231, required <span class="o">=</span> 0x1231

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to  299           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 1cf82100 00000104 31120000 01000000 32770100 3be82100
 00000000 02003200 90004001 04001300 880c0000 2406c000 00012d00 01000000
 00000000 07001400 dc0b0000 2f0fc000 db001300 08000000 c8f12100 00000000
 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000

 &lt;32 bytes per line&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>刷新 buffer cache</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">alter</span> <span class="k">system</span> <span class="n">flush</span> <span class="n">buffer_cache</span><span class="p">;</span>
<span class="k">alter</span> <span class="k">system</span> <span class="k">checkpoint</span><span class="p">;</span>

<span class="o">##</span> <span class="n">session2</span> <span class="err">还是不能查看到修改之后的数据</span>
<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">1519</span><span class="p">,</span><span class="mi">3395</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>

        <span class="n">ID</span> <span class="n">NAME</span>
<span class="c1">---------- --------------------</span>
         <span class="mi">1</span> <span class="n">test1</span>
         <span class="mi">2</span> <span class="n">test2</span>
         <span class="mi">3</span> <span class="n">BBBBB</span>
         <span class="mi">4</span> <span class="n">test4</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">00</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>session1 不提交事务，重启实例</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">session2</span><span class="o">&gt;</span> <span class="n">shutdown</span> <span class="k">immediate</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>重启之后还是无法查看修改之后的数据</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">10</span><span class="p">,</span><span class="mi">8567</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>

        <span class="n">ID</span> <span class="n">NAME</span>
<span class="c1">---------- --------------------</span>
         <span class="mi">1</span> <span class="n">test1</span>
         <span class="mi">2</span> <span class="n">test2</span>
         <span class="mi">3</span> <span class="n">BBBBB</span>
         <span class="mi">4</span> <span class="n">test4</span>

<span class="n">Elapsed</span><span class="p">:</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">.</span><span class="mi">02</span>

<span class="c1">-- 检查 bbed dump 内容对应的 Flag 可以看到也发生了改变</span>
<span class="n">BBED</span><span class="o">&gt;</span> <span class="k">set</span> <span class="n">filename</span> <span class="s1">'/oradata/darkdb/data01.dbf'</span>
        <span class="n">FILENAME</span>        <span class="o">/</span><span class="n">oradata</span><span class="o">/</span><span class="n">darkdb</span><span class="o">/</span><span class="n">data01</span><span class="p">.</span><span class="n">dbf</span>

<span class="n">BBED</span><span class="o">&gt;</span> <span class="k">set</span> <span class="n">file</span> <span class="mi">5</span>
        <span class="n">FILE</span><span class="o">#</span>           <span class="mi">5</span>

<span class="n">BBED</span><span class="o">&gt;</span> <span class="k">set</span> <span class="n">block</span> <span class="mi">150</span>
        <span class="n">BLOCK</span><span class="o">#</span>          <span class="mi">150</span>
<span class="n">BBED</span><span class="o">&gt;</span> <span class="n">dump</span>
 <span class="n">File</span><span class="p">:</span> <span class="o">/</span><span class="n">oradata</span><span class="o">/</span><span class="n">darkdb</span><span class="o">/</span><span class="n">data01</span><span class="p">.</span><span class="n">dbf</span> <span class="p">(</span><span class="mi">5</span><span class="p">)</span>
 <span class="n">Block</span><span class="p">:</span> <span class="mi">150</span>              <span class="n">Offsets</span><span class="p">:</span>    <span class="mi">0</span> <span class="k">to</span>  <span class="mi">511</span>           <span class="n">Dba</span><span class="p">:</span><span class="mi">0</span><span class="n">x01400096</span>
<span class="c1">------------------------------------------------------------------------</span>
 <span class="mi">06</span><span class="n">a20000</span> <span class="mi">96004001</span> <span class="mi">50052200</span> <span class="mi">00000104</span> <span class="mi">46490000</span> <span class="mi">01000000</span> <span class="mi">32770100</span> <span class="mi">0</span><span class="n">f052200</span>
 <span class="mi">00000000</span> <span class="mi">02003200</span> <span class="mi">90004001</span> <span class="mi">03001</span><span class="n">a00</span> <span class="mi">540</span><span class="n">f0000</span> <span class="n">cd09c000</span> <span class="n">df001f00</span> <span class="mi">00800000</span>
 <span class="n">a0182100</span> <span class="mi">07001400</span> <span class="n">dc0b0000</span> <span class="mi">2</span><span class="n">f0fc000</span> <span class="n">db001300</span> <span class="p">[</span><span class="mi">00</span><span class="n">a00000</span><span class="p">]</span> <span class="n">c7012200</span> <span class="mi">00000000</span> <span class="c1">-- 这里 Flag 已经发生了改变</span>
 <span class="mi">00000000</span> <span class="mi">00010400</span> <span class="n">ffff1a00</span> <span class="mi">4</span><span class="n">e1f4e1f</span> <span class="mi">4</span><span class="n">e1f0000</span> <span class="mi">04004</span><span class="n">e1f</span> <span class="mi">801</span><span class="n">f741f</span> <span class="mi">681</span><span class="n">f0000</span>

<span class="c1">-- 查看尾部数据，发现对应的脏块也已经没有了</span>
<span class="k">set</span> <span class="k">count</span> <span class="mi">8192</span>
<span class="n">BBED</span><span class="o">&gt;</span> <span class="n">dump</span> <span class="o">##</span> <span class="err">已经没有</span> <span class="mi">43434343</span>
 <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
 <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00002</span><span class="n">c00</span> <span class="mi">0202</span><span class="n">c102</span> <span class="mi">05746573</span> <span class="mi">74312</span><span class="n">c02</span>
 <span class="mi">0202</span><span class="n">c102</span> <span class="mi">07746573</span> <span class="mi">74312</span><span class="n">d31</span> <span class="mi">2</span><span class="n">c000202</span> <span class="n">c1050574</span> <span class="mi">65737434</span> <span class="mi">2</span><span class="n">c000202</span> <span class="n">c1040542</span>
 <span class="mi">42424242</span> <span class="mi">2</span><span class="n">c000202</span> <span class="n">c1030574</span> <span class="mi">65737432</span> <span class="mi">2</span><span class="n">c000202</span> <span class="n">c1020574</span> <span class="mi">65737431</span> <span class="mi">01065005</span>

 <span class="o">&lt;</span><span class="mi">32</span> <span class="n">bytes</span> <span class="n">per</span> <span class="n">line</span><span class="o">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>看来只能修改 undo 块了，修改几次 block 没有效果</strong></p>

<h2 id="修改-undo-块">修改 undo 块</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="n">ID</span> <span class="o">|</span> <span class="n">NAME</span>
<span class="c1">----------</span>
<span class="mi">1</span>  <span class="o">|</span> <span class="n">test1</span>
<span class="mi">2</span>  <span class="o">|</span> <span class="n">test2</span>
<span class="mi">3</span>  <span class="o">|</span> <span class="n">BBBBB</span>
<span class="mi">4</span>  <span class="o">|</span> <span class="n">test4</span>

<span class="k">update</span> <span class="n">test_undo</span> <span class="k">set</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">'DDDDD'</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

<span class="n">WXJ</span><span class="o">@</span><span class="n">darkdb</span> <span class="mi">2269</span><span class="p">,</span><span class="mi">4450</span> <span class="k">SQL</span><span class="o">&gt;</span> <span class="k">select</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_relative_fno</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">file_id</span><span class="p">,</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_block_number</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">block_id</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>

   <span class="n">FILE_ID</span>   <span class="n">BLOCK_ID</span>         <span class="n">ID</span> <span class="n">NAME</span>
<span class="c1">---------- ---------- ---------- --------------------</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">1</span> <span class="n">test1</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">2</span> <span class="n">test2</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">3</span> <span class="n">BBBBB</span>
         <span class="mi">5</span>        <span class="mi">150</span>          <span class="mi">4</span> <span class="n">DDDDD</span> <span class="o">##</span> <span class="n">session1</span>

<span class="k">select</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_relative_fno</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">file_id</span><span class="p">,</span> <span class="n">dbms_rowid</span><span class="p">.</span><span class="n">rowid_block_number</span><span class="p">(</span><span class="n">rowid</span><span class="p">)</span> <span class="n">block_id</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="n">FILE_ID</span> <span class="o">|</span> <span class="n">BLOCK_ID</span> <span class="o">|</span> <span class="n">ID</span> <span class="o">|</span> <span class="n">NAME</span>
<span class="c1">-------------------------------</span>
<span class="mi">5</span>       <span class="o">|</span> <span class="mi">150</span>      <span class="o">|</span> <span class="mi">1</span>  <span class="o">|</span> <span class="n">test1</span>
<span class="mi">5</span>       <span class="o">|</span> <span class="mi">150</span>      <span class="o">|</span> <span class="mi">2</span>  <span class="o">|</span> <span class="n">test2</span>
<span class="mi">5</span>       <span class="o">|</span> <span class="mi">150</span>      <span class="o">|</span> <span class="mi">3</span>  <span class="o">|</span> <span class="n">BBBBB</span>
<span class="mi">5</span>       <span class="o">|</span> <span class="mi">150</span>      <span class="o">|</span> <span class="mi">4</span>  <span class="o">|</span> <span class="n">test4</span> <span class="o">##</span> <span class="n">session2</span>

<span class="k">alter</span> <span class="k">system</span> <span class="n">dump</span> <span class="n">datafile</span> <span class="mi">5</span> <span class="n">block</span> <span class="mi">150</span><span class="p">;</span>
<span class="k">select</span> <span class="n">tracefile</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">process</span> <span class="k">where</span> <span class="n">addr</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">paddr</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="k">session</span> <span class="k">where</span> <span class="n">sid</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">sid</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">mystat</span><span class="p">));</span>
<span class="o">/</span><span class="n">u01</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">oracle</span><span class="o">/</span><span class="n">diag</span><span class="o">/</span><span class="n">rdbms</span><span class="o">/</span><span class="n">darkdb</span><span class="o">/</span><span class="n">darkdb</span><span class="o">/</span><span class="n">trace</span><span class="o">/</span><span class="n">darkdb_ora_4685</span><span class="p">.</span><span class="n">trc</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
</pre></td><td class="rouge-code"><pre>┌─[oracle@oracle11g]─[~]
└──╼ <span class="nv">$ </span><span class="nb">cat</span> /u01/app/oracle/diag/rdbms/darkdb/darkdb/trace/darkdb_ora_4685.trc
Trace file /u01/app/oracle/diag/rdbms/darkdb/darkdb/trace/darkdb_ora_4685.trc
Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options
ORACLE_HOME <span class="o">=</span> /u01/app/oracle/product/11.2.0/db
System name:    Linux
Node name:      oracle11g
Release:        5.4.17-2102.201.3.el7uek.x86_64
Version:        <span class="c">#2 SMP Fri Apr 23 09:05:55 PDT 2021</span>
Machine:        x86_64
Instance name: darkdb
Redo thread mounted by this instance: 1
Oracle process number: 27
Unix process pid: 4685, image: oracle@oracle11g <span class="o">(</span>TNS V1-V3<span class="o">)</span>


<span class="k">***</span> 2025-03-26 10:30:34.706
<span class="k">***</span> SESSION ID:<span class="o">(</span>2278.39<span class="o">)</span> 2025-03-26 10:30:34.706
<span class="k">***</span> CLIENT ID:<span class="o">()</span> 2025-03-26 10:30:34.706
<span class="k">***</span> SERVICE NAME:<span class="o">(</span>SYS<span class="nv">$USERS</span><span class="o">)</span> 2025-03-26 10:30:34.706
<span class="k">***</span> MODULE NAME:<span class="o">(</span>SQL<span class="k">*</span>Plus<span class="o">)</span> 2025-03-26 10:30:34.706
<span class="k">***</span> ACTION NAME:<span class="o">()</span> 2025-03-26 10:30:34.706

Start dump data blocks tsn: 6 file#:5 minblk 150 maxblk 150
Block dump from cache:
Dump of buffer cache at level 4 <span class="k">for </span><span class="nv">tsn</span><span class="o">=</span>6 <span class="nv">rdba</span><span class="o">=</span>20971670
BH <span class="o">(</span>0x15efdf408<span class="o">)</span> file#: 5 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span> class: 1 ba: 0x15eca6000
  <span class="nb">set</span>: 11 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 80,28
  dbwrid: 0 obj: 96050 objn: 96050 tsn: 6 afn: 5 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x15ef6ea38,0x189ebd620] lru: <span class="o">[</span>0x15efdf630,0x15efdf3c0]
  ckptq: <span class="o">[</span>NULL] fileq: <span class="o">[</span>NULL] objq: <span class="o">[</span>NULL] objaq: <span class="o">[</span>NULL]
  st: CR md: NULL tch: 1
  cr: <span class="o">[</span>scn: 0x0.2223bb],[xid: 0x8.19.c42],[uba: 0xc00740.de.1f],[cls: 0x0.2223bb],[sfl: 0x40],[lc: 0x0.220550]
  flags: only_sequential_access
BH <span class="o">(</span>0x15ef6e980<span class="o">)</span> file#: 5 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span> class: 1 ba: 0x15e118000
  <span class="nb">set</span>: 12 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 84,28
  dbwrid: 0 obj: 96050 objn: 96050 tsn: 6 afn: 5 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x15ef6eb70,0x15efdf4c0] lru: <span class="o">[</span>0x131fb8630,0x15ef6e938]
  obj-flags: object_ckpt_list
  ckptq: <span class="o">[</span>0x15ef6e368,0x187556f48] fileq: <span class="o">[</span>0x187556fe8,0x187556fe8] objq: <span class="o">[</span>0x177eb8db8,0x177eb8db8] objaq: <span class="o">[</span>0x131fb8668,0x177eb8d98]
  st: XCURRENT md: NULL fpin: <span class="s1">'kdswh01: kdstgr'</span> tch: 3
  flags: buffer_dirty redo_since_read
  LRBA: <span class="o">[</span>0x6.84dcd.0] LSCN: <span class="o">[</span>0x0.2223d6] HSCN: <span class="o">[</span>0x0.2223d6] HSUB: <span class="o">[</span>1]
BH <span class="o">(</span>0x15ef6eab8<span class="o">)</span> file#: 5 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span> class: 1 ba: 0x15e11a000
  <span class="nb">set</span>: 12 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 84,28
  dbwrid: 0 obj: 96050 objn: 96050 tsn: 6 afn: 5 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x189ebd620,0x15ef6ea38] lru: <span class="o">[</span>0x15ef71c68,0x15ef7cd20]
  lru-flags: moved_to_tail
  ckptq: <span class="o">[</span>NULL] fileq: <span class="o">[</span>NULL] objq: <span class="o">[</span>NULL] objaq: <span class="o">[</span>NULL]
  st: CR md: NULL fpin: <span class="s1">'kdswh01: kdstgr'</span> tch: 2
  cr: <span class="o">[</span>scn: 0x0.2223b5],[xid: 0xfffe.ffff.0],[uba: 0x0.0.0],[cls: 0x0.2223b5],[sfl: 0x1],[lc: 0x0.220550]
  flags: only_sequential_access
Block dump from disk:
buffer tsn: 6 rdba: 0x01400096 <span class="o">(</span>5/150<span class="o">)</span>
scn: 0x0000.00220550 <span class="nb">seq</span>: 0x01 flg: 0x04 <span class="nb">tail</span>: 0x05500601
frmt: 0x02 chkval: 0x4946 <span class="nb">type</span>: <span class="nv">0x06</span><span class="o">=</span>trans data
Hex dump of block: <span class="nv">st</span><span class="o">=</span>0, <span class="nv">typ_found</span><span class="o">=</span>1
Dump of memory from 0x00007F387EEE3A00 to 0x00007F387EEE5A00
7F387EEE3A00 0000A206 01400096 00220550 04010000  <span class="o">[</span>......@.P.<span class="s2">".....]
7F387EEE3A10 00004946 00000001 00017732 0022050F  [FI......2w...."</span>.]
7F387EEE3A20 00000000 00320002 01400090 001A0003  <span class="o">[</span>......2...@.....]
7F387EEE3A30 00000F54 00C009CD 001F00DF 00008000  <span class="o">[</span>T...............]
7F387EEE3A40 002118A0 00140007 00000BDC 00C00F2F  <span class="o">[</span>..!........./...]
7F387EEE3A50 001300DB 0000A000 002201C7 00000000  <span class="o">[</span>..........<span class="s2">".....]
7F387EEE3A60 00000000 00040100 001AFFFF 1F4E1F4E  [............N.N.]
7F387EEE3A70 00001F4E 1F4E0004 1F741F80 00001F68  [N.....N...t.h...]
7F387EEE3A80 00000000 00000000 00000000 00000000  [................]
        Repeat 498 times
7F387EEE59B0 002C0000 02C10202 73657405 022C3174  [..,......test1,.]
7F387EEE59C0 02C10202 73657407 312D3174 0202002C  [.....test1-1,...]
7F387EEE59D0 740505C1 34747365 0202002C 420504C1  [...test4,......B]
7F387EEE59E0 42424242 0202002C 740503C1 32747365  [BBBB,......test2]
7F387EEE59F0 0202002C 740502C1 31747365 05500601  [,......test1..P.]
Block header dump:  0x01400096
 Object id on Block? Y
 seg/obj: 0x17732  csc: 0x00.22050f  itc: 2  flg: E  typ: 1 - DATA
     brn: 0  bdba: 0x1400090 ver: 0x01 opc: 0
     inc: 0  exflg: 0

 Itl           Xid                  Uba         Flag  Lck        Scn/Fsc
0x01   0x0003.01a.00000f54  0x00c009cd.00df.1f  C---    0  scn 0x0000.002118a0
0x02   0x0007.014.00000bdc  0x00c00f2f.00db.13  C-U-    0  scn 0x0000.002201c7 ## 这里的 Flag 又变成了 C-U- ，什么鬼，但是在 session2 中还是没有看到修改之后的数据，难道这里是因为我使用的 session3 dump trace 的时候触发了自动提交？
bdba: 0x01400096
data_block_dump,data header at 0x7f387eee3a64
===============
tsiz: 0x1f98
hsiz: 0x1a
pbl: 0x7f387eee3a64
     76543210
flag=--------
ntab=1
nrow=4
frre=-1
fsbo=0x1a
fseo=0x1f4e
avsp=0x1f4e
tosp=0x1f4e
0xe:pti[0]      nrow=4  offs=0
0x12:pri[0]     offs=0x1f4e
0x14:pri[1]     offs=0x1f80
0x16:pri[2]     offs=0x1f74
0x18:pri[3]     offs=0x1f68
block_row_dump:
tab 0, row 0, @0x1f4e
tl: 12 fb: --H-FL-- lb: 0x0  cc: 2
col  0: [ 2]  c1 02
col  1: [ 5]  74 65 73 74 31
tab 0, row 1, @0x1f80
tl: 12 fb: --H-FL-- lb: 0x0  cc: 2
col  0: [ 2]  c1 03
col  1: [ 5]  74 65 73 74 32
tab 0, row 2, @0x1f74
tl: 12 fb: --H-FL-- lb: 0x0  cc: 2
col  0: [ 2]  c1 04
col  1: [ 5]  42 42 42 42 42
tab 0, row 3, @0x1f68
tl: 12 fb: --H-FL-- lb: 0x0  cc: 2
col  0: [ 2]  c1 05
col  1: [ 5]  74 65 73 74 34
end_of_block_dump
End dump data blocks tsn: 6 file#: 5 minblk 150 maxblk 150
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>在 dump trace 的时候发现 Flag 和之前的不一样，重新通过 bbed 查看 block 150 ，发现可以查看到 Flag 和修改之后的数据，这又是什么鬼🤣，重新尝试 bbed 修改 block 试试，也有可能是因为这张表已经测试了好几次</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="rouge-code"><pre>
WXJ@darkdb 1521,4443 SQL&gt; <span class="k">select </span>dump<span class="o">(</span><span class="s1">'DDDDD'</span>,16<span class="o">)</span> from dual<span class="p">;</span>

DUMP<span class="o">(</span><span class="s1">'DDDDD'</span>,16<span class="o">)</span>
<span class="nt">----------------------------</span>
<span class="nv">Typ</span><span class="o">=</span>96 <span class="nv">Len</span><span class="o">=</span>5: 44,44,44,44,44

<span class="nb">set </span>filename <span class="s1">'/oradata/darkdb/data01.dbf'</span>
<span class="nb">set </span>file 5
<span class="nb">set </span>block 150
<span class="nb">set </span>count 8192
BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to  511           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 f9252200 00000104 b38a0000 01000000 32770100 f9252200
 00000000 02003200 90004001 08001900 420c0000 4007c000 de001f00 01000000
 00000000 07001400 dc0b0000 2f0fc000 <span class="o">[</span>db001300] 00a00000 c7012200 00000000 <span class="c">## Uba 的位置</span>
 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000

 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00002c00 0202c102 05746573 74312c02
 0202c102 07746573 74312d31 2c010202 c105[05][44 44444444] 2c000202 c1040542 <span class="c">## 05 长度，44 对应的 D 十六进制</span>
 42424242 2c000202 c1030574 65737432 2c000202 c1020574 65737431 0106f925

 &lt;32 bytes per line&gt;

<span class="nb">set </span>offset 0
<span class="nb">set </span>count 200
<span class="nb">set </span>mode edit
find /x db0013
BBED&gt; find /x db0013
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:   80 to  279           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 db001300 00a00000 c7012200 00000000 00000000 00010400 ffff1a00 4e1f4e1f
 4e1f0000 04004e1f 801f741f 681f0000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000

 &lt;32 bytes per line&gt;

modify /x 0800 offset 84
<span class="nb">sum </span>apply
<span class="nb">set </span>block 150
<span class="nb">set </span>offset 0
dump

</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>刷新 buffer cache</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c1">-- 尝试多次 bbed 修改，不管是新的会话还是原有的会话都不能查看到修改之后的数据</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">test_undo</span><span class="p">;</span>
<span class="n">ID</span> <span class="o">|</span> <span class="n">NAME</span>
<span class="c1">----------</span>
<span class="mi">1</span>  <span class="o">|</span> <span class="n">test1</span>
<span class="mi">2</span>  <span class="o">|</span> <span class="n">test2</span>
<span class="mi">3</span>  <span class="o">|</span> <span class="n">BBBBB</span>
<span class="mi">4</span>  <span class="o">|</span> <span class="n">test4</span>

<span class="c1">-- 不管是先 checkpoint 还是 flush buffer cache 都不能查看到修改之后的数据</span>
<span class="k">alter</span> <span class="k">system</span> <span class="k">checkpoint</span><span class="p">;</span> <span class="c1">-- 此时重新 bbed 查看 block 150 可以看到修改的值又被还原了</span>
<span class="k">alter</span> <span class="k">system</span> <span class="n">flush</span> <span class="n">buffer_cache</span><span class="p">;</span> <span class="c1">-- 此时重新 bbed 查看 block 150 发现修改的值被还原，经过测试发现 flush buffer 并不会覆盖 bbed 修改的值，只有 checkpoint 才会。checkpoint 会刷脏，写入磁盘，flush buffer 只是将内存中的数据清理掉</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>继续修改 undo 块</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre>
<span class="c1">-- 0x02   0x0007.014.00000bdc  0x00c00f2f.00db.13  C-U-    0  scn 0x0000.002201c7</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">rollname</span><span class="p">;</span>
<span class="n">USN</span> <span class="o">|</span> <span class="n">NAME</span>
<span class="c1">---------------------------</span>
<span class="mi">0</span>   <span class="o">|</span> <span class="k">SYSTEM</span>
<span class="mi">1</span>   <span class="o">|</span> <span class="n">_SYSSMU1_3724004606</span><span class="err">$</span>
<span class="mi">2</span>   <span class="o">|</span> <span class="n">_SYSSMU2_2996391332</span><span class="err">$</span>
<span class="mi">3</span>   <span class="o">|</span> <span class="n">_SYSSMU3_1723003836</span><span class="err">$</span>
<span class="mi">4</span>   <span class="o">|</span> <span class="n">_SYSSMU4_1254879796</span><span class="err">$</span>
<span class="mi">5</span>   <span class="o">|</span> <span class="n">_SYSSMU5_898567397</span><span class="err">$</span>
<span class="mi">6</span>   <span class="o">|</span> <span class="n">_SYSSMU6_1263032392</span><span class="err">$</span>
<span class="mi">7</span>   <span class="o">|</span> <span class="n">_SYSSMU7_2070203016</span><span class="err">$</span>  <span class="c1">-- 0x0007 对应的 undo segment 编号</span>
<span class="mi">8</span>   <span class="o">|</span> <span class="n">_SYSSMU8_517538920</span><span class="err">$</span>
<span class="mi">9</span>   <span class="o">|</span> <span class="n">_SYSSMU9_1650507775</span><span class="err">$</span>
<span class="mi">10</span>  <span class="o">|</span> <span class="n">_SYSSMU10_1197734989</span><span class="err">$</span>

<span class="k">select</span> <span class="n">header_file</span><span class="p">,</span> <span class="n">header_block</span><span class="p">,</span> <span class="n">blocks</span>  <span class="k">from</span> <span class="n">dba_segments</span> <span class="k">where</span> <span class="n">segment_name</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="n">name</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">rollname</span> <span class="k">where</span> <span class="n">usn</span> <span class="o">=</span> <span class="mi">7</span><span class="p">);</span>
<span class="n">HEADER_FILE</span> <span class="o">|</span> <span class="n">HEADER_BLOCK</span> <span class="o">|</span> <span class="n">BLOCKS</span>
<span class="c1">-----------------------------------</span>
<span class="mi">3</span>           <span class="o">|</span> <span class="mi">224</span>          <span class="o">|</span> <span class="mi">400</span>

<span class="k">select</span> <span class="n">extent_id</span><span class="p">,</span> <span class="n">file_id</span><span class="p">,</span> <span class="n">block_id</span><span class="p">,</span> <span class="n">blocks</span> <span class="k">from</span> <span class="n">dba_extents</span> <span class="k">where</span> <span class="n">segment_name</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="n">name</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">rollname</span> <span class="k">where</span> <span class="n">usn</span> <span class="o">=</span> <span class="mi">7</span><span class="p">);</span>
<span class="n">EXTENT_ID</span> <span class="o">|</span> <span class="n">FILE_ID</span> <span class="o">|</span> <span class="n">BLOCK_ID</span> <span class="o">|</span> <span class="n">BLOCKS</span>
<span class="c1">---------------------------------------</span>
<span class="mi">0</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">224</span>      <span class="o">|</span> <span class="mi">8</span>
<span class="mi">1</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">232</span>      <span class="o">|</span> <span class="mi">8</span>
<span class="mi">2</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">3328</span>     <span class="o">|</span> <span class="mi">128</span>
<span class="mi">3</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">512</span>      <span class="o">|</span> <span class="mi">128</span>
<span class="mi">4</span>         <span class="o">|</span> <span class="mi">3</span>       <span class="o">|</span> <span class="mi">3840</span>     <span class="o">|</span> <span class="mi">128</span>

<span class="c1">-- dump trace undo segment</span>
<span class="k">alter</span> <span class="k">system</span> <span class="n">dump</span> <span class="n">datafile</span> <span class="mi">3</span> <span class="n">block</span> <span class="mi">224</span><span class="p">;</span>
<span class="k">select</span> <span class="n">tracefile</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">process</span> <span class="k">where</span> <span class="n">addr</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">paddr</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="k">session</span> <span class="k">where</span> <span class="n">sid</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">sid</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="n">mystat</span><span class="p">));</span>
<span class="o">/</span><span class="n">u01</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">oracle</span><span class="o">/</span><span class="n">diag</span><span class="o">/</span><span class="n">rdbms</span><span class="o">/</span><span class="n">darkdb</span><span class="o">/</span><span class="n">darkdb</span><span class="o">/</span><span class="n">trace</span><span class="o">/</span><span class="n">darkdb_ora_4443</span><span class="p">.</span><span class="n">trc</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
</pre></td><td class="rouge-code"><pre>┌─[oracle@oracle11g]─[~]
└──╼ <span class="nv">$ </span><span class="nb">cat</span> /u01/app/oracle/diag/rdbms/darkdb/darkdb/trace/darkdb_ora_4443.trc
Trace file /u01/app/oracle/diag/rdbms/darkdb/darkdb/trace/darkdb_ora_4443.trc
Oracle Database 11g Enterprise Edition Release 11.2.0.4.0 - 64bit Production
With the Partitioning, OLAP, Data Mining and Real Application Testing options
ORACLE_HOME <span class="o">=</span> /u01/app/oracle/product/11.2.0/db
System name:    Linux
Node name:      oracle11g
Release:        5.4.17-2102.201.3.el7uek.x86_64
Version:        <span class="c">#2 SMP Fri Apr 23 09:05:55 PDT 2021</span>
Machine:        x86_64
Instance name: darkdb
Redo thread mounted by this instance: 1
Oracle process number: 26
Unix process pid: 4443, image: oracle@oracle11g <span class="o">(</span>TNS V1-V3<span class="o">)</span>


<span class="k">***</span> 2025-03-26 15:41:06.810
<span class="k">***</span> SESSION ID:<span class="o">(</span>1521.11<span class="o">)</span> 2025-03-26 15:41:06.810
<span class="k">***</span> CLIENT ID:<span class="o">()</span> 2025-03-26 15:41:06.810
<span class="k">***</span> SERVICE NAME:<span class="o">(</span>SYS<span class="nv">$USERS</span><span class="o">)</span> 2025-03-26 15:41:06.810
<span class="k">***</span> MODULE NAME:<span class="o">(</span>SQL<span class="k">*</span>Plus<span class="o">)</span> 2025-03-26 15:41:06.810
<span class="k">***</span> ACTION NAME:<span class="o">()</span> 2025-03-26 15:41:06.810

Start dump data blocks tsn: 2 file#:3 minblk 224 maxblk 224
Block dump from cache:
Dump of buffer cache at level 4 <span class="k">for </span><span class="nv">tsn</span><span class="o">=</span>2 <span class="nv">rdba</span><span class="o">=</span>12583136
BH <span class="o">(</span>0x15dfcb248<span class="o">)</span> file#: 3 rdba: 0x00c000e0 <span class="o">(</span>3/224<span class="o">)</span> class: 29 ba: 0x15da96000
  <span class="nb">set</span>: 9 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 208,28
  dbwrid: 0 obj: <span class="nt">-1</span> objn: 0 tsn: 2 afn: 3 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x15ef81608,0x1898c4020] lru: <span class="o">[</span>0x15efa2730,0x15dfbc6c8]
  obj-flags: object_ckpt_list
  ckptq: <span class="o">[</span>0x157f6f6e8,0x15bf85240] fileq: <span class="o">[</span>0x187344440,0x15bf7ac90] objq: <span class="o">[</span>0x15bf7ad98,0x15bf7a2a0] objaq: <span class="o">[</span>0x15efa2768,0x15dfbc700]
  st: XCURRENT md: NULL fpin: <span class="s1">'ktuwh41: ktucloUsMinScn'</span> tch: 92
  flags: buffer_dirty block_written_once redo_since_read
  LRBA: <span class="o">[</span>0x6.8f8a7.0] LSCN: <span class="o">[</span>0x0.225916] HSCN: <span class="o">[</span>0x0.22592d] HSUB: <span class="o">[</span>1]
BH <span class="o">(</span>0x15ef81550<span class="o">)</span> file#: 3 rdba: 0x00c000e0 <span class="o">(</span>3/224<span class="o">)</span> class: 29 ba: 0x15e304000
  <span class="nb">set</span>: 12 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 204,28
  dbwrid: 0 obj: <span class="nt">-1</span> objn: 0 tsn: 2 afn: 3 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x15efa3e20,0x15dfcb300] lru: <span class="o">[</span>0x15dfa67c8,0x15ef6a9d8]
  lru-flags: on_auxiliary_list
  ckptq: <span class="o">[</span>NULL] fileq: <span class="o">[</span>NULL] objq: <span class="o">[</span>NULL] objaq: <span class="o">[</span>NULL]
  st: FREE md: NULL fpin: <span class="s1">'ktuwh05: ktugct'</span> tch: 0 lfb: 33
  flags:
BH <span class="o">(</span>0x15efa3d68<span class="o">)</span> file#: 3 rdba: 0x00c000e0 <span class="o">(</span>3/224<span class="o">)</span> class: 29 ba: 0x15e68e000
  <span class="nb">set</span>: 9 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 208,28
  dbwrid: 0 obj: <span class="nt">-1</span> objn: 0 tsn: 2 afn: 3 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x131fd2458,0x15ef81608] lru: <span class="o">[</span>0x15dfcfec8,0x15dfbc590]
  lru-flags: on_auxiliary_list
  ckptq: <span class="o">[</span>NULL] fileq: <span class="o">[</span>NULL] objq: <span class="o">[</span>NULL] objaq: <span class="o">[</span>NULL]
  st: FREE md: NULL fpin: <span class="s1">'ktuwh41: ktucloUsMinScn'</span> tch: 0 lfb: 33
  flags:
BH <span class="o">(</span>0x131fd23a0<span class="o">)</span> file#: 3 rdba: 0x00c000e0 <span class="o">(</span>3/224<span class="o">)</span> class: 29 ba: 0x131b50000
  <span class="nb">set</span>: 12 pool: 3 bsz: 8192 bsi: 0 sflg: 2 pwc: 204,28
  dbwrid: 0 obj: <span class="nt">-1</span> objn: 0 tsn: 2 afn: 3 hint: f
  <span class="nb">hash</span>: <span class="o">[</span>0x1898c4020,0x15efa3e20] lru: <span class="o">[</span>0x15df8f410,0x131fd25c8]
  lru-flags: on_auxiliary_list
  ckptq: <span class="o">[</span>NULL] fileq: <span class="o">[</span>NULL] objq: <span class="o">[</span>NULL] objaq: <span class="o">[</span>NULL]
  st: FREE md: NULL fpin: <span class="s1">'ktuwh72: ktugus:ktuswr1'</span> tch: 0 lfb: 33
  flags:
Block dump from disk:
buffer tsn: 2 rdba: 0x00c000e0 <span class="o">(</span>3/224<span class="o">)</span>
scn: 0x0000.0022410b <span class="nb">seq</span>: 0x01 flg: 0x04 <span class="nb">tail</span>: 0x410b2601
frmt: 0x02 chkval: 0x0de8 <span class="nb">type</span>: <span class="nv">0x26</span><span class="o">=</span>KTU SMU HEADER BLOCK
Hex dump of block: <span class="nv">st</span><span class="o">=</span>0, <span class="nv">typ_found</span><span class="o">=</span>1
Dump of memory from 0x00007F190A795A00 to 0x00007F190A797A00
7F190A795A00 0000A226 00C000E0 0022410B 04010000  <span class="o">[</span>&amp;........A<span class="s2">".....]
7F190A795A10 00000DE8 00000000 00000000 00000000  [................]
7F190A795A20 00000000 00000005 0000018F 00000FF0  [................]
7F190A795A30 00000002 0000002B 00000080 00C00D2B  [....+.......+...]
7F190A795A40 00000000 00000002 00000000 00000000  [................]
7F190A795A50 00000000 00000000 00000000 00000005  [................]
7F190A795A60 00000000 00000000 40000000 00C000E1  [...........@....]
7F190A795A70 00000007 00C000E8 00000008 00C00D00  [................]
7F190A795A80 00000080 00C00200 00000080 00C00F00  [................]
7F190A795A90 00000080 00000000 00000000 00000000  [................]
7F190A795AA0 00000000 00000000 00000000 00000000  [................]
        Repeat 245 times
7F190A796A00 00000000 67E37BC2 67E37BC2 67E37BC2  [.....{.g.{.g.{.g]
7F190A796A10 67E36777 67E37BC2 67CAE719 67CAE719  [wg.g.{.g...g...g]
7F190A796A20 67CAE719 67CAE719 67CAE719 67CAE719  [...g...g...g...g]
        Repeat 20 times
7F190A796B70 67CAE719 67321E8F 67321E8F 67321E8F  [...g..2g..2g..2g]
7F190A796B80 67321E8F 67321E8F 67321E8F 67321E8F  [..2g..2g..2g..2g]
7F190A796B90 67321E8F 67321E8F 67321E8F 00000000  [..2g..2g..2g....]
7F190A796BA0 00000000 00000000 00000000 00000000  [................]
        Repeat 98 times
7F190A7971D0 002234E0 00000000 00C00D2A 001700E2  [.4"</span>.....<span class="k">*</span>.......]
7F190A7971E0 00E20001 00000002 00000000 00040005  <span class="o">[</span>................]
7F190A7971F0 0001B000 00000068 7FFFFFFE 00C00D2A  <span class="o">[</span>....h.......<span class="k">*</span>...]
7F190A797200 001700E2 13E40002 00C00D2B 002800E2  <span class="o">[</span>........+.....<span class="o">(</span>.]
7F190A797210 0D3A0002 00000000 000700E2 098C0002  <span class="o">[</span>..:.............]
7F190A797220 00000000 000100DB 1F840002 00000000  <span class="o">[</span>................]
7F190A797230 00000000 00000000 00000C23 00C00D2A  <span class="o">[</span>........#...<span class="k">*</span>...]
7F190A797240 00224105 00000000 00040009 00000000  <span class="o">[</span>.A<span class="s2">".............]
7F190A797250 00000000 00000000 00000001 67E3AAAC  [...............g]
7F190A797260 00000B9B 00C00D24 00223967 00000000  [....</span><span class="nv">$.</span><span class="s2">..g9"</span>.....]
7F190A797270 00100009 00000000 00000000 00000000  <span class="o">[</span>................]
7F190A797280 00000002 67E39806 00000C2B 00C00D20  <span class="o">[</span>.......g+... ...]
7F190A797290 00223A1B 00000000 000E0009 00000000  <span class="o">[</span>.:<span class="s2">".............]
7F190A7972A0 00000000 00000000 00000001 67E39931  [............1..g]
7F190A7972B0 00000C31 00C00D2A 00223F17 00000000  [1...*....?"</span>.....]
7F190A7972C0 00120009 00000000 00000000 00000000  <span class="o">[</span>................]
7F190A7972D0 00000003 67E3A5FC 00000C30 00C00D2A  <span class="o">[</span>.......g0...<span class="k">*</span>...]
7F190A7972E0 0022410B 00000000 FFFF0009 00000000  <span class="o">[</span>.A<span class="s2">".............]
7F190A7972F0 00000000 00000000 00000001 67E3AAAC  [...............g]
7F190A797300 00000BCA 00C00D23 002234F0 00000000  [....#....4"</span>.....]
7F190A797310 001A0009 00000000 00000000 00000000  <span class="o">[</span>................]
7F190A797320 00000001 67E38C50 00000BF0 00C00D2A  <span class="o">[</span>....P..g....<span class="k">*</span>...]
7F190A797330 00223F95 00000000 00170009 00000000  <span class="o">[</span>.?<span class="s2">".............]
7F190A797340 00000000 00000000 00000001 67E3A728  [............(..g]
7F190A797350 00000C31 00C00D20 00223EE3 00000000  [1... ....&gt;"</span>.....]
7F190A797360 00200009 00000000 00000000 00000000  <span class="o">[</span>.. .............]
7F190A797370 00000001 67E3A5FB 00000BF3 00C00D2A  <span class="o">[</span>.......g....<span class="k">*</span>...]
7F190A797380 002240EB 00000000 001C0009 00000000  <span class="o">[</span>.@<span class="s2">".............]
7F190A797390 00000000 00000000 00000001 67E3AAAC  [...............g]
7F190A7973A0 00000C2F 00C00D21 0022369E 00000000  [/...!....6"</span>.....]
7F190A7973B0 000B0009 00000000 00000000 00000000  <span class="o">[</span>................]
7F190A7973C0 00000001 67E39100 00000BF0 00C00D2A  <span class="o">[</span>.......g....<span class="k">*</span>...]
7F190A7973D0 002240E3 00000000 00080009 00000000  <span class="o">[</span>.@<span class="s2">".............]
7F190A7973E0 00000000 00000000 00000001 67E3AAAC  [...............g]
7F190A7973F0 00000C0A 00C00D21 0022381E 00000000  [....!....8"</span>.....]
7F190A797400 000C0009 00000000 00000000 00000000  <span class="o">[</span>................]
7F190A797410 00000001 67E3953C 00000C11 00C00D23  <span class="o">[</span>....&lt;..g....#...]
7F190A797420 002238BF 00000000 00210009 00000000  <span class="o">[</span>.8<span class="s2">".......!.....]
7F190A797430 00000000 00000000 00000001 67E396DC  [...............g]
7F190A797440 00000C30 00C00D28 00223F16 00000000  [0...(....?"</span>.....]
7F190A797450 00030009 00000000 00000000 00000000  <span class="o">[</span>................]
7F190A797460 00000003 67E3A5FC 00000B92 00C00D20  <span class="o">[</span>.......g.... ...]
7F190A797470 00223A27 00000000 001F0009 00000000  <span class="o">[</span><span class="s1">':".............]
7F190A797480 00000000 00000000 00000001 67E39931  [............1..g]
7F190A797490 00000C1F 00C00D20 00223CFC 00000000  [.... ....&lt;".....]
7F190A7974A0 00070009 00000000 00000000 00000000  [................]
7F190A7974B0 00000001 67E3A112 00000BD8 00C00D24  [.......g....$...]
7F190A7974C0 00223975 00000000 00160009 00000000  [u9".............]
7F190A7974D0 00000000 00000000 00000001 67E39806  [...............g]
7F190A7974E0 00000BAE 00C00D23 002235C0 00000000  [....#....5".....]
7F190A7974F0 00090009 00000000 00000000 00000000  [................]
7F190A797500 00000001 67E38EA8 00000C2C 00C00D2B  [.......g,...+...]
7F190A797510 00223F18 00000000 001E0009 00000000  [.?".............]
7F190A797520 00000000 00000000 00000003 67E3A5FC  [...............g]
7F190A797530 00000C0D 00C00D20 00223A18 00000000  [.... ....:".....]
7F190A797540 00020009 00000000 00000000 00000000  [................]
7F190A797550 00000001 67E39931 00000BEC 00C00D24  [....1..g....$...]
7F190A797560 002239FB 00000000 001B0009 00000000  [.9".............]
7F190A797570 00000000 00000000 00000001 67E39931  [............1..g]
7F190A797580 00000B93 00C00D20 00223C23 00000000  [.... ...#&lt;".....]
7F190A797590 000F0009 00000000 00000000 00000000  [................]
7F190A7975A0 00000001 67E39EB6 00000C30 00C00D24  [.......g0...$...]
7F190A7975B0 002239E8 00000000 00140009 00000000  [.9".............]
7F190A7975C0 00000000 00000000 00000001 67E39931  [............1..g]
7F190A7975D0 00000C2F 00C00D2A 00223FF2 00000000  [/...*....?".....]
7F190A7975E0 001D0009 00000000 00000000 00000000  [................]
7F190A7975F0 00000001 67E3A81E 00000BB3 00C00D26  [.......g....&amp;...]
7F190A797600 00223F15 00000000 000D0009 00000000  [.?".............]
7F190A797610 00000000 00000000 00000001 67E3A5FC  [...............g]
7F190A797620 00000B90 00C00D2A 002240FF 00000000  [....*....@".....]
7F190A797630 00000009 00000000 00000000 00000000  [................]
7F190A797640 00000001 67E3AAAC 00000BA6 00C00D21  [.......g....!...]
7F190A797650 002235BF 00000000 00110009 00000000  [.5".............]
7F190A797660 00000000 00000000 00000001 67E38EA8  [...............g]
7F190A797670 00000BCC 00C00D24 00223A09 00000000  [....$....:".....]
7F190A797680 00130009 00000000 00000000 00000000  [................]
7F190A797690 00000001 67E39931 00000C30 00C00D2A  [....1..g0...*...]
7F190A7976A0 002240F3 00000000 00190009 00000000  [.@".............]
7F190A7976B0 00000000 00000000 00000001 67E3AAAC  [...............g]
7F190A7976C0 00000B8F 00C00D2A 002240D8 00000000  [....*....@".....]
7F190A7976D0 000A0009 00000000 00000000 00000000  [................]
7F190A7976E0 00000001 67E3AAAC 00000C2F 00C00D2A  [.......g/...*...]
7F190A7976F0 00223F26 00000000 00060009 00000000  [&amp;?".............]
7F190A797700 00000000 00000000 00000001 67E3A5FC  [...............g]
7F190A797710 00000B99 00C00D20 00223BD2 00000000  [.... ....;".....]
7F190A797720 00150009 00000000 00000000 00000000  [................]
7F190A797730 00000001 67E39DE1 00000C13 00C00D20  [.......g.... ...]
7F190A797740 00223EFB 00000000 00180009 00000000  [.&gt;".............]
7F190A797750 00000000 00000000 00000001 67E3A5FB  [...............g]
7F190A797760 00000C0F 00C00D23 0022392C 00000000  [....#...,9".....]
7F190A797770 00010009 00000000 00000000 00000000  [................]
7F190A797780 00000001 67E39805 00000007 00000000  [.......g........]
7F190A797790 00000000 00000000 00000000 00000000  [................]
        Repeat 36 times
7F190A7979E0 00000000 00000100 00C70040 00400000  [........@.....@.]
7F190A7979F0 010000C7 02C10280 2911C203 410B2601  [...........).&amp;.A]
  Extent Control Header
  -----------------------------------------------------------------
  Extent Header:: spare1: 0      spare2: 0      #extents: 5      #blocks: 399
                  last map  0x00000000  #maps: 0      offset: 4080
      Highwater::  0x00c00d2b  ext#: 2      blk#: 43     ext size: 128
  #blocks in seg. hdr'</span>s freelists: 0
  <span class="c">#blocks below: 0</span>
  mapblk  0x00000000  offset: 2
                   Unlocked
     Map Header:: next  0x00000000  <span class="c">#extents: 5    obj#: 0      flag: 0x40000000</span>
  Extent Map
  <span class="nt">-----------------------------------------------------------------</span>
   0x00c000e1  length: 7
   0x00c000e8  length: 8
   0x00c00d00  length: 128
   0x00c00200  length: 128
   0x00c00f00  length: 128

 Retention Table
  <span class="nt">-----------------------------------------------------------</span>
 Extent Number:0  Commit Time: 1742961602
 Extent Number:1  Commit Time: 1742961602
 Extent Number:2  Commit Time: 1742961602
 Extent Number:3  Commit Time: 1742956407
 Extent Number:4  Commit Time: 1742961602

  TRN CTL:: <span class="nb">seq</span>: 0x00e2 chd: 0x0005 ctl: 0x0004 inc: 0x00000000 nfb: 0x0002
            mgc: 0xb000 xts: 0x0068 flg: 0x0001 opt: 2147483646 <span class="o">(</span>0x7ffffffe<span class="o">)</span>
            uba: 0x00c00d2a.00e2.17 scn: 0x0000.002234e0
Version: 0x01
  FREE BLOCK POOL::
    uba: 0x00c00d2a.00e2.17 ext: 0x2  spc: 0x13e4
    uba: 0x00c00d2b.00e2.28 ext: 0x2  spc: 0xd3a
    uba: 0x00000000.00e2.07 ext: 0x2  spc: 0x98c
    uba: 0x00000000.00db.01 ext: 0x2  spc: 0x1f84
    uba: 0x00000000.0000.00 ext: 0x0  spc: 0x0
  TRN TBL:: <span class="c">## 事务表</span>

  index  state cflags  wrap#    uel         scn            dba            parent-xid    nub     stmt_num    cmt（cmt 的值不能为 0 ）
        <span class="c">## 9 对应的是提交标志              ##（对于未提交的事务，表示事务开始时的 scn，需要修改为提交时的 scn）</span>
  <span class="nt">------------------------------------------------------------------------------------------------</span>
   0x00    9    0x00  0x0c23  0x0004  0x0000.00224105  0x00c00d2a  0x0000.000.00000000  0x00000001   0x00000000  1742973612
   0x01    9    0x00  0x0b9b  0x0010  0x0000.00223967  0x00c00d24  0x0000.000.00000000  0x00000002   0x00000000  1742968838
   0x02    9    0x00  0x0c2b  0x000e  0x0000.00223a1b  0x00c00d20  0x0000.000.00000000  0x00000001   0x00000000  1742969137
   0x03    9    0x00  0x0c31  0x0012  0x0000.00223f17  0x00c00d2a  0x0000.000.00000000  0x00000003   0x00000000  1742972412
   0x04    9    0x00  0x0c30  0xffff  0x0000.0022410b  0x00c00d2a  0x0000.000.00000000  0x00000001   0x00000000  1742973612
   0x05    9    0x00  0x0bca  0x001a  0x0000.002234f0  0x00c00d23  0x0000.000.00000000  0x00000001   0x00000000  1742965840
   0x06    9    0x00  0x0bf0  0x0017  0x0000.00223f95  0x00c00d2a  0x0000.000.00000000  0x00000001   0x00000000  1742972712
   0x07    9    0x00  0x0c31  0x0020  0x0000.00223ee3  0x00c00d20  0x0000.000.00000000  0x00000001   0x00000000  1742972411
   0x08    9    0x00  0x0bf3  0x001c  0x0000.002240eb  0x00c00d2a  0x0000.000.00000000  0x00000001   0x00000000  1742973612
   0x09    9    0x00  0x0c2f  0x000b  0x0000.0022369e  0x00c00d21  0x0000.000.00000000  0x00000001   0x00000000  1742967040
   0x0a    9    0x00  0x0bf0  0x0008  0x0000.002240e3  0x00c00d2a  0x0000.000.00000000  0x00000001   0x00000000  1742973612
   0x0b    9    0x00  0x0c0a  0x000c  0x0000.0022381e  0x00c00d21  0x0000.000.00000000  0x00000001   0x00000000  1742968124
   0x0c    9    0x00  0x0c11  0x0021  0x0000.002238bf  0x00c00d23  0x0000.000.00000000  0x00000001   0x00000000  1742968540
   0x0d    9    0x00  0x0c30  0x0003  0x0000.00223f16  0x00c00d28  0x0000.000.00000000  0x00000003   0x00000000  1742972412
   0x0e    9    0x00  0x0b92  0x001f  0x0000.00223a27  0x00c00d20  0x0000.000.00000000  0x00000001   0x00000000  1742969137
   0x0f    9    0x00  0x0c1f  0x0007  0x0000.00223cfc  0x00c00d20  0x0000.000.00000000  0x00000001   0x00000000  1742971154
   0x10    9    0x00  0x0bd8  0x0016  0x0000.00223975  0x00c00d24  0x0000.000.00000000  0x00000001   0x00000000  1742968838
   0x11    9    0x00  0x0bae  0x0009  0x0000.002235c0  0x00c00d23  0x0000.000.00000000  0x00000001   0x00000000  1742966440
   0x12    9    0x00  0x0c2c  0x001e  0x0000.00223f18  0x00c00d2b  0x0000.000.00000000  0x00000003   0x00000000  1742972412
   0x13    9    0x00  0x0c0d  0x0002  0x0000.00223a18  0x00c00d20  0x0000.000.00000000  0x00000001   0x00000000  1742969137
   0x14    9    0x00  0x0bec  0x001b  0x0000.002239fb  0x00c00d24  0x0000.000.00000000  0x00000001   0x00000000  1742969137 <span class="c">## Itl 对应的 xid 中的事务表槽号</span>
   0x15    9    0x00  0x0b93  0x000f  0x0000.00223c23  0x00c00d20  0x0000.000.00000000  0x00000001   0x00000000  1742970550
   0x16    9    0x00  0x0c30  0x0014  0x0000.002239e8  0x00c00d24  0x0000.000.00000000  0x00000001   0x00000000  1742969137
   0x17    9    0x00  0x0c2f  0x001d  0x0000.00223ff2  0x00c00d2a  0x0000.000.00000000  0x00000001   0x00000000  1742972958
   0x18    9    0x00  0x0bb3  0x000d  0x0000.00223f15  0x00c00d26  0x0000.000.00000000  0x00000001   0x00000000  1742972412
   0x19    9    0x00  0x0b90  0x0000  0x0000.002240ff  0x00c00d2a  0x0000.000.00000000  0x00000001   0x00000000  1742973612
   0x1a    9    0x00  0x0ba6  0x0011  0x0000.002235bf  0x00c00d21  0x0000.000.00000000  0x00000001   0x00000000  1742966440
   0x1b    9    0x00  0x0bcc  0x0013  0x0000.00223a09  0x00c00d24  0x0000.000.00000000  0x00000001   0x00000000  1742969137
   0x1c    9    0x00  0x0c30  0x0019  0x0000.002240f3  0x00c00d2a  0x0000.000.00000000  0x00000001   0x00000000  1742973612
   0x1d    9    0x00  0x0b8f  0x000a  0x0000.002240d8  0x00c00d2a  0x0000.000.00000000  0x00000001   0x00000000  1742973612
   0x1e    9    0x00  0x0c2f  0x0006  0x0000.00223f26  0x00c00d2a  0x0000.000.00000000  0x00000001   0x00000000  1742972412
   0x1f    9    0x00  0x0b99  0x0015  0x0000.00223bd2  0x00c00d20  0x0000.000.00000000  0x00000001   0x00000000  1742970337
   0x20    9    0x00  0x0c13  0x0018  0x0000.00223efb  0x00c00d20  0x0000.000.00000000  0x00000001   0x00000000  1742972411
   0x21    9    0x00  0x0c0f  0x0001  0x0000.0022392c  0x00c00d23  0x0000.000.00000000  0x00000001   0x00000000  1742968837 <span class="c">## 这里的 0x21 表示事务表中最多可以存放的事务数量，可以理解为这个回滚段活动事务（没有提交的事务）最多同时存在的数量，十进制就是 33</span>
  EXT TRN CTL::
  usn: 7
  sp1:0x00000000 sp2:0x00000000 sp3:0x00000000 sp4:0x00000000
  sp5:0x00000000 sp6:0x7f1900000000 sp7:0x00000000 sp8:0x00000000
  EXT TRN TBL::
  index  extflag    extHash    extSpare1   extSpare2
  <span class="nt">---------------------------------------------------</span>
   0x00  0x00000000 0x00000000 0x00000000  0x00000000
   0x01  0x00000000 0x00000000 0x00000000  0x00000000
   0x02  0x00000000 0x00000000 0x00000000  0x00000000
   0x03  0x00000000 0x00000000 0x00000000  0x00000000
   0x04  0x00000000 0x00000000 0x00000000  0x00000000
   0x05  0x00000000 0x00000000 0x00000000  0x00000000
   0x06  0x00000000 0x00000000 0x00000000  0x00000000
   0x07  0x00000000 0x00000000 0x00000000  0x00000000
   0x08  0x00000000 0x00000000 0x00000000  0x00000000
   0x09  0x00000000 0x00000000 0x00000000  0x00000000
   0x0a  0x00000000 0x00000000 0x00000000  0x00000000
   0x0b  0x00000000 0x00000000 0x00000000  0x00000000
   0x0c  0x00000000 0x00000000 0x00000000  0x00000000
   0x0d  0x00000000 0x00000000 0x00000000  0x00000000
   0x0e  0x00000000 0x00000000 0x00000000  0x00000000
   0x0f  0x00000000 0x00000000 0x00000000  0x00000000
   0x10  0x00000000 0x00000000 0x00000000  0x00000000
   0x11  0x00000000 0x00000000 0x00000000  0x00000000
   0x12  0x00000000 0x00000000 0x00000000  0x00000000
   0x13  0x00000000 0x00000000 0x00000000  0x00000000
   0x14  0x00000000 0x00000000 0x00000000  0x00000000
   0x15  0x00000000 0x00000000 0x00000000  0x00000000
   0x16  0x00000000 0x00000000 0x00000000  0x00000000
   0x17  0x00000000 0x00000000 0x00000000  0x00000000
   0x18  0x00000000 0x00000000 0x00000000  0x00000000
   0x19  0x00000000 0x00000000 0x00000000  0x00000000
   0x1a  0x00000000 0x00000000 0x00000000  0x00000000
   0x1b  0x00000000 0x00000000 0x00000000  0x00000000
   0x1c  0x00000000 0x00000000 0x00000000  0x00000000
   0x1d  0x00000000 0x00000000 0x00000000  0x00000000
   0x1e  0x00000000 0x00000000 0x00000000  0x00000000
   0x1f  0x00000000 0x00000000 0x00000000  0x00000000
   0x20  0x00000000 0x00000000 0x00000000  0x00000000
   0x21  0x00000000 0x00000000 0x00000000  0x00000000
End dump data blocks tsn: 2 file#: 3 minblk 224 maxblk 224
</pre></td></tr></tbody></table></code></pre></div></div>

<p>bbed 修改 undo block</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="nb">set </span>filename <span class="s1">'/oradata/darkdb/undotbs01.dbf'</span>
<span class="nb">set </span>file 3
<span class="nb">set </span>block 224
<span class="nb">set </span>count 8192

BBED&gt; find /x bf3922
BBED-00212: search string not found


BBED&gt; find /x 183a22
BBED-00212: search string not found


BBED&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这里还是无法正常寻找到对应的信息，可能是 block 被多次修改，尝试重新创建表测试，先停止数据库然后尝试修改 block 试试</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">SQL</span><span class="o">&gt;</span> <span class="n">shutdown</span> <span class="k">immediate</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre></td><td class="rouge-code"><pre>
<span class="nb">set </span>filename <span class="s1">'/oradata/darkdb/data01.dbf'</span>
<span class="nb">set </span>file 5
<span class="nb">set </span>block 150
<span class="nb">set </span>count 8192
dump
<span class="nt">---</span>
BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to 8191           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 84812200 00000104 fb100000 01000000 32770100 84812200
 00000000 02003200 90004001 08001900 420c0000 4007c000 de001f00 01000000
 00000000 07001400 dc0b0000 2f0fc000 db001300 <span class="o">[</span>00a00000] <span class="o">[</span>f23f2200] 00000000 <span class="c">## 这里对比上文的信息，发现此处 scn 的信息发生了变化，难道是因为之前没有修改 scn 导致无法通过 bbed 修改事务状态，这里停库之后，又发现 scn 不同，先尝试不修改 scn 启动实例测试看看</span>
 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00002c00 0202c102 05746573 74312c02
 0202c102 07746573 74312d31 2c010202 c10505[44 44444444] 2c000202 c1040542 <span class="c">## 这里可以看到 block 中已经存在修改之后的数据</span>
 42424242 2c000202 c1030574 65737432 2c000202 c1020574 65737431 01068481

 &lt;32 bytes per line&gt;

<span class="c">## 按照上文的步骤重新修改 block</span>

<span class="nb">set </span>count 200
<span class="nb">set </span>mode edit
modify /x 0800 offset 84
<span class="nb">sum </span>apply
<span class="nb">set </span>block 150
<span class="nb">set </span>offset 0
dump
<span class="c">## 此时启动实例</span>
SQL&gt; startup
WXJ@darkdb 2269,2970 SQL&gt;
WXJ@darkdb 2269,2970 SQL&gt; <span class="k">select</span> <span class="k">*</span> from test_undo<span class="p">;</span>

        ID NAME
<span class="nt">----------</span> <span class="nt">--------------------</span>
         1 test1
         2 test2
         3 BBBBB
         4 test4 <span class="c">## 发现还是没有变化</span>

BBED&gt; dump
 File: /oradata/darkdb/data01.dbf <span class="o">(</span>5<span class="o">)</span>
 Block: 150              Offsets:    0 to  199           Dba:0x01400096
<span class="nt">------------------------------------------------------------------------</span>
 06a20000 96004001 ac8b2200 00000104 f0530000 01000000 32770100 84812200
 00000000 02003200 90004001 03001a00 540f0000 cd09c000 df001f00 00800000
 a0182100 07001400 dc0b0000 2f0fc000 db001300 <span class="o">[</span>08000000] f23f2200 00000000 <span class="c">## 这里的值没有发生变化</span>
 00000000 00010400 ffff1a00 4e1f4e1f 4e1f0000 04004e1f 801f741f 681f0000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000
 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000
 00000000 00000000 00000000 00000000 00002c00 0202c102 05746573 74312c02
 0202c102 07746573 74312d31 2c000202 c10505[74 65737434] 2c000202 c1040542 <span class="c">## 这里的数据发生了变化，应该是从 redo</span>
 42424242 2c000202 c1030574 65737432 2c000202 c1020574 65737431 0106ac8b

 &lt;32 bytes per line&gt;

<span class="c">## 从启动日志中可以看到通过 redo 恢复了 377 data blocks</span>
Successful mount of redo thread 1, with mount <span class="nb">id </span>833686687
Database mounted <span class="k">in </span>Exclusive Mode
Lost write protection disabled
Completed: ALTER DATABASE   MOUNT
Thu Mar 27 06:20:19 2025
ALTER DATABASE OPEN
Beginning crash recovery of 1 threads
 parallel recovery started with 3 processes
Started redo scan
Completed redo scan
 <span class="nb">read </span>1098 KB redo, 377 data blocks need recovery
Started redo application at
 Thread 1: logseq 6, block 640193
Recovery of Online Redo Log: Thread 1 Group 6 Seq 6 Reading mem 0
  Mem# 0: /oradata/darkdb/redo06.log
Completed redo application of 0.97MB
Completed crash recovery at
 Thread 1: logseq 6, block 642389, scn 2283996
 377 data blocks <span class="nb">read</span>, 377 data blocks written, 1098 redo k-bytes <span class="nb">read
</span>LGWR: STARTING ARCH PROCESSES
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="总结">总结</h2>

<p>虽然本次实验没有成功修改 undo block ，但是观察了 block 的变化和修改，下次直接创建一张新的测试表测试，这次实验因为中间跨度较大，可能细节存在问题</p>
